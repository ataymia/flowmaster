<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Flowmaster</title>
<style>
  /* --- Flowmaster owns its look; neutral/dark and not the Allstar pink --- */
  :root{
    --bg:#0b0f14; --panel:#111823; --card:#0f1622; --ink:#e5edf5;
    --muted:#9aa7b7; --line:#1c2636; --accent:#3478f6; --accent-2:#3dd68c;
    --warn:#f59e0b; --danger:#ef4444;
  }
  *{box-sizing:border-box} html,body{height:100%;margin:0}
  body{background:var(--bg);color:var(--ink);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  a{color:#9ec1ff;text-decoration:none}
  .wrap{max-width:1280px;margin:0 auto;padding:16px}
  .bar{position:sticky;top:0;z-index:20;background:rgba(11,15,20,.85);backdrop-filter:blur(6px);border-bottom:1px solid var(--line)}
  .bar-in{display:flex;align-items:center;gap:10px;padding:12px 16px}
  .brand{font-weight:800;letter-spacing:.3px}
  .tab{padding:8px 10px;border-radius:10px;border:1px solid var(--line);color:var(--ink)}
  .tab:hover{background:#111827}
  .pill{padding:6px 10px;border-radius:999px;background:var(--panel);border:1px solid var(--line);color:var(--muted)}
  .btn{display:inline-flex;align-items:center;justify-content:center;padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#0e141e;color:var(--ink);cursor:pointer}
  .btn:hover{background:#111b2a}
  .btn-ac{border-color:transparent;background:var(--accent);color:#fff}
  .btn-ok{border-color:transparent;background:var(--accent-2);color:#062012}
  .btn-warn{background:var(--warn);border-color:transparent;color:#221600}
  .btn-danger{background:var(--danger);border-color:transparent}
  .grid{display:grid;gap:16px} .grid-2{grid-template-columns:320px 1fr}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
  .section-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .field{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#0c1320;color:var(--ink)}
  .sel{appearance:none;background:#0c1320 url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="10"><path d="M1 1l7 7 7-7" stroke="%239aa7b7" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>') no-repeat right 10px center;background-size:12px}
  .row{display:flex;gap:8px;align-items:center}
  .muted{color:var(--muted)} .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .list{display:grid;gap:8px} .li{padding:8px;border:1px solid var(--line);border-radius:10px;background:#0c1422}
  .kbd{border:1px solid var(--line);border-bottom-width:3px;border-radius:6px;padding:1px 6px;background:#0b1120;color:#9ec1ff}
  textarea.field{resize:vertical;min-height:120px}
  .split{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .small{font-size:12px}
  .tick{width:8px;height:8px;border-radius:999px;display:inline-block;margin-right:6px}
  .tick.on{background:var(--accent-2)}
  .tick.off{background:#374151}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:6px 8px;border-top:1px solid var(--line);text-align:left}
  .hint{border-left:3px solid #203049;padding:8px;background:#0b1220;border-radius:6px;color:#a8b6c9}
</style>
</head>
<body>
  <div class="bar">
    <div class="bar-in">
      <span class="brand">Flowmaster</span>
      <a class="tab" href="/hub">Hub</a>
      <a class="tab" href="/adherence/">Schedule</a>
      <span id="meta" class="pill" style="margin-left:auto">Checking…</span>
    </div>
  </div>

  <div class="wrap">
    <div class="grid grid-2">
      <!-- LEFT: queue / scripts / dispositions -->
      <div class="panel" id="left">
        <div class="section-title">
          <strong>Queue</strong>
          <div class="row small muted">
            <span id="qsize">0</span>&nbsp;in queue
          </div>
        </div>
        <div class="list" id="queue"></div>

        <div class="section-title" style="margin-top:14px">
          <strong>Script</strong>
          <div class="row small"><span class="muted">copy</span>
            <button class="btn" id="copyScript">Copy</button></div>
        </div>
        <select id="scriptSel" class="field sel">
          <option value="default">General Outreach</option>
          <option value="reminder">Appointment Reminder</option>
          <option value="followup">Follow-up</option>
        </select>
        <textarea id="scriptBody" class="field mono" style="margin-top:8px"></textarea>

        <div class="section-title" style="margin-top:14px">
          <strong>Disposition</strong>
          <span class="small muted">S to save</span>
        </div>
        <div class="row">
          <select id="disp" class="field sel">
            <option value="">— pick —</option>
            <option>Contacted · Completed</option>
            <option>Contacted · Reschedule</option>
            <option>No Answer · VM left</option>
            <option>Wrong Number</option>
            <option>Do Not Call</option>
          </select>
          <button class="btn-ok" id="saveDisp">Save</button>
        </div>
      </div>

      <!-- RIGHT: active contact / timer / tools -->
      <div class="panel" id="right">
        <div class="section-title">
          <strong>Active Contact</strong>
          <div class="row small muted">
            <span class="tick off" id="timerLed"></span>
            <span id="timer">00:00</span>
            <button class="btn" id="start">Start</button>
            <button class="btn" id="pause">Pause</button>
            <button class="btn" id="reset">Reset</button>
          </div>
        </div>

        <div class="split">
          <div>
            <div class="label small muted">Name</div>
            <input id="cName" class="field"/>
          </div>
          <div>
            <div class="label small muted">Phone</div>
            <input id="cPhone" class="field mono"/>
          </div>
        </div>
        <div style="margin-top:8px">
          <div class="label small muted">Notes <span class="muted small">(autosaves · N to focus)</span></div>
          <textarea id="notes" class="field mono" placeholder="Call outcomes, promises, blockers…"></textarea>
        </div>

        <div class="section-title" style="margin-top:14px">
          <strong>Tools</strong>
          <span class="small muted">calculator · quick links</span>
        </div>
        <div class="split">
          <div class="card">
            <div class="row">
              <input id="calcIn" class="field mono" placeholder="1+2*3/4"/>
              <button class="btn" id="calcBtn">=</button>
            </div>
            <div id="calcOut" class="mono small muted" style="margin-top:6px">—</div>
          </div>
          <div class="card">
            <div class="row">
              <input id="quickUrl" class="field" placeholder="https://app.example.com/ticket/123"/>
              <button class="btn" id="goUrl">Go</button>
              <button class="btn" id="copyUrl">Copy</button>
            </div>
            <div class="hint small" style="margin-top:6px">
              Shortcuts:
              <span class="kbd">N</span> notes ·
              <span class="kbd">S</span> copy script ·
              <span class="kbd">T</span> start/pause timer
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <table class="table small">
            <thead><tr><th>Field</th><th>Value</th></tr></thead>
            <tbody id="contactView"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
/* isolate Flowmaster to avoid leaking globals on the site */
(() => {
  const qs = s=>document.querySelector(s), el=(t,a,...c)=>{const n=document.createElement(t);if(a)Object.entries(a).forEach(([k,v])=>k==='class'?n.className=v:k==='style'?Object.assign(n.style,v):k.startsWith('on')?n.addEventListener(k.slice(2),v):n.setAttribute(k,v));c.flat().forEach(x=>n.append(x?.nodeType?x:document.createTextNode(x??'')));return n;}
  const store = (k,v)=> v===undefined ? JSON.parse(localStorage.getItem(k)||'null') : localStorage.setItem(k,JSON.stringify(v));
  const compact = s=>String(s||'').trim();

  // ---- auth gate ----
  async function whoami(){
    const r = await fetch('/api/whoami',{credentials:'include'});
    if(!r.ok) throw new Error('unauth');
    return r.json();
  }

  // ---- scripts ----
  const SCRIPTS = {
    default: `Hi, this is {{agent}} with Allstar. I’m calling for {{name}} regarding your schedule. Do you have a minute?
\n[If yes] Great! Let’s confirm your shift for {{date}} at {{time}}.\n[If no] No worries—what time should I call back?`,
    reminder: `Friendly reminder: your shift is {{date}} at {{time}}. Please arrive 10 minutes early. Need help? Reply here.`,
    followup: `Checking in from Allstar—how did your shift go today? Any issues we should know about?`
  };

  // ---- timer ----
  let tick=null, secs=0, running=false;
  const setTimer = v => { secs=v; qs('#timer').textContent = new Date(secs*1000).toISOString().slice(14,19); };
  const led = on => { const d=qs('#timerLed'); d.classList.remove('on','off'); d.classList.add(on?'on':'off'); };

  function startTimer(){ if(running) return; running=true; led(true); tick=setInterval(()=>setTimer(secs+1),1000); }
  function pauseTimer(){ if(!running) return; running=false; led(false); clearInterval(tick); }
  function resetTimer(){ pauseTimer(); setTimer(0); }

  // ---- queue demo (local) ----
  function demoQueue(me){
    const key = `fm.queue.${me.username}`;
    let q = store(key);
    if(!Array.isArray(q) || !q.length){
      q = [
        {id:'A-1023', name:'Jordan Cole', phone:'(555) 201-8842'},
        {id:'A-1024', name:'Sam Rivera', phone:'(555) 201-8853'},
        {id:'A-1025', name:'Terry Chen', phone:'(555) 201-8864'},
      ];
      store(key,q);
    }
    const host=qs('#queue'); host.innerHTML='';
    q.forEach((row,i)=>{
      host.append(el('div',{class:'li row',style:{justifyContent:'space-between'}},
        el('div',{}, el('div',{}, row.name), el('div',{class:'small muted mono'}, row.phone)),
        el('div',{},
          el('button',{class:'btn',onclick:()=>pick(i)},'Load'),
          ' ',
          el('button',{class:'btn',onclick:()=>done(i)},'Done'))));
    });
    qs('#qsize').textContent=q.length;

    function pick(i){
      const c=q[i];
      qs('#cName').value=c.name;
      qs('#cPhone').value=c.phone;
      renderKV();
      // load a script with tokens:
      applyScript();
      // reset timer
      resetTimer();
    }
    function done(i){
      q.splice(i,1); store(key,q); demoQueue(me);
    }
  }

  // ---- scripts handling ----
  function applyScript(){
    const sel = qs('#scriptSel').value;
    const body = SCRIPTS[sel] || SCRIPTS.default;
    const tokens = {
      agent: (window.__me?.username)||'Agent',
      name: qs('#cName').value||'there',
      date: new Date().toLocaleDateString(),
      time: new Date().toLocaleTimeString()
    };
    const out = body.replace(/\{\{(\w+)\}\}/g,(_,k)=> tokens[k]||'');
    qs('#scriptBody').value = out;
  }

  // ---- disposition save (local) ----
  function saveDisp(){
    const d = compact(qs('#disp').value);
    if(!d) return alert('Pick a disposition');
    const key = `fm.disp.${window.__me.username}`;
    const list = store(key)||[];
    list.unshift({at:Date.now(), c:qs('#cName').value, p:qs('#cPhone').value, d});
    store(key,list.slice(0,200));
    alert('Saved');
  }

  // ---- contact details view ----
  function renderKV(){
    const t=qs('#contactView'); t.innerHTML='';
    const add=(k,v)=> t.append(el('tr',{}, el('td',{class:'muted small'},k), el('td',{}, v||'—')));
    add('Name',qs('#cName').value);
    add('Phone',qs('#cPhone').value);
    add('Notes',qs('#notes').value?.slice(0,120)+'…');
    const lastDisp=(store(`fm.disp.${window.__me.username}`)||[])[0];
    if(lastDisp) add('Last Disposition', `${new Date(lastDisp.at).toLocaleString()} — ${lastDisp.d}`);
  }

  // ---- tools ----
  function calcEval(){
    const s = qs('#calcIn').value;
    try{
      // safe-ish evaluator for + - * / () and decimals
      if(!/^[\d\.\+\-\*\/\(\)\s]+$/.test(s)) throw 0;
      // eslint-disable-next-line no-new-func
      const v = Function(`"use strict";return (${s})`)();
      qs('#calcOut').textContent = String(v);
    }catch{ qs('#calcOut').textContent = 'error'; }
  }
  function goUrl(){ const u=compact(qs('#quickUrl').value); if(u) window.open(u,'_blank'); }
  async function copy(txt){
    try{ await navigator.clipboard.writeText(txt); }catch{}
  }

  // ---- note autosave ----
  function bindNotes(me){
    const key = `fm.notes.${me.username}`;
    const n = store(key)||'';
    qs('#notes').value = n;
    qs('#notes').addEventListener('input',()=>{
      store(key, qs('#notes').value);
      renderKV();
    });
  }

  // ---- boot ----
  (async function init(){
    try{
      const me = await whoami();
      window.__me = me;
      qs('#meta').textContent = `${me.username} · ${me.role}`;
    }catch{
      location.href='/hub';
      return;
    }

    // timer
    qs('#start').onclick=()=> running?pauseTimer():startTimer();
    qs('#pause').onclick=pauseTimer;
    qs('#reset').onclick=resetTimer;

    // scripts
    qs('#scriptSel').onchange=applyScript;
    qs('#copyScript').onclick=()=>copy(qs('#scriptBody').value);

    // disp
    qs('#saveDisp').onclick=saveDisp;

    // contact events
    qs('#cName').oninput=renderKV;
    qs('#cPhone').oninput=renderKV;

    // tools
    qs('#calcBtn').onclick=calcEval;
    qs('#goUrl').onclick=goUrl;
    qs('#copyUrl').onclick=()=>copy(qs('#quickUrl').value);

    // keyboard
    document.addEventListener('keydown',e=>{
      if(e.key==='n' || e.key==='N'){ e.preventDefault(); qs('#notes').focus(); }
      if(e.key==='s' || e.key==='S'){ if(document.activeElement.tagName!=='INPUT' && document.activeElement.tagName!=='TEXTAREA'){ e.preventDefault(); copy(qs('#scriptBody').value); } }
      if(e.key==='t' || e.key==='T'){ e.preventDefault(); running?pauseTimer():startTimer(); }
    });

    // init data
    bindNotes(window.__me);
    demoQueue(window.__me);
    applyScript();
    renderKV();
  })();
})();
</script>
</body>
</html>
