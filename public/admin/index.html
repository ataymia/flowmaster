<!doctype html>  
<html lang="en">
<head> 
  <meta charset="utf-8" />
  <title>Allstar Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --brand:#e11d48; --brand-ink:#fff;
      --bg:#ffffff; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
      --chip:#f8fafc; --chip-ink:#0f172a; --shadow:0 10px 25px rgba(17,24,39,.08);
      --radius:18px;
      --good:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    .page{min-height:100vh;display:flex;flex-direction:column}
    .header{position:sticky;top:0;z-index:10;backdrop-filter:blur(6px);background:rgba(255,255,255,.9);border-bottom:1px solid var(--line)}
    .header-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 20px}
    .hl{display:flex;align-items:center;gap:10px}
    .logoimg{height:28px;width:auto;border-radius:8px}
    .brand{font-weight:900;letter-spacing:.3px;color:var(--brand);font-size:18px}
    .pill{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;background:#fee2e2;color:#b91c1c;font-size:12px;border:1px solid #fecaca}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer;color:inherit;text-decoration:none;box-shadow:var(--shadow)}
    .btn:hover{background:#fafafa}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-danger{border-color:#fecaca;color:#b91c1c;background:#fff}
    .btn-danger:hover{background:#fff5f5}
    .btn-brand{background:var(--brand);border-color:transparent;color:#fff}
    .btn-small{padding:6px 8px;border-radius:10px}
    .main{max-width:1200px;margin:0 auto;padding:20px;flex:1;width:100%;padding-bottom:84px}
    .tabs{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px}
    .tab{padding:8px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;cursor:pointer}
    .tab.active{background:var(--brand);color:#fff;border-color:transparent}
    .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .card h2{margin:0 0 8px 0}
    .muted{color:var(--muted)}
    .footer{padding:16px 20px;color:var(--muted);border-top:1px solid var(--line);text-align:center;font-size:12px;margin-top:20px}
    .errbar{position:fixed;left:20px;right:20px;bottom:16px;z-index:60;background:#fef2f2;color:#991b1b;border:1px solid #fecaca;border-radius:12px;padding:10px 12px;box-shadow:var(--shadow);display:none}
    .hidden{display:none!important}
    .row{display:flex;align-items:center;gap:10px}
    input,select,textarea{border:1px solid var(--line);border-radius:10px;padding:8px 10px;font:inherit}
    .tr{display:grid;gap:10px;align-items:center;background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px}
    .th{font-weight:700;color:#334155}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;background:#f8fafc}
    .tag.admin{background:#eef2ff;color:#3730a3;border-color:#e0e7ff}
    .menu{position:relative}
    .menu-btn{border:1px solid var(--line);border-radius:10px;padding:6px 10px;background:#fff;cursor:pointer}
    .menu-pop{position:absolute;right:0;top:36px;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);min-width:190px;display:none;overflow:hidden;z-index:20}
    .menu.open .menu-pop{display:block}
    .menu-item{padding:10px 12px;cursor:pointer}
    .menu-item:hover{background:#f8fafc}
    .panel{position:fixed;top:0;right:0;bottom:0;width:420px;max-width:100%;background:#fff;border-left:1px solid var(--line);box-shadow:var(--shadow);transform:translateX(100%);transition:transform .2s ease;z-index:40;display:flex;flex-direction:column}
    .panel.open{transform:translateX(0)}
    .panel-hd{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
    .panel-bd{padding:16px;flex:1;overflow:auto}
    .panel-ft{padding:16px;border-top:1px solid var(--line);display:flex;justify-content:flex-end;gap:8px}
    .label{display:block;margin:8px 0 4px 0;font-size:12px;color:#334155}
    .switch{display:inline-flex;align-items:center;gap:8px}
    .switch input{width:18px;height:18px}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:50}
    .modal.open{display:flex}
    .modal-card{width:min(900px,95vw);max-height:85vh;overflow:auto;background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);padding:14px}
    pre{white-space:pre-wrap;background:#f8fafc;border:1px solid var(--line);padding:10px;border-radius:10px;font-size:12px;max-height:300px;overflow:auto}
    .hint{font-size:12px;color:#64748b}
    .row-between{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .subtabs{display:flex;gap:6px;margin:12px 0}
    .subtab{padding:6px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer;font-size:13px}
    .subtab.active{background:#f1f5f9}
    .grid{display:grid;gap:12px}
    @media (min-width:1000px){ .grid-2{grid-template-columns:1.8fr 1.2fr} }
    .blk{display:flex;gap:6px;align-items:center;border:1px solid var(--line);padding:8px;border-radius:10px}
    .tbl{width:100%;border-collapse:collapse}
    .tbl th,.tbl td{border-bottom:1px solid #f1f5f9;padding:8px;text-align:left;font-size:13px}
    .pill-ui{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#f8fafc;font-size:12px}
    .drop{border:2px dashed #e5e7eb;border-radius:12px;padding:16px;text-align:center}
    .ok{color:#166534;background:#dcfce7;border-color:#bbf7d0}
    .warn{color:#92400e;background:#fef3c7;border-color:#fde68a}
    .bad{color:#991b1b;background:#fee2e2;border-color:#fecaca}
    .cards{display:grid;grid-template-columns:repeat(3, minmax(0,1fr)); gap:12px}
    .kpi{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff;box-shadow:var(--shadow)}
    .kpi .big{font-weight:800;font-size:22px}
    .kpi .sub{color:#64748b;font-size:12px}
    .spark{width:100%;height:36px;display:block}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border:1px solid var(--line);border-radius:999px;background:#fff}
    .table-wrap{overflow:auto;border:1px solid var(--line);border-radius:14px;margin-bottom:4px}
    .clicky{cursor:pointer}
    .pill-green{background:#dcfce7;color:#166534;border-color:#bbf7d0}
    .pill-amber{background:#fef3c7;color:#92400e;border-color:#fde68a}
    .pill-red{background:#fee2e2;color:#991b1b;border-color:#fecaca}
    .barwrap{margin-top:10px}
    .barrow{display:flex;align-items:center;gap:10px;margin-top:8px}
    .barlabel{width:110px;font-size:12px;color:#334155;text-align:right}
    .bar{position:relative;height:28px;border:1px solid var(--line);border-radius:8px;background:#f8fafc;flex:1;overflow:hidden}
    .legend{margin-top:8px}
    .loading{opacity:.6;pointer-events:none}
  </style>
</head>
<body>
  <div id="errbar" class="errbar"></div>

  <div class="page">
    <div class="header">
      <div class="header-inner">
        <div class="hl">
          <img class="logoimg" src="/allstar-logo.png" alt="Allstar" onerror="this.style.display='none'">
          <div class="brand">Allstar Admin</div>
          <span class="pill">Admin only</span>
        </div>
        <div class="hl">
          <span id="me" class="muted"></span>
          <button class="btn" id="diag-btn">Diagnose API</button>
          <a class="btn" href="/hub.html">Back to Hub</a>
          <a class="btn btn-danger" href="/api/logout">Sign out</a>
        </div>
      </div>
    </div>

    <main class="main">
      <nav class="tabs">
        <button class="tab active" data-tab="users">Users</button>
        <button class="tab" data-tab="live">Live Board</button>
        <button class="tab" data-tab="schedules">Schedules</button>
        <button class="tab" data-tab="history">History</button>
        <button class="tab" data-tab="news">News</button>
      </nav>

      <section class="card" id="tab-users">
        <div class="row" style="justify-content:space-between">
          <div>
            <h2 style="margin:0">Users</h2>
            <div id="u-endpoint" class="hint"></div>
          </div>
          <div class="row">
            <input id="u-search" placeholder="Search users…" />
            <button class="btn" id="u-refresh">Refresh</button>
            <button class="btn btn-brand" id="u-new">New User</button>
          </div>
        </div>
        <div style="height:10px"></div>
        <div id="u-empty" class="muted" style="display:none">No users found.</div>
        <div id="u-list"></div>
      </section>

      <section class="card hidden" id="tab-live">
        <div class="row" style="justify-content:space-between">
          <div>
            <h2 style="margin:0">Live Board</h2>
            <div class="hint">Shows last status + online heartbeat (last 90s).</div>
          </div>
          <div class="row">
            <input id="lb-search" placeholder="Search…" />
            <select id="lb-sort" title="Sort by">
              <option value="username">Username</option>
              <option value="status">Status</option>
              <option value="online">Online first</option>
              <option value="last_seen">Last seen</option>
            </select>
            <button class="btn" id="lb-refresh">Refresh</button>
          </div>
        </div>
        <div style="height:8px"></div>
        <div id="lb-empty" class="muted" style="display:none">No agents found.</div>
        <div id="lb-list"></div>
      </section>

      <section class="card hidden" id="tab-schedules">
        <div class="row-between">
          <h2 style="margin:0">Schedules</h2>
          <div class="hint">Reads/writes via <code>/api/schedules</code></div>
        </div>

        <div class="subtabs">
          <button class="subtab active" data-sub="edit">Edit</button>
          <button class="subtab" data-sub="dup">Duplicate</button>
          <button class="subtab" data-sub="import">Import CSV</button>
        </div>

        <div id="sch-edit">
          <div class="grid grid-2">
            <div>
              <div class="row" style="flex-wrap:wrap">
                <select id="se-user"></select>
                <input id="se-date" type="date" />
                <button class="btn" id="se-load">Load</button>
                <button class="btn btn-brand" id="se-save">Save</button>
              </div>
              <div class="hint">Statuses: available, break, lunch, bathroom, training, meeting, offline</div>
              <div id="se-list" style="margin-top:10px"></div>
              <div style="display:flex;justify-content:flex-end;margin-top:8px;gap:8px">
                <button class="btn btn-small" id="se-add">+ Block</button>
                <button class="btn btn-small" id="se-clear">Clear</button>
              </div>
            </div>

            <div>
              <div class="pill-ui">Preview</div>
              <table class="tbl" id="se-preview">
                <thead><tr><th>Status</th><th>Start</th><th>End</th></tr></thead>
                <tbody></tbody>
              </table>
              <div id="se-warnings" class="hint"></div>
            </div>
          </div>
        </div>

        <div id="sch-dup" class="hidden">
          <div class="grid grid-2">
            <div>
              <h3 style="margin:0 0 8px 0">Source</h3>
              <div class="row" style="flex-wrap:wrap">
                <select id="sd-src-user"></select>
                <input id="sd-src-date" type="date" />
                <button class="btn" id="sd-preview">Preview</button>
              </div>
              <div id="sd-src-list" class="hint"></div>

              <div style="height:12px"></div>
              <h3 style="margin:0 0 8px 0">Targets</h3>
              <div class="row" style="flex-wrap:wrap">
                <select id="sd-dst-users" multiple size="6" style="min-width:220px"></select>
                <div style="display:flex;flex-direction:column;gap:8px">
                  <label>From <input id="sd-from" type="date" /></label>
                  <label>To <input id="sd-to" type="date" /></label>
                  <label>Weekdays
                    <div class="row">
                      <label><input type="checkbox" class="sd-wd" value="0" checked />Sun</label>
                      <label><input type="checkbox" class="sd-wd" value="1" checked />Mon</label>
                      <label><input type="checkbox" class="sd-wd" value="2" checked />Tue</label>
                      <label><input type="checkbox" class="sd-wd" value="3" checked />Wed</label>
                      <label><input type="checkbox" class="sd-wd" value="4" checked />Thu</label>
                      <label><input type="checkbox" class="sd-wd" value="5" />Fri</label>
                      <label><input type="checkbox" class="sd-wd" value="6" />Sat</label>
                    </div>
                  </label>
                  <label><input id="sd-overwrite" type="checkbox" /> Overwrite existing days</label>
                </div>
              </div>
              <div class="row" style="margin-top:8px">
                <button class="btn btn-brand" id="sd-commit">Duplicate</button>
              </div>
            </div>

            <div>
              <div class="pill-ui">Plan</div>
              <div id="sd-plan" class="hint">Preview a source day to build a plan.</div>
              <table class="tbl" id="sd-preview-table" style="margin-top:8px, display:none">
                <thead><tr><th>Status</th><th>Start</th><th>End</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="sch-import" class="hidden">
          <div class="grid">
            <div class="drop" id="imp-drop">
              <div><strong>Drag & drop CSV here</strong> or <label class="btn"><input id="imp-file" type="file" accept=".csv,text/csv" style="display:none" />Choose file</label></div>
              <div class="hint" style="margin-top:6px">
                Supported formats:
                <ul>
                  <li><code>username,date,status,start,end</code> (tall)</li>
                  <li><code>username,date,blocks</code> where blocks like <em>available@08:00-10:00; break@10:00-10:15</em></li>
                </ul>
              </div>
            </div>
            <div id="imp-summary" class="hint"></div>
            <table class="tbl" id="imp-table" style="display:none">
              <thead><tr><th>User</th><th>Date</th><th>Blocks</th><th>Notes</th></tr></thead>
              <tbody></tbody>
            </table>
            <div class="row" style="justify-content:flex-end">
              <button class="btn btn-brand" id="imp-commit" disabled>Commit</button>
            </div>
          </div>
        </div>
      </section>

      <section class="card hidden" id="tab-history">
        <div class="row-between">
          <h2 style="margin:0">Adherence History</h2>
          <div class="row">
            <button id="hx-exp-adh" class="btn btn-small">Export Adherence</button>
            <button id="hx-exp-sch" class="btn btn-small">Export Schedules</button>
            <button id="hx-exp-ev" class="btn btn-small">Export Events</button>
          </div>
        </div>

        <div class="row" style="flex-wrap:wrap; margin-top:10px">
          <label>Users
            <select id="hx-users" multiple size="4" style="min-width:220px;display:block;margin-top:4px"></select>
          </label>
          <label>From
            <input id="hx-from" type="date" style="display:block;margin-top:4px"/>
          </label>
          <label>To
            <input id="hx-to" type="date" style="display:block;margin-top:4px"/>
          </label>
          <button class="btn btn-brand" id="hx-refresh">Load</button>
        </div>

        <div class="cards" style="margin-top:12px">
          <div class="kpi">
            <div class="sub">Total Points</div>
            <div class="big" id="hx-kpi-total">—</div>
            <canvas class="spark" id="hx-spark-total"></canvas>
          </div>
          <div class="kpi">
            <div class="sub">Average Score</div>
            <div class="big" id="hx-kpi-avg">—</div>
            <canvas class="spark" id="hx-spark-avg"></canvas>
          </div>
          <div class="kpi">
            <div class="sub">Days Covered</div>
            <div class="big" id="hx-kpi-days">—</div>
            <canvas class="spark" id="hx-spark-days"></canvas>
          </div>
        </div>

        <div class="table-wrap" style="margin-top:12px">
          <table class="tbl" id="hx-table">
            <thead id="hx-th"></thead>
            <tbody id="hx-tb"></tbody>
          </table>
        </div>
        <div class="hint" id="hx-hint" style="margin-top:8px">Tip: click a score to open the day breakdown.</div>
      </section>

      <section class="card hidden" id="tab-news"><h2>News</h2><div class="muted">Coming soon…</div></section>
    </main>

    <div class="footer">© Allstar — Admin Tools</div>
  </div>

  <div id="panel" class="panel" aria-hidden="true">
    <div class="panel-hd">
      <div id="p-title" style="font-weight:700">User</div>
      <button class="btn" id="p-close">Close</button>
    </div>
    <div class="panel-bd">
      <label class="label">Username</label>
      <input id="p-username" disabled />

      <label class="label">Role</label>
      <select id="p-role">
        <option value="AGENT">AGENT</option>
        <option value="ADMIN">ADMIN</option>
        <option value="SUPERADMIN">SUPERADMIN</option>
      </select>

      <div style="height:8px"></div>
      <label class="switch">
        <input id="p-force" type="checkbox" />
        <span>Must change password on next login</span>
      </label>

      <div style="height:14px"></div>
      <div class="row">
        <button class="btn" id="p-reset">Reset Password</button>
        <div id="p-reset-msg" class="muted" style="font-size:12px"></div>
      </div>
    </div>
    <div class="panel-ft">
      <button class="btn btn-danger" id="p-delete">Delete</button>
      <button class="btn btn-brand" id="p-save">Save</button>
    </div>
  </div>

  <div id="new-modal" class="panel" aria-hidden="true" style="width:460px">
    <div class="panel-hd">
      <div style="font-weight:700">Create User</div>
      <button class="btn" id="n-close">Close</button>
    </div>
    <div class="panel-bd">
      <label class="label">Username (or email)</label>
      <input id="n-username" placeholder="jane.doe" />

      <label class="label">Role</label>
      <select id="n-role">
        <option value="AGENT">AGENT</option>
        <option value="ADMIN">ADMIN</option>
      </select>

      <label class="label">Temp password (optional)</label>
      <input id="n-temp" type="text" placeholder="leave blank to auto-generate" />
    </div>
    <div class="panel-ft">
      <button class="btn btn-brand" id="n-create">Create</button>
    </div>
  </div>

  <div id="hx-day" class="panel" aria-hidden="true" style="width:520px">
    <div class="panel-hd">
      <div id="hx-day-title" style="font-weight:700">Day</div>
      <button class="btn" id="hx-day-close">Close</button>
    </div>
    <div class="panel-bd">
      <div class="hint" id="hx-day-meta"></div>

      <div class="barwrap" id="hx-block-preview">
        <div class="pill-ui">Day timeline (08:00–18:00 window)</div>

        <div class="barrow">
          <div class="barlabel">Projected</div>
          <div id="hx-proj-bar" class="bar"></div>
        </div>
        <div id="hx-proj-legend" class="legend hint"></div>

        <div class="barrow">
          <div class="barlabel">Actual</div>
          <div id="hx-actual-bar" class="bar"></div>
        </div>
        <div id="hx-actual-legend" class="legend hint"></div>
      </div>

      <div style="height:12px"></div>
      <div class="pill-ui">Status changes</div>
      <div id="hx-events-empty" class="hint" style="margin-top:6px; display:none">No status changes recorded for this day.</div>
      <ul id="hx-events-list" style="margin:8px 0 0 0; padding:0 0 0 16px"></ul>
    </div>
    <div class="panel-ft">
      <button class="btn" id="hx-day-open-schedule">Open schedule for this day</button>
    </div>
  </div>

  <div id="diag" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">API Diagnostics</h3>
        <button class="btn" id="diag-close">Close</button>
      </div>
      <div style="height:8px"></div>
      <div id="diag-body"></div>
    </div>
  </div>

  <script>
    // ========== CONSTANTS ==========
    const POLL_INTERVAL = 5000;
    const DEBOUNCE_DELAY = 250;
    const MAX_CACHE_SIZE = 100;
    const STATUSES = ['available','break','lunch','bathroom','training','meeting','offline'];
    
    // ========== UTILITIES ==========
    const errEl = document.getElementById('errbar');
    function showErr(msg){ 
      errEl.textContent = String(msg||''); 
      errEl.style.display = msg ? 'block' : 'none'; 
      if (msg) setTimeout(() => showErr(''), 5000);
    }

    // Memoization helper
    function memoize(fn, maxSize = MAX_CACHE_SIZE) {
      const cache = new Map();
      return function(...args) {
        const key = JSON.stringify(args);
        if (cache.has(key)) return cache.get(key);
        const result = fn.apply(this, args);
        cache.set(key, result);
        if (cache.size > maxSize) {
          const firstKey = cache.keys().next().value;
          cache.delete(firstKey);
        }
        return result;
      };
    }

    // Debounce helper
    function debounce(fn, delay) {
      let timer;
      return function(...args) {
        clearTimeout(timer);
        timer = setTimeout(() => fn.apply(this, args), delay);
      };
    }

    // ========== API CACHE ==========
    const API_CACHE = {
      users: null,
      schedules: null
    };

    // ========== TABS / UI ==========
    const tabs = Array.from(document.querySelectorAll('.tab'));
    const panels = {
      users: document.getElementById('tab-users'),
      live: document.getElementById('tab-live'),
      schedules: document.getElementById('tab-schedules'),
      history: document.getElementById('tab-history'),
      news: document.getElementById('tab-news'),
    };
    
    function activate(tab){
      tabs.forEach(b=>b.classList.toggle('active', b.dataset.tab===tab));
      Object.entries(panels).forEach(([k,el])=> el.classList.toggle('hidden', k!==tab));
      history.replaceState(null,'',`#${tab}`);
      onTabChange();
    }
    
    tabs.forEach(b=> b.addEventListener('click', ()=> activate(b.dataset.tab)));
    const initial = location.hash.replace('#',''); 
    if (initial && panels[initial]) activate(initial);

    // ========== AUTH ==========
    const meEl = document.getElementById('me');
    function normalizeMe(raw){ 
      const me = raw?.me ?? raw ?? {}; 
      return { 
        username: me.username || me.email || 'user', 
        role: String(me.role || 'AGENT').toUpperCase() 
      }; 
    }
    
    function isAdminRole(role){ 
      const r=String(role||'').toUpperCase(); 
      return r==='ADMIN' || r==='SUPERADMIN'; 
    }
    
    async function who(){ 
      const r = await fetch('/api/whoami', {
        credentials:'include',
