<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Allstar Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --brand:#e11d48; --brand-ink:#fff;
      --bg:#ffffff; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
      --chip:#f8fafc; --chip-ink:#0f172a; --shadow:0 10px 25px rgba(17,24,39,.08);
      --radius:18px;
      --good:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    .page{min-height:100vh;display:flex;flex-direction:column}
    .header{position:sticky;top:0;z-index:10;backdrop-filter:blur(6px);background:rgba(255,255,255,.9);border-bottom:1px solid var(--line)}
    .header-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 20px}
    .hl{display:flex;align-items:center;gap:10px}
    .logoimg{height:28px;width:auto;border-radius:8px}
    .brand{font-weight:900;letter-spacing:.3px;color:var(--brand);font-size:18px}
    .pill{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;background:#fee2e2;color:#b91c1c;font-size:12px;border:1px solid #fecaca}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer;color:inherit;text-decoration:none;box-shadow:var(--shadow)}
    .btn:hover{background:#fafafa}
    .btn-danger{border-color:#fecaca;color:#b91c1c;background:#fff}
    .btn-danger:hover{background:#fff5f5}
    .btn-brand{background:var(--brand);border-color:transparent;color:#fff}
    .main{max-width:1200px;margin:0 auto;padding:20px;flex:1;width:100%}
    .tabs{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px}
    .tab{padding:8px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;cursor:pointer}
    .tab.active{background:var(--brand);color:#fff;border-color:transparent}
    .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .card h2{margin:0 0 8px 0}
    .muted{color:var(--muted)}
    .footer{padding:16px 20px;color:var(--muted);border-top:1px solid var(--line);text-align:center;font-size:12px;margin-top:20px}
    .errbar{position:fixed;left:20px;right:20px;bottom:16px;z-index:60;background:#fef2f2;color:#991b1b;border:1px solid #fecaca;border-radius:12px;padding:10px 12px;box-shadow:var(--shadow);display:none}
    .hidden{display:none!important}
    /* Users tab UI */
    .row{display:flex;align-items:center;gap:10px}
    input,select{border:1px solid var(--line);border-radius:10px;padding:8px 10px;font:inherit}
    .tr{display:grid;grid-template-columns:1.3fr .8fr .6fr .6fr .3fr;gap:10px;align-items:center;background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px}
    .th{font-weight:700;color:#334155}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;background:#f8fafc}
    .tag.admin{background:#eef2ff;color:#3730a3;border-color:#e0e7ff}
    .menu{position:relative}
    .menu-btn{border:1px solid var(--line);border-radius:10px;padding:6px 10px;background:#fff;cursor:pointer}
    .menu-pop{position:absolute;right:0;top:36px;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);min-width:190px;display:none;overflow:hidden}
    .menu.open .menu-pop{display:block}
    .menu-item{padding:10px 12px;cursor:pointer}
    .menu-item:hover{background:#f8fafc}
    .panel{position:fixed;top:0;right:0;bottom:0;width:420px;max-width:100%;background:#fff;border-left:1px solid var(--line);box-shadow:var(--shadow);transform:translateX(100%);transition:transform .2s ease;z-index:40;display:flex;flex-direction:column}
    .panel.open{transform:translateX(0)}
    .panel-hd{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
    .panel-bd{padding:16px;flex:1;overflow:auto}
    .panel-ft{padding:16px;border-top:1px solid var(--line);display:flex;justify-content:flex-end;gap:8px}
    .label{display:block;margin:8px 0 4px 0;font-size:12px;color:#334155}
    .switch{display:inline-flex;align-items:center;gap:8px}
    .switch input{width:18px;height:18px}
    /* Diagnostics modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:50}
    .modal.open{display:flex}
    .modal-card{width:min(900px,95vw);max-height:85vh;overflow:auto;background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);padding:14px}
    pre{white-space:pre-wrap;background:#f8fafc;border:1px solid var(--line);padding:10px;border-radius:10px;font-size:12px;max-height:300px;overflow:auto}
    .hint{font-size:12px;color:#64748b}
  </style>
</head>
<body>
  <div id="errbar" class="errbar"></div>

  <div class="page">
    <div class="header">
      <div class="header-inner">
        <div class="hl">
          <img class="logoimg" src="/allstar-logo.png" alt="Allstar" onerror="this.style.display='none'">
          <div class="brand">Allstar Admin</div>
          <span class="pill">Admin only</span>
        </div>
        <div class="hl">
          <span id="me" class="muted"></span>
          <button class="btn" id="diag-btn">Diagnose API</button>
          <a class="btn" href="/hub.html">Back to Hub</a>
          <a class="btn btn-danger" href="/api/logout">Sign out</a>
        </div>
      </div>
    </div>

    <main class="main">
      <nav class="tabs">
        <button class="tab active" data-tab="users">Users</button>
        <button class="tab" data-tab="live">Live Board</button>
        <button class="tab" data-tab="schedules">Schedules</button>
        <button class="tab" data-tab="history">History</button>
        <button class="tab" data-tab="news">News</button>
      </nav>

      <!-- Users -->
      <section class="card" id="tab-users">
        <div class="row" style="justify-content:space-between">
          <div>
            <h2 style="margin:0">Users</h2>
            <div id="u-endpoint" class="hint"></div>
          </div>
          <div class="row">
            <input id="u-search" placeholder="Search users…" />
            <button class="btn" id="u-refresh">Refresh</button>
            <button class="btn btn-brand" id="u-new">New User</button>
          </div>
        </div>
        <div style="height:10px"></div>

        <div id="u-empty" class="muted" style="display:none">No users found.</div>
        <div id="u-list"></div>
      </section>

      <!-- Stubs -->
      <section class="card hidden" id="tab-live"><h2>Live Board</h2><div class="muted">Coming soon…</div></section>
      <section class="card hidden" id="tab-schedules"><h2>Schedules</h2><div class="muted">Coming soon…</div></section>
      <section class="card hidden" id="tab-history"><h2>Adherence History</h2><div class="muted">Coming soon…</div></section>
      <section class="card hidden" id="tab-news"><h2>News</h2><div class="muted">Coming soon…</div></section>
    </main>

    <div class="footer">© Allstar — Admin Tools</div>
  </div>

  <!-- Slide-over: User detail -->
  <div id="panel" class="panel" aria-hidden="true">
    <div class="panel-hd">
      <div id="p-title" style="font-weight:700">User</div>
      <button class="btn" id="p-close">Close</button>
    </div>
    <div class="panel-bd">
      <label class="label">Username</label>
      <input id="p-username" disabled />

      <label class="label">Role</label>
      <select id="p-role">
        <option value="AGENT">AGENT</option>
        <option value="ADMIN">ADMIN</option>
        <option value="SUPERADMIN">SUPERADMIN</option>
      </select>

      <div style="height:8px"></div>
      <label class="switch">
        <input id="p-force" type="checkbox" />
        <span>Must change password on next login</span>
      </label>

      <div style="height:14px"></div>
      <div class="row">
        <button class="btn" id="p-reset">Reset Password</button>
        <div id="p-reset-msg" class="muted" style="font-size:12px"></div>
      </div>
    </div>
    <div class="panel-ft">
      <button class="btn btn-danger" id="p-delete">Delete</button>
      <button class="btn btn-brand" id="p-save">Save</button>
    </div>
  </div>

  <!-- Modal: Create user -->
  <div id="new-modal" class="panel" aria-hidden="true" style="width:460px">
    <div class="panel-hd">
      <div style="font-weight:700">Create User</div>
      <button class="btn" id="n-close">Close</button>
    </div>
    <div class="panel-bd">
      <label class="label">Username (or email)</label>
      <input id="n-username" placeholder="jane.doe" />

      <label class="label">Role</label>
      <select id="n-role">
        <option value="AGENT">AGENT</option>
        <option value="ADMIN">ADMIN</option>
      </select>

      <label class="label">Temp password (optional)</label>
      <input id="n-temp" type="text" placeholder="leave blank to auto-generate" />
    </div>
    <div class="panel-ft">
      <button class="btn btn-brand" id="n-create">Create</button>
    </div>
  </div>

  <!-- Diagnostics modal -->
  <div id="diag" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">API Diagnostics</h3>
        <button class="btn" id="diag-close">Close</button>
      </div>
      <div style="height:8px"></div>
      <div id="diag-body"></div>
    </div>
  </div>

  <script>
    // ---------- UI helpers ----------
    const errEl = document.getElementById('errbar');
    function showErr(msg){ errEl.textContent = String(msg||''); errEl.style.display = msg ? 'block' : 'none'; }
    const tabs = Array.from(document.querySelectorAll('.tab'));
    const panels = {
      users: document.getElementById('tab-users'),
      live: document.getElementById('tab-live'),
      schedules: document.getElementById('tab-schedules'),
      history: document.getElementById('tab-history'),
      news: document.getElementById('tab-news'),
    };
    function activate(tab){ tabs.forEach(b=>b.classList.toggle('active', b.dataset.tab===tab)); Object.entries(panels).forEach(([k,el])=> el.classList.toggle('hidden', k!==tab)); history.replaceState(null,'',`#${tab}`); }
    tabs.forEach(b=> b.addEventListener('click', ()=> activate(b.dataset.tab)));
    const initial = location.hash.replace('#',''); if (initial && panels[initial]) activate(initial);

    // ---------- Auth ----------
    const meEl = document.getElementById('me');
    function normalizeMe(raw){ const me = raw?.me ?? raw ?? {}; return { username: me.username || me.email || 'user', role: String(me.role || 'AGENT').toUpperCase() }; }
    function isAdminRole(role){ const r=String(role||'').toUpperCase(); return r==='ADMIN' || r==='SUPERADMIN'; }
    async function who(){ const r = await fetch('/api/whoami', {credentials:'include', cache:'no-store', mode:'cors', headers:{Accept:'application/json'}}); if(!r.ok) throw new Error('whoami_fail'); const data = await r.json().catch(()=> ({})); return data; }
    (async ()=>{
      try{
        const m = normalizeMe(await who());
        meEl.textContent = `${m.username} · ${m.role}`;
        if (!isAdminRole(m.role)) showErr('Access denied: admin role required.');
      }catch{ showErr('Unable to verify session.'); }
    })();

    // ---------- Generic API (force JSON) ----------
    function looksLikeHtml(t){
      const s = String(t || '');
      return /<\/?[a-z][\s\S]*>/i.test(s);
    }
    async function apiJSON(path, opts = {}){
      const init = {
        credentials: 'include',
        mode: 'cors',
        cache: 'no-store',
        ...opts,
        headers: {
          Accept: 'application/json',
          ...(opts.body ? {'content-type':'application/json'} : {}),
          ...(opts.headers || {})
        }
      };
      const r = await fetch(path, init);
      const text = await r.text().catch(()=> '');
      let data;
      try { data = text ? JSON.parse(text) : {}; } catch { data = undefined; }
      if (!r.ok || looksLikeHtml(text) || (text && data === undefined)) {
        const e = new Error('Request failed');
        e.status = r.status;
        e.text = text;
        e.data = data;
        throw e;
      }
      return { status: r.status, data, text };
    }

    // ---------- Users tab ----------
    const U = {
      list: document.getElementById('u-list'),
      empty: document.getElementById('u-empty'),
      q: document.getElementById('u-search'),
      refresh: document.getElementById('u-refresh'),
      newBtn: document.getElementById('u-new'),
      endpoint: document.getElementById('u-endpoint'),
      // panel
      panel: document.getElementById('panel'),
      pClose: document.getElementById('p-close'),
      pTitle: document.getElementById('p-title'),
      pUsername: document.getElementById('p-username'),
      pRole: document.getElementById('p-role'),
      pForce: document.getElementById('p-force'),
      pSave: document.getElementById('p-save'),
      pDelete: document.getElementById('p-delete'),
      pReset: document.getElementById('p-reset'),
      pResetMsg: document.getElementById('p-reset-msg'),
      // new modal
      newModal: document.getElementById('new-modal'),
      nClose: document.getElementById('n-close'),
      nUser: document.getElementById('n-username'),
      nRole: document.getElementById('n-role'),
      nTemp: document.getElementById('n-temp'),
      nCreate: document.getElementById('n-create'),
    };
    let users = [];
    let selected = null;
    let USERS_BASE = ''; // set when a probe wins

    function adaptUsers(payload){
      const arr = Array.isArray(payload) ? payload
                : Array.isArray(payload?.users) ? payload.users
                : Array.isArray(payload?.data) ? payload.data
                : [];
      return arr.map(u => ({
        id: u.id || u.user_id || u._id || null,
        username: u.username || u.email || '',
        role: (u.role || 'AGENT').toUpperCase(),
        // Active isn't a column in your Worker; keep UI but ignore backend write.
        active: ('active' in u) ? !!u.active : true,
        forcePwReset: !!(u.forcePwReset || u.mustChangePassword || u.must_change_password),
      })).filter(u => u.username);
    }

    async function listUsers(query=''){
      const qs = query ? ('?query=' + encodeURIComponent(query)) : '';
      const probes = [
        '/api/users'+qs,
        '/api/users?format=json'+(qs? '&'+qs.slice(1):''),
        '/api/users?list=1'+(qs? '&'+qs.slice(1):''),
        '/api/users/list'+qs,
        '/api/admin/users'+qs,
        '/api/admin/users/list'+qs,
        '/api/list-users'+qs,
        '/api/user/list'+qs,
      ];
      let lastErr;
      for (const p of probes){
        try{
          const {data} = await apiJSON(p, { method:'GET' });
          const adapted = adaptUsers(data);
          if (Array.isArray(adapted)){
            USERS_BASE = p.replace(/(\/users.*|\/list.*|\/user\/list.*)$/,'/users'); // best-effort base
            U.endpoint.textContent = 'API Endpoint in use: ' + p;
            return adapted;
          }
        }catch(e){ lastErr = e; }
      }
      throw lastErr || new Error('users_list_failed');
    }

    function renderUsers(){
      U.list.innerHTML = '';
      if (!users.length){ U.empty.style.display='block'; return; }
      U.empty.style.display='none';
      const head = document.createElement('div');
      head.className = 'tr th';
      head.innerHTML = `<div>Username</div><div>Role</div><div>Active</div><div>Must reset</div><div></div>`;
      U.list.appendChild(head);
      users.forEach(u=>{
        const row = document.createElement('div');
        row.className = 'tr';
        row.innerHTML = `
          <div><strong>${u.username}</strong></div>
          <div><span class="tag ${u.role==='ADMIN'?'admin':''}">${u.role}</span></div>
          <div>${u.active?'<span class="tag">Yes</span>':'<span class="tag">No</span>'}</div>
          <div>${u.forcePwReset?'<span class="tag">Yes</span>':'<span class="tag">No</span>'}</div>
          <div class="menu">
            <button class="menu-btn">⋯</button>
            <div class="menu-pop">
              <div class="menu-item" data-act="open">Open</div>
              <div class="menu-item" data-act="reset">Reset password</div>
              <div class="menu-item" data-act="delete">Delete</div>
            </div>
          </div>
        `;
        row.addEventListener('click', ev=>{ if (ev.target.closest('.menu')) return; openPanel(u); });
        const menu = row.querySelector('.menu');
        row.querySelector('.menu-btn').addEventListener('click', (e)=>{ e.stopPropagation(); document.querySelectorAll('.menu.open').forEach(m=>m.classList.remove('open')); menu.classList.toggle('open'); });
        row.querySelectorAll('.menu-item').forEach(mi=>{
          mi.addEventListener('click', async ()=>{
            menu.classList.remove('open');
            const act = mi.dataset.act;
            if (act==='open') openPanel(u);
            if (act==='reset') await doReset(u);
            if (act==='delete') await doDelete(u);
          });
        });
        document.addEventListener('click', ()=> menu.classList.remove('open'));
        U.list.appendChild(row);
      });
    }

    function openPanel(u){
      selected = {...u}; // includes id
      U.pTitle.textContent = u.username;
      U.pUsername.value = u.username;
      U.pRole.value = u.role || 'AGENT';
      U.pForce.checked = !!u.forcePwReset;
      U.pResetMsg.textContent = '';
      U.panel.classList.add('open');
    }
    function closePanel(){ U.panel.classList.remove('open'); selected=null; }
    U.pClose.addEventListener('click', closePanel);

    async function doSave(){
      if (!selected) return;
      if (!selected.id){ showErr('Cannot save: user id missing. Refresh.'); return; }
      const updates = [];
      // role change (Worker: SUPERADMIN required for role changes)
      const newRole = U.pRole.value;
      if (newRole && newRole !== selected.role) updates.push({ role: newRole });
      // must change password
      const mustChange = !!U.pForce.checked;
      if (mustChange !== !!selected.forcePwReset) updates.push({ mustChangePassword: mustChange });

      if (!updates.length){ closePanel(); return; }

      // Send each field individually to keep semantics clear
      for (const body of updates){
        try{
          await apiJSON(`${USERS_BASE || '/api/users'}/${encodeURIComponent(selected.id)}`, {
            method:'PATCH',
            body: JSON.stringify(body)
          });
        }catch(e){
          showErr('Save failed: Request failed');
          return;
        }
      }
      closePanel(); await refresh();
    }
    U.pSave.addEventListener('click', doSave);

    async function doDelete(u){
      if (!u?.id){ showErr('Cannot delete: user id missing. Refresh.'); return; }
      if (!confirm(`Delete user "${u.username}"? This cannot be undone.`)) return;
      try{
        await apiJSON(`${USERS_BASE || '/api/users'}/${encodeURIComponent(u.id)}`, { method:'DELETE' });
        closePanel(); await refresh();
      }catch{
        showErr('Delete failed: Request failed');
      }
    }
    U.pDelete.addEventListener('click', ()=> selected && doDelete(selected));

    async function doReset(u){
      if (!u?.id){ showErr('Cannot reset: user id missing. Refresh.'); return; }
      // Preferred path if you later add a dedicated endpoint:
      const tryEndpoints = [
        `${USERS_BASE || '/api/users'}/${encodeURIComponent(u.id)}/reset-password`,
      ];
      for (const p of tryEndpoints){
        try{
          const {data} = await apiJSON(p, { method:'POST' });
          const temp = (data && (data.tempPassword || data.password)) || '';
          U.pResetMsg.textContent = temp ? `Temp password: ${temp}` : 'Password reset triggered.';
          return;
        }catch{}
      }
      // Fallback: just force a change on next login
      try{
        await apiJSON(`${USERS_BASE || '/api/users'}/${encodeURIComponent(u.id)}`, {
          method:'PATCH',
          body: JSON.stringify({ mustChangePassword: true })
        });
        U.pResetMsg.textContent = 'Flagged to change password on next login.';
      }catch{
        showErr('Reset password failed: Request failed');
      }
    }
    U.pReset.addEventListener('click', ()=> selected && doReset(selected));

    // Create user
    function openNew(){ U.nUser.value=''; U.nRole.value='AGENT'; U.nTemp.value=''; U.newModal.classList.add('open'); }
    function closeNew(){ U.newModal.classList.remove('open'); }
    U.nClose.addEventListener('click', closeNew);
    U.nCreate.addEventListener('click', async ()=>{
      const username = U.nUser.value.trim().toLowerCase();
      const roleUpper = U.nRole.value;
      let pw = U.nTemp.value.trim();
      if (!username){ showErr('Username is required.'); return; }
      if (!pw){
        // generate simple temp (Worker enforces hash + mustChangePassword)
        pw = Math.random().toString(36).slice(2,6) + Math.random().toString(36).slice(2,6);
      }
      const payloads = [
        { username, role: roleUpper, password: pw },
        { email: username, role: roleUpper, password: pw }, // if Worker maps email->username
      ];
      const paths = [
        USERS_BASE || '/api/users',
        '/api/admin/users',
      ];
      for (const p of paths){
        for (const body of payloads){
          try{
            await apiJSON(p, { method:'POST', body: JSON.stringify(body) });
            closeNew();
            await refresh();
            alert(`User created.\nTemp password: ${pw}\n(They'll be forced to change on first login.)`);
            showErr('');
            return;
          }catch{}
        }
      }
      showErr('Create failed: Request failed');
    });

    // Search/refresh wiring
    async function refresh(){
      try{
        const arr = await listUsers(U.q.value.trim());
        users = arr;
        renderUsers();
        showErr('');
      }catch(e){
        showErr('Failed to load users: Request failed');
      }
    }
    document.getElementById('u-refresh').addEventListener('click', refresh);
    document.getElementById('u-new').addEventListener('click', openNew);
    document.getElementById('u-search').addEventListener('input', ()=>{ clearTimeout(U._deb); U._deb = setTimeout(refresh, 250); });

    // ---------- Diagnostics ----------
    const diag = document.getElementById('diag');
    const diagBtn = document.getElementById('diag-btn');
    const diagClose = document.getElementById('diag-close');
    const diagBody = document.getElementById('diag-body');
    diagBtn.addEventListener('click', async ()=>{
      diag.classList.add('open');
      diagBody.innerHTML = '<div class="muted">Probing endpoints…</div>';
      const report = [];
      async function probe(label, fn){
        try{
          const t0=performance.now();
          const res = await fn();
          const t1=performance.now();
          report.push(`✓ ${label} (${Math.round(t1-t0)}ms)\n` + JSON.stringify(res,null,2).slice(0,2000));
        }catch(e){
          const summary = e && (e.debug || e.text || e.message || e.toString());
          report.push(`✗ ${label}\n` + String(summary).slice(0,2000));
        }
      }
      await probe('whoami', async()=> (await apiJSON('/api/whoami',{method:'GET'})));
      try{
        const arr = await listUsers(document.getElementById('u-search').value.trim());
        report.push(`✓ users list\n` + JSON.stringify({ using: USERS_BASE || '(not set — path variant)' , count: arr.length }, null, 2));
      }catch(e){
        report.push('✗ users list\n' + (e.text || e.message || 'fail'));
      }
      const sampleUser = 'diag_'+Math.random().toString(36).slice(2,7);
      report.push('Create payload shapes (preview only):\n' + JSON.stringify([
        { username: sampleUser, role:'ADMIN', password:'Temp1234' },
        { email: sampleUser, role:'ADMIN', password:'Temp1234' },
      ], null, 2));
      diagBody.innerHTML = report.map(r=> `<pre>${r}</pre>`).join('');
    });
    diagClose.addEventListener('click', ()=> diag.classList.remove('open'));
    diag.addEventListener('click', (e)=> { if (e.target===diag) diag.classList.remove('open'); });

    // Initial users load
    refresh();
  </script>
</body>
</html>
