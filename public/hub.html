<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Allstar Agent Hub</title>
<link rel="stylesheet" href="/theme.css"/>
</head>
<body>
  <div class="header">
    <div class="wrap brand">
      <div class="mark">ALLSTAR</div>
      <div style="font-weight:700">Agent Hub</div>
      <div id="hdr-right" style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <span id="meta" class="pill">Not signed in</span>
        <button id="logout" class="btn" style="display:none">Logout</button>
      </div>
    </div>
  </div>

  <div class="wrap" id="root"></div>

<script>
const el=(t,a,...c)=>{const n=document.createElement(t);if(a)Object.entries(a).forEach(([k,v])=>k==='class'?n.className=v:k==='style'?Object.assign(n.style,v):k.startsWith('on')?n.addEventListener(k.slice(2),v):n.setAttribute(k,v));c.flat().forEach(x=>n.append(x?.nodeType?x:document.createTextNode(x??'')));return n;}
const qs=s=>document.querySelector(s);

async function api(path,opts={}){
  const r = await fetch(path,Object.assign({credentials:'include'},opts));
  const ct=r.headers.get('content-type')||'';
  const t=ct.includes('json')?await r.json():await r.text();
  if(!r.ok) throw Object.assign(new Error(typeof t==='string'?t:(t.error||('HTTP '+r.status))),{status:r.status,body:t});
  return t;
}

function newsCard(item){
  const when = item.PublishedAt ? new Date(item.PublishedAt).toLocaleString() : '';
  const pin = item.Pinned ? 'ðŸ“Œ ' : '';
  return el('div',{class:'card'}, el('div',{style:{display:'flex',justifyContent:'space-between',gap:'8px'}},
            el('div',{}, el('div',{style:{fontWeight:'700',marginBottom:'4px'}}, pin+item.Title),
                            el('div',{class:'help'}, when)),
            el('div',{class:'pill'}, item.Audience||'all')),
          el('div',{style:{marginTop:'8px',whiteSpace:'pre-wrap'}}, item.Body||''));
}

function loginView(){
  const root=qs('#root'); root.innerHTML='';
  const box=el('div',{class:'card',style:{maxWidth:'420px',margin:'40px auto'}},
      el('h2',{},'Sign in with your scheduling credentials'),
      el('div',{class:'label'},'Email'),
      el('input',{id:'email',class:'field',placeholder:'your.name@allstarservicesnow.com'}),
      el('div',{class:'label',style:{marginTop:'10px'}},'Password'),
      el('input',{id:'pw',type:'password',class:'field',placeholder:'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'}),
      el('div',{id:'err',class:'help',style:{color:'#fca5a5',display:'none',marginTop:'6px'}},''),
      el('div',{style:{marginTop:'12px'}},
        el('button',{class:'btn-brand',style:{width:'100%'},onclick:doLogin},'Sign in')))
  root.append(box);

  async function doLogin(){
    const email=qs('#email').value.trim(); const password=qs('#pw').value;
    qs('#err').style.display='none';
    try{
      await api('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})});
      render(); // will switch to hub view
    }catch(e){ qs('#err').textContent='Sign in failed. Check your email/password.'; qs('#err').style.display='block'; }
  }
}

function hubView(me){
  const root=qs('#root'); root.innerHTML='';
  // header meta + logout
  qs('#meta').textContent = me.username+' Â· '+me.role;
  const lo=qs('#logout'); lo.style.display='inline-flex'; lo.onclick=async()=>{await api('/api/logout',{method:'POST'}).catch(()=>{}); render();}

  // billboard + shortcuts
  const aud = me.role==='ADMIN'||me.role==='SUPERADMIN' ? 'ADMIN' : 'AGENT';
  const newsWrap = el('div',{class:'grid grid-2'},
    el('div',{}, el('div',{class:'card'},
      el('h2',{},'Team News & Memos'), el('div',{id:'news'}, 'Loadingâ€¦'))),
    el('div',{}, el('div',{class:'card'},
      el('h3',{},'Tools'),
      el('div',{class:'grid',style:{gap:'10px',marginTop:'10px'}},
        el('a',{class:'btn tab',href:'/flowmaster/'},'Flowmaster'),
        el('a',{class:'btn tab',href:'/adherence/'},'Schedule (Adherence)')))));
  root.append(newsWrap);

  (async ()=>{
    try{
      const res = await api('/api/news?aud='+encodeURIComponent(aud));
      const items = res.items||[];
      const host = qs('#news'); host.innerHTML='';
      if(!items.length){ host.textContent='No news yet.'; return; }
      items.sort((a,b)=> (b.Pinned?-1:0) - (a.Pinned?-1:0) || (new Date(b.PublishedAt||0)-new Date(a.PublishedAt||0)) );
      items.forEach(x=>host.append(newsCard(x)));
    }catch{ qs('#news').textContent='Billboard unavailable.'; }
  })();
}

async function render(){
  // reset header bits
  qs('#meta').textContent='Checkingâ€¦'; qs('#logout').style.display='none';
  try{
    const me=await api('/api/whoami');
    hubView(me);
  }catch{
    qs('#meta').textContent='Not signed in';
    loginView();
  }
}
render();
</script>
</body>
</html>
