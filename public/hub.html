<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Allstar Agent Hub â€” Home</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <style>
    :root{
      --brand:#e11d48; --brand-ink:#fff;
      --bg:#ffffff; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
      --chip:#f8fafc; --chip-ink:#0f172a; --shadow:0 10px 25px rgba(17,24,39,.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font:15px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
    .container{max-width:1200px;margin:0 auto;padding:24px}
    .header{position:sticky;top:0;z-index:10;backdrop-filter:blur(6px);background:rgba(255,255,255,.9);border-bottom:1px solid var(--line)}
    .header-inner{display:flex;align-items:center;gap:14px;padding:14px 20px}
    .logo{font-weight:900;letter-spacing:.3px;color:var(--brand);font-size:18px}
    .me{margin-left:auto;color:var(--muted)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer;color:inherit;text-decoration:none;box-shadow:var(--shadow)}
    .btn:hover{background:#fafafa}
    .btn-brand{background:var(--brand);border-color:transparent;color:var(--brand-ink)}
    .btn-brand:hover{filter:brightness(.97)}
    .btn-ghost{background:#fff}
    .btn-row{display:flex;flex-wrap:wrap;gap:12px}
    .pill{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;background:var(--chip);color:var(--chip-ink);font-size:12px;border:1px solid var(--line)}
    .hero{display:flex;align-items:flex-start;justify-content:space-between;gap:20px;margin:20px 0 16px}
    .hero h1{margin:0 0 6px 0;font-size:28px;letter-spacing:.2px}
    .hero p{margin:0;color:var(--muted)}
    .grid{display:grid;gap:20px}
    .grid-2{grid-template-columns:2fr 1fr}
    .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
    .card h2{margin:0 0 8px 0}
    .news-item{padding:12px 0;border-top:1px solid var(--line)}
    .news-item:first-child{border-top:0}
    .muted{color:var(--muted)}
    .hidden{display:none!important}
    .centerbox{max-width:560px;margin:40px auto}
    @media (max-width:1000px){ .grid-2{grid-template-columns:1fr} .hero{flex-direction:column;gap:12px} }
  </style>
  <script>
    // If someone typed /hub without .html, correct it once (no loop).
    if (location.pathname === '/hub') location.replace('/hub.html');
  </script>
</head>
<body>
  <div class="header">
    <div class="header-inner">
      <div class="logo">ALLSTAR â€” Agent Hub</div>
      <div id="me" class="me">Loadingâ€¦</div>
      <button id="logout" class="btn btn-ghost" type="button">Log out</button>
    </div>
  </div>

  <div id="content" class="container">
    <!-- Filled by JS -->
  </div>

  <script>
  (function(){
    const $ = s => document.querySelector(s);

    // Single navigation handler for "buttons"
    document.addEventListener('click', (e)=>{
      const el = e.target.closest('[data-nav]');
      if(!el) return;
      const to = el.getAttribute('data-nav');
      if(!to) return;
      location.assign(to);
    });

    function esc(s){return String(s).replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]))}

    function renderSignedOut(){
      $('#me').textContent = 'Not signed in';
      const host = $('#content');
      host.innerHTML = '';
      const card = document.createElement('div');
      card.className = 'card centerbox';
      card.innerHTML = `
        <h2>Session required</h2>
        <p class="muted" style="margin:6px 0 14px 0">Youâ€™re not signed in. Please sign in to access the Hub.</p>
        <div class="btn-row">
          <button class="btn btn-brand" type="button" data-nav="/">Go to sign-in</button>
        </div>`;
      host.appendChild(card);
    }

    function renderHub(me, items){
      $('#me').textContent = me?.username ? `${me.username} Â· ${me.role}` : 'Signed in';

      const aud = (me?.role === 'ADMIN' || me?.role === 'SUPERADMIN') ? 'ADMIN' : 'AGENT';
      const adminBtn = (aud === 'ADMIN') ? '' : ' hidden';

      const content = `
        <div class="hero">
          <div>
            <h1>Welcome back${me?.username ? `, ${esc(me.username)}` : ''} ðŸ‘‹</h1>
            <p class="muted">Quick links to your tools and live team updates.</p>
          </div>
          <div class="btn-row">
            <button class="btn btn-brand" type="button" data-nav="/adherence/">Adherence / Schedule</button>
            <button class="btn btn-ghost" type="button" data-nav="/flowmaster/">Flowmaster</button>
            <button id="adminToolsBtn" class="btn btn-ghost${adminBtn}" type="button" data-nav="/admin/">Admin Tools</button>
          </div>
        </div>

        <div class="grid grid-2">
          <div class="card">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px">
              <h2>Team News &amp; Memos</h2>
              <span id="audChip" class="pill">${aud === 'ADMIN' ? 'Admins' : 'Agents'}</span>
            </div>
            <div id="news" class="muted">${renderNewsHTML(items)}</div>
          </div>

          <div class="card">
            <h2>Account</h2>
            <div id="roleLine" class="muted" style="margin:4px 0 12px 0">Role: ${esc(me?.role||'unknown')}</div>
            <div class="btn-row">
              <button class="btn" type="button" data-nav="/adherence/">Open Adherence</button>
              <button class="btn" type="button" data-nav="/flowmaster/">Open Flowmaster</button>
            </div>
          </div>
        </div>
      `;
      const host = $('#content');
      host.innerHTML = content;
    }

    function renderNewsHTML(items){
      if (!Array.isArray(items) || items.length === 0) {
        return '<div class="muted">No news yet.</div>';
      }
      return items.map(it=>{
        const when = it.date ? new Date(it.date).toLocaleString() : '';
        return `
          <div class="news-item">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
              <strong>${esc(it.title||'')}</strong>
              <span class="pill">${esc(it.audience||'all')}</span>
            </div>
            <div class="muted" style="font-size:12px;margin-top:2px">${when}</div>
            <div style="margin-top:8px">${esc(it.body||'')}</div>
          </div>
        `;
      }).join('');
    }

    async function boot(){
      // Do not auto-redirect; show state instead. This prevents refresh loops.
      try{
        const r = await fetch('/api/whoami', { credentials:'include', cache:'no-store' });
        if (r.status === 401) { renderSignedOut(); return; }
        const me = await r.json().catch(()=>null);

        // Load news, but donâ€™t block the shell.
        let items = [];
        try{
          const aud = (me?.role === 'ADMIN' || me?.role === 'SUPERADMIN') ? 'ADMIN' : 'AGENT';
          const r2 = await fetch('/api/news?aud='+aud, { credentials:'include', cache:'no-store' });
          const j2 = await r2.json().catch(()=>({items:[]}));
          items = Array.isArray(j2.items) ? j2.items : [];
        }catch{}
        renderHub(me, items);

      }catch(e){
        // Network error: also avoid hard redirects; show signed-out state.
        console.error('whoami_error', e);
        renderSignedOut();
      }

      // Logout clears cookies client-side and returns to sign-in
      $('#logout').onclick = ()=>{
        document.cookie='access_token=; Path=/; Max-Age=0; Secure; SameSite=Lax';
        document.cookie='refresh_token=; Path=/; Max-Age=0; Secure; SameSite=Lax';
        location.assign('/');
      };
    }

    boot();
  })();
  </script>
</body>
</html>
