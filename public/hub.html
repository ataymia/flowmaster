<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Allstar Agent Hub</title>
  <link rel="stylesheet" href="/theme.css"/>
  <style>
    :root { --brand:#e11d48; --bg:#0b1220; --panel:#0f1a2e; --line:#1f2940; --text:#e5e7eb; --muted:#94a3b8; }
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .bar{position:sticky;top:0;z-index:10;background:rgba(11,18,32,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
    .barin{display:flex;align-items:center;gap:12px;padding:10px 16px}
    .tt{font-weight:800;color:var(--brand)}
    .sp{flex:1}
    .btn{border:1px solid var(--line);background:#0d1729;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{background:#0b1423}
    .btn-brand{background:var(--brand);border-color:transparent;color:#fff}
    .btn-brand:hover{filter:brightness(.95)}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}
    .grid{display:grid;gap:16px}
    .grid-2{grid-template-columns:1fr 1fr}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;padding:2px 8px;border-radius:999px;background:#17233b;color:#cbd5e1;font-size:12px;border:1px solid var(--line)}
    .news-title{font-weight:700;margin:0 0 4px 0}
    .news-body{white-space:pre-wrap}
    .navrow{display:flex;gap:12px;flex-wrap:wrap}
    .navcard{flex:1;min-width:220px}
    @media (max-width:860px){.grid-2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="bar">
    <div class="barin wrap">
      <div class="tt">Allstar Agent Hub</div>
      <div id="me" class="muted"></div>
      <div class="sp"></div>
      <a class="btn" href="/adherence/">Adherence</a>
      <a class="btn" href="/flowmaster/">Flowmaster</a>
      <button id="logout" class="btn">Logout</button>
    </div>
  </div>

  <div class="wrap" style="padding-top:16px">
    <div class="navrow">
      <div class="card navcard">
        <div class="news-title">Adherence & Scheduling</div>
        <div class="muted">Set status, view live adherence, edit schedules, export CSVs.</div>
        <div style="height:8px"></div>
        <a class="btn btn-brand" href="/adherence/">Open Adherence</a>
      </div>
      <div class="card navcard">
        <div class="news-title">Flowmaster</div>
        <div class="muted">All agent tools and flows you built.</div>
        <div style="height:8px"></div>
        <a class="btn btn-brand" href="/flowmaster/">Open Flowmaster</a>
      </div>
    </div>

    <div style="height:16px"></div>

    <div class="card">
      <div style="display:flex;align-items:center;gap:8px;justify-content:space-between">
        <h2 style="margin:0">Team News &amp; Memos</h2>
        <div id="count" class="muted"></div>
      </div>
      <div id="news" style="margin-top:12px" class="grid"></div>
    </div>
  </div>

<script>
/* ===== shared API helper (Pages → /api/*) ===== */
const USING_PAGES = location.hostname.endsWith('pages.dev') || location.hostname.endsWith('staragentdash.work');
let ACCESS_TOKEN = null; // not used on Pages, kept for GH fallback if you reuse this page there

async function api(path, opts = {}) {
  const url = USING_PAGES ? `/api${path}` : `https://allstar-auth.ataymia.workers.dev${path}`;
  const headers = { 'content-type':'application/json', ...(opts.headers||{}) };
  if (!USING_PAGES && ACCESS_TOKEN) headers.Authorization = `Bearer ${ACCESS_TOKEN}`;
  const res = await fetch(url, { credentials:'include', method:opts.method||'GET', headers, body:opts.body });
  const ct = res.headers.get('content-type')||''; const data = ct.includes('json') ? await res.json() : await res.text();
  if(!res.ok) throw new Error(data?.error || ('HTTP '+res.status));
  return data;
}
const whoami = () => api('/whoami');
const logout = () => api('/auth/logout', { method:'POST' });

/* ===== hub logic ===== */
const el = (t,a={},...c)=>{const n=document.createElement(t);for(const k in a){k==='class'?n.className=a[k]:k==='style'?Object.assign(n.style,a[k]):n.setAttribute(k,a[k])}c.flat().forEach(x=>n.append(x?.nodeType?x:document.createTextNode(x)));return n;}
const fmt = s => s ? new Date(s).toLocaleDateString() : '';

function renderItems(items){
  const host = document.getElementById('news'); host.innerHTML='';
  if(!items.length){ host.appendChild(el('div',{class:'muted'},'No memos yet.')); return; }
  // pinned first already sorted by API
  for(const it of items){
    const head = el('div',{style:{display:'flex',alignItems:'center',gap:'8px',justifyContent:'space-between'}},
      el('div',{}, el('div',{class:'news-title'}, it.title), el('div',{class:'muted'}, fmt(it.publishedAt))),
      it.pinned ? el('span',{class:'pill'},'Pinned') : ''
    );
    const body = el('div',{class:'news-body muted'}, it.body || '');
    const card = el('div',{class:'card'}, head, el('div',{style:{height:'6px'}}), body);
    host.appendChild(card);
  }
  document.getElementById('count').textContent = items.length + ' item' + (items.length===1?'':'s');
}

(async function init(){
  try{
    const me = await whoami();           // requires auth cookie (now first-party on your domain)
    document.getElementById('me').textContent = `${me.username} · ${me.role}`;
    document.getElementById('logout').onclick = async()=>{ try{ await logout(); } finally { location.href = '/'; } };

    // Agents see AGENT + ALL; admins/superadmins get ADMIN + ALL
    const aud = (me.role==='AGENT') ? 'AGENT' : 'ADMIN';
    const news = await api(`/news?aud=${encodeURIComponent(aud)}`);
    renderItems(news.items || []);
  }catch(e){
    // If unauth for some reason, go back to sign-in
    console.error(e);
    location.href = '/';
  }
})();
</script>
</body>
</html>
