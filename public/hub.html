<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Allstar Agent Hub</title>
  <link rel="stylesheet" href="/theme.css">
  <style>
    .title { font-size: 18px; font-weight: 700; }
  </style>
</head>
<body>
  <header class="appbar">
    <div class="brand">Allstar Agent Hub <span id="role" class="pill"></span></div>
    <nav class="row" style="margin-left:auto;">
      <a href="/hub.html">Home</a>
      <a href="/flowmaster/">Flowmaster</a>
      <a href="/adherence/">Schedule</a>
      <a id="adminTools" href="/adherence/admin/" style="display:none;">Admin tools</a>
    </nav>
  </header>

  <main class="container">
    <h2>Team News &amp; Memos</h2>
    <div id="news"></div>
    <p id="empty" class="muted" style="display:none;">No news yet.</p>
  </main>

  <script>
    const $ = (s)=>document.querySelector(s);

    async function loadMe() {
      try {
        const r = await fetch('/api/whoami'); const j = await r.json();
        if (j.authed) {
          const role = j.me.role;
          $('#role').textContent = role;
          if (role === 'ADMIN' || role === 'SUPERADMIN') $('#adminTools').style.display = '';
        } else {
          $('#role').textContent = 'AGENT';
        }
      } catch {}
    }

    async function loadNews() {
      const container = $('#news'); container.innerHTML = '';
      const r = await fetch('/api/news'); const { items } = await r.json();
      if (!items || !items.length) { $('#empty').style.display = ''; return; }
      $('#empty').style.display = 'none';
      for (const it of items) {
        const card = document.createElement('div'); card.className = 'card';
        const when = it.publishedAt ? new Date(it.publishedAt).toLocaleString() : '';
        card.innerHTML = `
          <div class="row-between"><div class="title">${escapeHtml(it.title || '')}</div>
            <div class="muted">${when}</div>
          </div>
          <div style="margin-top:6px;">${escapeHtml(it.body || '')}</div>
          <div style="margin-top:8px;">
            ${it.pinned ? '<span class="pill">Pinned</span>' : ''}
            ${it.audience && it.audience !== 'all' ? '<span class="pill">'+escapeHtml(it.audience)+'</span>' : ''}
          </div>
        `;
        container.appendChild(card);
      }
    }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    loadMe(); loadNews();
  </script>
</body>
</html>
