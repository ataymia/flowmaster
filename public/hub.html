<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Allstar Agent Hub â€” Home</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --brand:#e11d48; --brand-ink:#fff;
      --bg:#ffffff; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
      --shadow:0 10px 25px rgba(17,24,39,.08);
      --radius:18px;
      --admin:#0ea5e9; --super:#8b5cf6; --agent:#10b981;
    }
    *{box-sizing:border-box}
    body{margin:0;font:15px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
    .container{max-width:1200px;margin:0 auto;padding:24px}
    .header{position:sticky;top:0;z-index:10;backdrop-filter:blur(6px);background:rgba(255,255,255,.9);border-bottom:1px solid var(--line)}
    .header-inner{display:flex;align-items:center;gap:14px;padding:14px 20px}
    .brand{display:inline-flex;align-items:center;gap:10px;text-decoration:none}
    .brand-img{height:26px;width:auto;display:block}
    .me{margin-left:auto;color:var(--muted)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer;color:inherit;text-decoration:none;box-shadow:var(--shadow)}
    .btn:hover{background:#fafafa}
    .btn-row{display:flex;flex-wrap:wrap;gap:12px}
    .rolepill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;color:#fff;font-size:12px;font-weight:600}
    .role-admin{background:var(--admin)}
    .role-super{background:var(--super)}
    .role-agent{background:var(--agent)}
    .hero{margin:20px 0 16px}
    .hero h1{margin:0 0 6px 0;font-size:28px;letter-spacing:.2px}
    .hero p{margin:0;color:var(--muted)}
    .grid{display:grid;gap:20px}
    .grid-2{grid-template-columns:2fr 1fr}
    .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
    .card h2{margin:0 0 8px 0}
    .news-item{padding:12px 0;border-top:1px solid var(--line)}
    .news-item:first-child{border-top:0}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    @media (max-width:1000px){ .grid-2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="header">
    <div class="header-inner">
      <!-- keep your logo file name here -->
      <a href="/hub" class="brand" aria-label="Allstar">
        <img src="./allstar-logo.png" alt="ALLSTAR" class="brand-img">
      </a>
      <div id="me" class="me">Loadingâ€¦</div>
      <a id="logout" class="btn" href="#" role="button">Log out</a>
    </div>
  </div>

  <div class="container">
    <div class="hero">
      <h1>Welcome back<span id="welcomeName"></span> ðŸ‘‹</h1>
      <p class="muted">Quick links to your tools and live team updates.</p>
    </div>

    <div class="grid grid-2">
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px">
          <h2 style="margin:0">Team News</h2>
          <div class="small muted" id="newsUpdated">â€”</div>
        </div>
        <div id="news" class="muted">Loading newsâ€¦</div>
      </div>

      <div class="card">
        <h2>Account</h2>
        <div id="roleLine" class="muted" style="margin:6px 0 12px 0">Role: â€¦</div>
        <div class="btn-row">
          <a class="btn" href="/adherence/" role="button">Open Schedule</a>
          <a class="btn" href="/flowmaster/" role="button">Open Flowmaster</a>
        </div>
      </div>
    </div>
  </div>

  <script>
  (async function boot(){
    try{
      const r = await fetch('/api/whoami', { credentials:'include', cache:'no-store' });
      if (r.status === 401) { location.replace('/'); return; }
      const me = await r.json().catch(()=>null);

      // robust role normalization
      const raw = (me?.role ?? '').toString().trim();
      const roleKey = raw.toUpperCase();
      const role = roleKey === 'SUPERADMIN' ? 'SUPERADMIN'
                 : roleKey === 'ADMIN'      ? 'ADMIN'
                 : roleKey === 'AGENT'      ? 'AGENT'
                 : (raw || 'AGENT'); // never show "UNKNOWN"

      const isAdmin = role === 'ADMIN' || role === 'SUPERADMIN';

      // header text + greeting
      document.getElementById('me').textContent = me?.username ? `${me.username} Â· ${role}` : 'Signed in';
      document.getElementById('welcomeName').textContent = me?.username ? `, ${escapeHTML(me.username)}` : '';

      // role pill
      const roleLine = document.getElementById('roleLine');
      const pillClass = role === 'SUPERADMIN' ? 'role-super'
                     : role === 'ADMIN' ? 'role-admin'
                     : 'role-agent';
      roleLine.innerHTML = `Role: <span class="rolepill ${pillClass}" title="${escapeHTML(role)}">${escapeHTML(role)}</span>`;

      // Notion news audience (ADMIN for admin/superadmin, otherwise AGENT)
      const aud = isAdmin ? 'ADMIN' : 'AGENT';
      let lastSig = '';
      async function loadNews(){
        try{
          const res = await fetch('/api/news?aud='+aud, { credentials:'include', cache:'no-store' });
          const data = await res.json().catch(()=>({items:[]}));
          const items = Array.isArray(data.items) ? data.items : [];
          const sig = JSON.stringify(items.map(it => [it.title,it.body,it.date,it.audience]));
          if (sig !== lastSig){
            lastSig = sig;
            renderNews(items);
            document.getElementById('newsUpdated').textContent =
              'Updated ' + new Date().toLocaleTimeString();
          }
        }catch(e){ /* never break the page */ }
      }
      await loadNews();
      let ticking = false;
      setInterval(async ()=>{ if (ticking) return; ticking = true; try{ await loadNews(); } finally { ticking = false; }}, 60000);

      // logout
      document.getElementById('logout').addEventListener('click', (e)=>{
        e.preventDefault();
        document.cookie='access_token=; Path=/; Max-Age=0; Secure; SameSite=Lax';
        document.cookie='refresh_token=; Path=/; Max-Age=0; Secure; SameSite=Lax';
        location.assign('/');
      });
    }catch{ location.replace('/'); }
  })();

  function renderNews(items){
    const host = document.getElementById('news');
    host.innerHTML = '';
    if (!items.length){ host.innerHTML = '<div class="muted">No news yet.</div>'; return; }
    for (const it of items){
      const when = it.date ? new Date(it.date).toLocaleString() : '';
      const row = document.createElement('div');
      row.className='news-item';
      row.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <strong>${escapeHTML(it.title||'')}</strong>
        </div>
        <div class="muted small" style="margin-top:2px">${when}</div>
        <div style="margin-top:8px">${escapeHTML(it.body||'')}</div>`;
      host.appendChild(row);
    }
  }
  function escapeHTML(s){return String(s).replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]))}
  </script>
</body>
</html>
