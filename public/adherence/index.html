<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Allstar Agent Adherence</title>
<link rel="stylesheet" href="/theme.css">
<style>
  :root{
    --bg:#0b1220;
    --panel:#0f172a;
    --line:#1f2a44;
    --text:#e6edf3;
    --muted:#9fb3c8;
    --brand:#60a5fa;
    --good:#22c55e;
    --bad:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.35 ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  a{color:var(--brand);text-decoration:none}
  .container{max-width:1100px;margin:0 auto;padding:0 16px}
  .header{background:var(--panel);border-bottom:1px solid var(--line)}
  .header-inner{display:flex;gap:12px;align-items:center;padding:12px 0}
  .title{font-weight:800}
  .brand{color:var(--brand)}
  .muted{color:var(--muted)}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#0b1426;color:var(--text);cursor:pointer}
  .btn:hover{filter:brightness(.96)}
  .btn.primary{background:#2563eb;border-color:#1e3a8a}
  .btn.danger{background:#451a1a;border-color:#7f1d1d;color:#fecaca}
  .btn.small{padding:6px 10px;border-radius:8px}
  .grid{display:grid;gap:14px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}
  .tabs{display:flex;gap:8px;margin:12px 0}
  .tab{padding:8px 12px;border-radius:12px;border:1px solid var(--line);background:#0b1426;color:var(--text);cursor:pointer}
  .tab.active{background:#111a32}
  .row{display:flex;align-items:center;gap:12px}
  .row.wrap{flex-wrap:wrap}
  .grow{flex:1}
  .right{margin-left:auto}
  .error-banner{display:none;background:#3b0a0a;border:1px solid #7f1d1d;color:#fecaca;padding:8px 12px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#0b1426;color:var(--muted);font-size:12px}

  /* Status colors (diverse) */
  .st-available{background:#22c55e}
  .st-bathroom{background:#06b6d4}
  .st-break{background:#f59e0b}
  .st-lunch{background:#ef4444}
  .st-training{background:#8b5cf6}
  .st-meeting{background:#ec4899}
  .st-offline{background:#6b7280}

  /* status button style */
  .status-btns{display:flex;flex-wrap:wrap;gap:8px}
  .status-btn{border:1px solid var(--line);background:#0b1426;color:var(--text);cursor:pointer;border-radius:10px;padding:10px 12px;display:flex;align-items:center;gap:8px}
  .dot{width:10px;height:10px;border-radius:50%}
  .status-btn.active{outline:2px solid var(--brand)}

  .bar-wrap{position:relative;border-radius:12px;border:1px solid var(--line);background:#0b1426;overflow:hidden;height:28px}
  .bar-layer{position:absolute;top:0;left:0;height:100%;display:flex}
  .seg{height:100%}
  .seg.red{background:linear-gradient(45deg,#ef4444 25%,#991b1b 25% 50%,#ef4444 50% 75%,#991b1b 75%);background-size:16px 16px;opacity:.75}
  .now-pin{position:absolute;top:0;bottom:0;width:2px;background:#fff;opacity:.7}

  .mini{font-size:12px}
  .list{display:grid;gap:8px}
  .list-row{display:flex;gap:10px;align-items:center}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b1426;border:1px solid var(--line);border-radius:6px;padding:2px 6px;color:var(--muted);font-size:12px}

  /* Table */
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
  th{color:var(--muted);font-weight:600}
  tr:hover td{background:#0b1426}

  @media (max-width:760px){
    .row.stack{flex-direction:column;align-items:flex-start}
  }
</style>
</head>
<body>
  <div id="error" class="error-banner container"></div>

  <div class="header">
    <div class="header-inner container">
      <div class="title brand">ALLSTAR</div>
      <div class="title">Allstar Agent Adherence</div>
      <div id="top-meta" class="muted right">…</div>
      <button id="viewAsAgent" class="btn small">View as Agent</button>
      <a class="btn small" href="/hub">Back to Hub</a>
    </div>
  </div>

  <div class="container grid" style="padding:16px 0 28px">
    <div id="agentView" class="card" style="display:none">
      <div class="row stack">
        <div class="grow">
          <h2 style="margin:0 0 6px">Today</h2>
          <div class="muted mini" id="dateLabel"></div>
        </div>
        <div class="row" style="gap:16px">
          <div>
            <div class="muted mini">Adherence</div>
            <div id="adhPct" style="font-weight:800;font-size:20px">--%</div>
          </div>
          <div>
            <div class="muted mini">In</div>
            <div id="adhIn" class="mini">--</div>
          </div>
          <div>
            <div class="muted mini">Out</div>
            <div id="adhOut" class="mini">--</div>
          </div>
        </div>
      </div>

      <div class="grid">
        <div>
          <div class="row" style="margin:6px 0 6px">
            <div class="mini pill">Projected</div>
            <div class="right mini muted" id="schedSummary"></div>
          </div>
          <div id="projBar" class="bar-wrap" title="Projected schedule"></div>
        </div>
        <div>
          <div class="row" style="margin:6px 0 6px">
            <div class="mini pill">Actual</div>
            <div class="right mini muted" id="actualSummary"></div>
          </div>
          <div id="actualBar" class="bar-wrap" title="Actual activity"></div>
        </div>
      </div>

      <div class="row" style="margin-top:14px">
        <div class="grow">
          <div class="muted mini" style="margin-bottom:8px">Set your current status</div>
          <div id="statusBtns" class="status-btns"></div>
        </div>
        <div style="min-width:260px">
          <div class="muted mini" style="margin-bottom:8px">Recent switches</div>
          <div id="recent" class="list mini muted"></div>
        </div>
      </div>
    </div>

    <div id="adminView" class="card" style="display:none">
      <div class="row wrap">
        <div class="tabs">
          <button data-tab="schedule" class="tab active">Schedule</button>
          <button data-tab="live" class="tab">Live Status</button>
          <button data-tab="history" class="tab">History</button>
        </div>
        <div class="right row wrap">
          <button id="dlEvents" class="btn small">Download Events CSV</button>
          <button id="dlSchedules" class="btn small">Download Schedules CSV</button>
          <button id="dlAdh" class="btn small">Download Adherence CSV</button>
        </div>
      </div>

      <!-- SCHEDULE TAB -->
      <div id="tab-schedule" class="grid">
        <div class="row wrap">
          <div>
            <div class="muted mini">Agent</div>
            <select id="schUser" class="btn small" style="min-width:220px"></select>
          </div>
          <div>
            <div class="muted mini">Date</div>
            <input id="schDate" class="btn small" type="date">
          </div>
          <div class="right">
            <button id="schSave" class="btn primary">Save to Server</button>
          </div>
        </div>

        <div class="grid">
          <div class="muted mini">Blocks</div>
          <div id="schBlocks" class="list"></div>
          <div>
            <button id="addBlock" class="btn small">Add block</button>
          </div>
        </div>

        <div class="grid">
          <div class="muted mini">Projected vs Actual (for selected day)</div>
          <div id="schedCompare" class="grid">
            <div class="bar-wrap" id="schedProj"></div>
            <div class="bar-wrap" id="schedActual"></div>
          </div>
        </div>
      </div>

      <!-- LIVE TAB -->
      <div id="tab-live" style="display:none">
        <div class="muted mini" style="margin-bottom:8px">Live Agent Status — <span id="liveDate">Today</span></div>
        <div id="liveGrid" class="grid"></div>
      </div>

      <!-- HISTORY TAB -->
      <div id="tab-history" style="display:none">
        <div class="row wrap">
          <div>
            <div class="muted mini">Agent</div>
            <select id="histUser" class="btn small" style="min-width:220px"></select>
          </div>
          <div>
            <div class="muted mini">From</div>
            <input id="histFrom" class="btn small" type="date">
          </div>
          <div>
            <div class="muted mini">To</div>
            <input id="histTo" class="btn small" type="date">
          </div>
          <div class="right">
            <button id="histRun" class="btn">Run</button>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <table>
            <thead><tr><th>Date</th><th>Adherence %</th><th>In</th><th>Out</th></tr></thead>
            <tbody id="histTable"></tbody>
          </table>
        </div>

        <div class="card" style="margin-top:14px">
          <div class="muted mini" style="margin-bottom:6px">IMED-style timeline</div>
          <div id="imed" class="list mini"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =======================
   CONFIG & STATUS MODEL
   ======================= */
const API = "/api";
const STATUSES = [
  { key:'available', label:'Available', color:'st-available' },
  { key:'bathroom',  label:'Bathroom',  color:'st-bathroom'  },
  { key:'break',     label:'Break',     color:'st-break'     },
  { key:'lunch',     label:'Lunch',     color:'st-lunch'     },
  { key:'training',  label:'Training',  color:'st-training'  },
  { key:'meeting',   label:'Meeting',   color:'st-meeting'   },
  { key:'offline',   label:'Offline',   color:'st-offline'   },
];
const STATUS_BY_KEY = Object.fromEntries(STATUSES.map(s=>[s.key,s]));

/* =======================
   UTILITIES
   ======================= */
const qs=(s,e)=> (e||document).querySelector(s);
const qsa=(s,e)=> [...(e||document).querySelectorAll(s)];
const el=(t,a,...c)=>{const n=document.createElement(t);if(a){for(const k in a){k==='class'?n.className=a[k]:k==='style'?Object.assign(n.style,a[k]):n.setAttribute(k,a[k])}} c.flat().forEach(x=>n.appendChild(x?.nodeType?x:document.createTextNode(String(x))));return n};
const fmtTime=(d)=> new Date(d).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
const fmtHM=(mins)=>`${Math.floor(mins/60)}h ${Math.round(mins%60)}m`;
const ymd=(d)=> new Date(d).toISOString().slice(0,10);
const startOfDay=(d)=> {const x=new Date(d); x.setHours(0,0,0,0); return x};
const endOfDay=(d)=> {const x=new Date(d); x.setHours(23,59,59,999); return x};
const clamp=(v,a,b)=> Math.max(a,Math.min(b,v));

function showError(m){const e=qs('#error'); e.style.display='block'; e.textContent='⚠️ '+m; console.error('[Adherence]',m)}

/* =======================
   API HELPERS
   ======================= */
async function apiGet(path){ const r=await fetch(API+path); if(!r.ok) throw new Error(`GET ${path} ${r.status}`); return r.json(); }
async function apiPost(path,body){ const r=await fetch(API+path,{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(body)}); const j=await r.json().catch(()=>({})); if(!r.ok||j.error) throw new Error(j.error||`POST ${path} ${r.status}`); return j; }

async function me(){ const r=await fetch(API+'/whoami'); if(!r.ok) return null; const j=await r.json().catch(()=>null); return j?.ok?j.user:null; }
async function listUsers(){
  try{ const j=await apiGet('/users'); return j?.users||j||[] }
  catch{ return [] }
}

async function getSchedule(username, date){ return apiGet(`/schedules?${new URLSearchParams({user:username,date})}`) }
async function saveSchedule(username, date, blocks){ return apiPost('/schedules',{username,date,blocks}) }
async function postEvent(status, ts){ return apiPost('/events', ts?{status,ts}:{status}) }
async function listEvents(username, fromISO, toISO){
  const p=new URLSearchParams({user:username,from:fromISO,to:toISO});
  return apiGet('/events?'+p.toString());
}

/* =======================
   ADHERENCE MATH
   ======================= */
/* Normalize schedule blocks to [{t0,t1,status}] where t0/t1 are ms since day start */
function normalizeSchedule(dayDate, blocks){
  const day0=startOfDay(dayDate).getTime();
  return (blocks||[]).map(b=>{
    const [h0,m0]=String(b.start||b.t0||'00:00').split(':').map(Number);
    const [h1,m1]=String(b.end||b.t1||'00:00').split(':').map(Number);
    const t0 = day0 + ((h0*60+m0)*60*1000);
    const t1 = day0 + ((h1*60+m1)*60*1000);
    return {t0,t1,status:(b.status||b.type||'available').toLowerCase()};
  }).filter(b=>b.t1>b.t0);
}

/* Build actual segments from events for the day */
function actualFromEvents(dayDate, events, now=new Date()){
  const day0=startOfDay(dayDate).getTime();
  const day1=endOfDay(dayDate).getTime();
  const e = (events||[])
    .filter(x=>x && x.status)
    .map(x=> ({t:new Date(x.ts||x.time||x.createdAt||x.t).getTime(), status:String(x.status).toLowerCase()}))
    .filter(x=>x.t>=day0 && x.t<=day1)
    .sort((a,b)=>a.t-b.t);

  const segs=[];
  let prevT=day0;
  let prevStatus='offline';
  if(e.length){ prevStatus=e[0].status; prevT=e[0].t; segs.push({t0:day0,t1:e[0].t,status:'offline'}); }
  for(let i=0;i<e.length;i++){
    const cur=e[i];
    if(i>0){ segs.push({t0:e[i-1].t, t1:cur.t, status:e[i-1].status}); }
  }
  const last=e[e.length-1];
  const tNow = clamp(now.getTime(), day0, day1);
  if(last){
    segs.push({t0:last.t, t1:tNow, status:last.status});
  }else{
    segs.push({t0:day0, t1:tNow, status:'offline'});
  }
  return segs.filter(s=>s.t1>s.t0);
}

/* Overlap minutes by equality of status */
function overlapMinutes(a,b){
  const t0=Math.max(a.t0,b.t0), t1=Math.min(a.t1,b.t1);
  return t1>t0? (t1-t0)/60000 : 0;
}

/* Compute adherence totals comparing projected vs actual */
function computeAdherence(proj, actual){
  let inMin=0, outMin=0, total=0;
  for(const pa of proj){
    for(const ac of actual){
      const ov=overlapMinutes(pa,ac);
      if(!ov) continue;
      total+=ov;
      if(pa.status===ac.status) inMin+=ov; else outMin+=ov;
    }
  }
  const pct = total>0 ? (inMin/total*100) : 0;
  return {inMin,outMin,total,pct};
}

/* =======================
   RENDER: BARS
   ======================= */
function renderBar(elWrap, segments, dayDate, highlightMismatchesWith, now=new Date()){
  elWrap.innerHTML='';
  const day0=startOfDay(dayDate).getTime();
  const day1=endOfDay(dayDate).getTime();
  const total=day1-day0;

  const base = el('div',{class:'bar-layer'});
  const mis  = el('div',{class:'bar-layer'});

  segments.forEach(s=>{
    const w=((s.t1-s.t0)/total)*100;
    const left=((s.t0-day0)/total)*100;
    const seg=el('div',{class:'seg '+(STATUS_BY_KEY[s.status]?.color||''),style:{width:w+'%',marginLeft:left+'%'}});
    base.appendChild(seg);
  });

  // mismatches overlay
  if(highlightMismatchesWith){
    const A=segments, B=highlightMismatchesWith;
    for(const a of A) for(const b of B){
      const t0=Math.max(a.t0,b.t0), t1=Math.min(a.t1,b.t1);
      if(t1<=t0) continue;
      if(a.status!==b.status){
        const w=((t1-t0)/total)*100;
        const left=((t0-day0)/total)*100;
        mis.appendChild(el('div',{class:'seg red',style:{width:w+'%',marginLeft:left+'%'}}));
      }
    }
  }

  // now pin
  const tNow = clamp(now.getTime(), day0, day1);
  const leftNow=((tNow-day0)/total)*100;
  const pin=el('div',{class:'now-pin',style:{left:leftNow+'%'}});

  elWrap.append(base,mis,pin);
}

/* =======================
   RENDER: AGENT VIEW
   ======================= */
function renderStatusButtons(root, current){
  root.innerHTML='';
  STATUSES.forEach(s=>{
    const b=el('button',{class:'status-btn '+(current===s.key?'active':''), 'data-st':s.key},
      el('span',{class:'dot '+s.color}), s.label
    );
    root.appendChild(b);
  });
}

function renderRecent(root, events){
  root.innerHTML='';
  const items = (events||[]).slice(-6).reverse();
  items.forEach(ev=>{
    const t = new Date(ev.ts||ev.time||ev.createdAt||ev.t);
    const st = STATUS_BY_KEY[String(ev.status).toLowerCase()]?.label || ev.status;
    root.appendChild(
      el('div',{class:'list-row'},
        el('span',{class:'kbd'}, t.toLocaleTimeString()),
        el('span',{}, st)
      )
    );
  });
}

/* =======================
   ADMIN: SCHEDULE EDITOR
   ======================= */
function blockRow(b,i,dayDate,onChange,onDelete){
  const r=el('div',{class:'row wrap',style:'gap:10px'});
  const s=el('input',{type:'time',value:b.start||'09:00',class:'btn small'});
  const e=el('input',{type:'time',value:b.end||'17:00',class:'btn small'});
  const sel=el('select',{class:'btn small'},
    ...STATUSES.map(st=> el('option',{value:st.key,selected:(b.status===st.key)}, st.label))
  );
  const del=el('button',{class:'btn small danger'},'Delete');
  [s,e,sel].forEach(x=> x.addEventListener('change',()=>onChange(i,{start:s.value,end:e.value,status:sel.value})));
  del.onclick=()=>onDelete(i);
  r.append(el('span',{class:'pill'},'#'+(i+1)), s, e, sel, del);
  return r;
}

/* =======================
   CSV DOWNLOADS (client side)
   ======================= */
function toCSV(rows){
  return rows.map(r=>r.map(v=>{
    if(v==null) return '';
    const s=String(v).replace(/"/g,'""');
    return /[",\n]/.test(s) ? `"${s}"` : s;
  }).join(',')).join('\n');
}
function saveCSV(filename, csv){
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=filename; a.click();
  setTimeout(()=>URL.revokeObjectURL(url),5000);
}

/* =======================
   BOOTSTRAP
   ======================= */
(async function main(){
  const user = await me();
  if(!user){ location.replace('/'); return; }
  qs('#top-meta').textContent = `${user.username} · ${user.role}`;
  qs('#dateLabel').textContent = new Date().toLocaleDateString();

  // Role toggle + View-as-agent
  const isAdmin = /ADMIN/i.test(user.role||'');
  let forceAgentView = false;
  const toggleView = ()=>{
    const agentOn = !isAdmin || forceAgentView;
    qs('#agentView').style.display = agentOn ? '' : 'none';
    qs('#adminView').style.display = (!agentOn) ? '' : 'none';
    qs('#viewAsAgent').textContent = agentOn ? 'View Admin' : 'View as Agent';
  };
  qs('#viewAsAgent').onclick = ()=>{ if(isAdmin){ forceAgentView = !forceAgentView; toggleView(); } };
  toggleView();

  /* ===== Agent view state ===== */
  const day = new Date();
  const dayISO = ymd(day);
  let schedule = [];
  let events = [];
  let actualSegs = [];
  let projSegs = [];
  let currentStatus = 'offline';

  // Load schedule/events for agent
  async function loadAgentData(){
    try{
      const sch = await getSchedule(user.username, dayISO).catch(()=>({blocks:[]}));
      schedule = normalizeSchedule(day, sch.blocks||sch||[]);
      projSegs = schedule;
    }catch(e){ showError('Failed to load schedule'); }

    try{
      const from = startOfDay(day).toISOString();
      const to = endOfDay(day).toISOString();
      const ev = await listEvents(user.username, from, to).catch(()=>({events:[]}));
      events = ev.events || ev || [];
      actualSegs = actualFromEvents(day, events, new Date());
      const last = events[events.length-1];
      currentStatus = (last?.status||'offline').toLowerCase();
    }catch(e){ showError('Failed to load events'); }
  }

  function updateAgentUI(){
    // render bars
    actualSegs = actualFromEvents(day, events, new Date());
    renderBar(qs('#projBar'), projSegs, day, null, new Date());
    renderBar(qs('#actualBar'), actualSegs, day, projSegs, new Date());

    // adherence numbers
    const {inMin,outMin,pct} = computeAdherence(projSegs, actualSegs);
    qs('#adhPct').textContent = `${pct.toFixed(1)}%`;
    qs('#adhIn').textContent = fmtHM(inMin);
    qs('#adhOut').textContent = fmtHM(outMin);

    // summaries
    const projTotal = projSegs.reduce((s,x)=>s+(x.t1-x.t0),0)/60000;
    const actTotal  = actualSegs.reduce((s,x)=>s+(x.t1-x.t0),0)/60000;
    qs('#schedSummary').textContent = `Projected: ${fmtHM(projTotal)}`;
    qs('#actualSummary').textContent = `Actual: ${fmtHM(actTotal)}`;

    // status buttons + recent
    renderStatusButtons(qs('#statusBtns'), currentStatus);
    renderRecent(qs('#recent'), events);
  }

  async function pushStatus(st){
    try{
      await postEvent(st);
      // keep local echo
      events.push({ts:new Date().toISOString(), status:st});
      currentStatus = st;
      updateAgentUI();
    }catch(e){ showError('Failed to post status'); }
  }

  // Wire buttons
  qs('#statusBtns').addEventListener('click', (ev)=>{
    const b = ev.target.closest('[data-st]'); if(!b) return;
    pushStatus(b.getAttribute('data-st'));
  });

  // Initial load + realtime ticker
  await loadAgentData();
  updateAgentUI();
  setInterval(updateAgentUI, 1000);

  /* ===== Admin view (if applicable) ===== */
  if(isAdmin && !forceAgentView){
    const tabs = qsa('.tab'); const views = {schedule:qs('#tab-schedule'), live:qs('#tab-live'), history:qs('#tab-history')};
    let agents = await listUsers().catch(()=>[]);
    if(!Array.isArray(agents)||!agents.length) agents=[{username:user.username, role:user.role}];
    const agentNames = agents.map(u=>u.username);

    // Populate selects
    const selUser = qs('#schUser'), histUser = qs('#histUser');
    selUser.innerHTML = agentNames.map(n=>`<option>${n}</option>`).join('');
    histUser.innerHTML = selUser.innerHTML;
    qs('#schDate').value = dayISO;
    qs('#histFrom').value = ymd(new Date(day.getFullYear(), day.getMonth(), 1));
    qs('#histTo').value   = ymd(new Date(day.getFullYear(), day.getMonth()+1, 0));
    qs('#liveDate').textContent = new Date().toLocaleDateString();

    function switchTab(name){
      tabs.forEach(t=>t.classList.toggle('active', t.dataset.tab===name));
      Object.keys(views).forEach(k=> views[k].style.display = (k===name?'':'none'));
    }
    tabs.forEach(t=> t.onclick=()=>switchTab(t.dataset.tab));

    /* --- Schedule editor --- */
    let editBlocks = [];

    async function loadScheduleEditor(){
      const u=selUser.value, d=qs('#schDate').value;
      const sch = await getSchedule(u,d).catch(()=>({blocks:[]}));
      editBlocks = (sch.blocks||sch||[]).map(b=>({start:b.start||'09:00', end:b.end||'17:00', status:(b.status||'available').toLowerCase()}));
      drawBlocks();
      await compareDay(u,d);
    }

    function drawBlocks(){
      const host=qs('#schBlocks'); host.innerHTML='';
      editBlocks.forEach((b,i)=>{
        host.appendChild(
          blockRow(b,i,day,(idx,val)=>{ editBlocks[idx]=val; }, (idx)=>{ editBlocks.splice(idx,1); drawBlocks(); })
        );
      });
    }
    qs('#addBlock').onclick=()=>{ editBlocks.push({start:'09:00',end:'10:00',status:'available'}); drawBlocks(); };

    qs('#schSave').onclick=async ()=>{
      try{
        await saveSchedule(selUser.value, qs('#schDate').value, editBlocks);
        await compareDay(selUser.value, qs('#schDate').value);
      }catch(e){ showError('Save failed: '+e.message); }
    };

    async function compareDay(username, dISO){
      const proj = normalizeSchedule(new Date(dISO), editBlocks);
      const from = startOfDay(new Date(dISO)).toISOString();
      const to = endOfDay(new Date(dISO)).toISOString();
      const ev = await listEvents(username, from, to).catch(()=>({events:[]}));
      const actSegs = actualFromEvents(new Date(dISO), ev.events||ev||[], endOfDay(new Date(dISO)));
      renderBar(qs('#schedProj'), proj, new Date(dISO), null, endOfDay(new Date(dISO)));
      renderBar(qs('#schedActual'), actSegs, new Date(dISO), proj, endOfDay(new Date(dISO)));
    }

    selUser.onchange=loadScheduleEditor;
    qs('#schDate').onchange=loadScheduleEditor;
    await loadScheduleEditor();

    /* --- Live status --- */
    async function paintLive(){
      const host=qs('#liveGrid'); host.innerHTML='';
      const todayFrom = startOfDay(new Date()).toISOString();
      const todayTo   = endOfDay(new Date()).toISOString();
      for(const uname of agentNames){
        let evs=[];
        try{ const r=await listEvents(uname,todayFrom,todayTo); evs=r.events||r||[] }catch{}
        const last=evs[evs.length-1];
        const since = last ? Math.max(0, (Date.now()-new Date(last.ts||last.time||last.createdAt).getTime())/60000) : 0;
        const label = STATUS_BY_KEY[String(last?.status||'offline').toLowerCase()]?.label || (last?.status||'Offline');

        const row = el('div',{class:'card'},
          el('div',{class:'row wrap'},
            el('div',{}, el('strong',{}, uname)),
            el('div',{class:'pill'}, label),
            el('div',{class:'muted mini'}, since?`for ${fmtHM(since)}`:'')
          )
        );
        host.appendChild(row);
      }
    }
    await paintLive();
    setInterval(paintLive, 15000);

    /* --- History --- */
    async function runHistory(){
      const uname=histUser.value;
      const fromD=new Date(qs('#histFrom').value);
      const toD=new Date(qs('#histTo').value);
      const tbody=qs('#histTable'); tbody.innerHTML='';

      const rows=[];
      for(let d=new Date(fromD); d<=toD; d.setDate(d.getDate()+1)){
        const dISO=ymd(d);
        let sch = await getSchedule(uname, dISO).catch(()=>({blocks:[]}));
        const proj=normalizeSchedule(new Date(d), sch.blocks||sch||[]);

        const ev = await listEvents(uname, startOfDay(d).toISOString(), endOfDay(d).toISOString()).catch(()=>({events:[]}));
        const act=actualFromEvents(new Date(d), ev.events||ev||[], endOfDay(d));

        const a=computeAdherence(proj,act);
        rows.push({date:dISO, pct:a.pct, in:a.inMin, out:a.outMin});
        const tr=el('tr',{}, el('td',{}, dISO), el('td',{}, a.pct.toFixed(1)+'%'), el('td',{}, fmtHM(a.inMin)), el('td',{}, fmtHM(a.outMin)));
        tbody.appendChild(tr);
      }

      // IMED
      const histDay = endOfDay(new Date(qs('#histTo').value));
      const histEv = await listEvents(uname, startOfDay(histDay).toISOString(), histDay.toISOString()).catch(()=>({events:[]}));
      const lines = (histEv.events||histEv||[]).map((e,i,arr)=>{
        const t=new Date(e.ts||e.time||e.createdAt);
        const next=arr[i+1]? new Date(arr[i+1].ts||arr[i+1].time||arr[i+1].createdAt): null;
        const dur = next ? Math.max(0,(next-t)/60000) : 0;
        const label = STATUS_BY_KEY[String(e.status).toLowerCase()]?.label || e.status;
        return `${t.toLocaleTimeString()}  ${label}${dur?`  ${Math.round(dur)}m`:''}`;
      });
      const imed=qs('#imed'); imed.innerHTML='';
      lines.forEach(s=> imed.appendChild(el('div',{}, s)));

      return rows;
    }
    qs('#histRun').onclick=runHistory;

    /* --- CSV buttons (month scope) --- */
    async function monthSpan(){
      const n=new Date(); const from=new Date(n.getFullYear(),n.getMonth(),1);
      const to=new Date(n.getFullYear(),n.getMonth()+1,0,23,59,59,999);
      return {from, to, fromISO:from.toISOString(), toISO:to.toISOString()};
    }

    qs('#dlEvents').onclick = async ()=>{
      const {fromISO,toISO}=await monthSpan();
      const all=[];
      for(const u of agentNames){
        let rows=[];
        try{
          const r=await listEvents(u,fromISO,toISO); const evs=r.events||r||[];
          rows = evs.map(e=>[u, e.status, e.ts||e.time||e.createdAt]);
        }catch{}
        all.push(...rows);
      }
      saveCSV(`events_${ymd(new Date())}.csv`, toCSV([['user','status','timestamp'], ...all]));
    };

    qs('#dlSchedules').onclick = async ()=>{
      const {from,to}=await monthSpan();
      const all=[];
      for(const u of agentNames){
        for(let d=new Date(from); d<=to; d.setDate(d.getDate()+1)){
          try{
            const sch=await getSchedule(u, ymd(d)); const blocks=(sch.blocks||sch||[]);
            blocks.forEach(b=> all.push([u, ymd(d), b.start, b.end, b.status]));
          }catch{}
        }
      }
      saveCSV(`schedules_${ymd(new Date())}.csv`, toCSV([['user','date','start','end','status'], ...all]));
    };

    qs('#dlAdh').onclick = async ()=>{
      const {from,to}=await monthSpan();
      const all=[['user','date','pct','in_min','out_min']];
      for(const u of agentNames){
        for(let d=new Date(from); d<=to; d.setDate(d.getDate()+1)){
          try{
            const sch=await getSchedule(u, ymd(d)).catch(()=>({blocks:[]}));
            const proj=normalizeSchedule(new Date(d),(sch.blocks||sch||[]));
            const ev=await listEvents(u,startOfDay(d).toISOString(),endOfDay(d).toISOString()).catch(()=>({events:[]}));
            const act=actualFromEvents(new Date(d), ev.events||ev||[], endOfDay(d));
            const a=computeAdherence(proj,act);
            all.push([u, ymd(d), a.pct.toFixed(2), Math.round(a.inMin), Math.round(a.outMin)]);
          }catch{}
        }
      }
      saveCSV(`adherence_${ymd(new Date())}.csv`, toCSV(all));
    };

    // default tab
    switchTab('schedule');
  }
})();
</script>
</body>
</html>
