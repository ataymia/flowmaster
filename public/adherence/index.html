<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Allstar — Schedule & Adherence</title>
  <style>
    :root{
      --brand:#e11d48; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb; --bg:#fff;
      --card:#fff; --shadow:0 10px 25px rgba(17,24,39,.08); --radius:16px;

      /* Clear, distinct status colors */
      --st-available:#10b981;
      --st-bathroom:#d97706;
      --st-break:#f59e0b;
      --st-lunch:#ea580c;
      --st-training:#8b5cf6;
      --st-meeting:#3b82f6;
      --st-offline:#9ca3af;

      --diff:#ef4444;   /* mismatch overlay */
      --grid:#f3f4f6;
    }
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
    .container{max-width:1100px;margin:0 auto;padding:18px}
    .header{position:sticky;top:0;z-index:10;backdrop-filter:blur(6px);background:rgba(255,255,255,.9);border-bottom:1px solid var(--line)}
    .header-inner{display:flex;align-items:center;gap:12px;padding:12px 16px}
    .title{font-weight:800;letter-spacing:.2px}
    .muted{color:var(--muted)}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer;box-shadow:var(--shadow)}
    .btn:hover{background:#fafafa}
    .btn-brand{border-color:transparent;background:var(--brand);color:#fff}
    .btn-row{display:flex;flex-wrap:wrap;gap:8px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
    .grid{display:grid;gap:16px}
    .grid-2{grid-template-columns: 1fr 1fr}
    .field{display:block;width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:10px}
    .label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
    .tabs{display:flex;border-bottom:1px solid var(--line);gap:6px;margin-bottom:12px}
    .tab{padding:8px 12px;border:1px solid var(--line);border-bottom:0;border-radius:10px 10px 0 0;background:#fff;cursor:pointer}
    .tab.active{background:#fdf2f8;border-color:#fecdd3}
    .kpi{display:flex;align-items:baseline;gap:10px}
    .kpi .big{font-size:30px;font-weight:800}
    .pill{display:inline-flex;align-items:center;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px}
    .timeline-wrap{position:relative;margin-top:6px}
    .row{display:flex;align-items:center;gap:10px;margin:6px 0}
    .rowlabel{font-size:12px;color:#6b7280;width:7rem}
    .gridbar{height:20px;border-radius:8px;overflow:hidden;position:relative;background:var(--grid)}
    .seg{height:100%;display:inline-block;position:relative}
    .seg.diff::after{content:"";position:absolute;inset:0;background:rgba(239,68,68,0.35)}
    .nowline{position:absolute;top:-4px;bottom:-4px;width:2px;background:#111827}
    .scroll{max-height:260px;overflow:auto;border:1px solid var(--line);border-radius:10px;padding:8px}
    .row-between{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .error{position:fixed;left:0;right:0;bottom:0;background:#fee2e2;color:#991b1b;border-top:1px solid #fecaca;padding:10px 14px;display:none}
    .status-btn{color:#fff;border:0}
    .st-available{background:var(--st-available)}
    .st-bathroom{background:var(--st-bathroom)}
    .st-break{background:var(--st-break)}
    .st-lunch{background:var(--st-lunch)}
    .st-training{background:var(--st-training)}
    .st-meeting{background:var(--st-meeting)}
    .st-offline{background:var(--st-offline)}
    .small{font-size:12px}
    @media (max-width: 920px){ .grid-2{grid-template-columns:1fr} }
    dialog{border:1px solid var(--line);border-radius:12px;padding:0;max-width:420px;width:calc(100% - 24px)}
    dialog .dlg-head{padding:12px 16px;border-bottom:1px solid var(--line);font-weight:700}
    dialog .dlg-body{padding:12px 16px}
    dialog .dlg-foot{padding:12px 16px;border-top:1px solid var(--line);display:flex;justify-content:flex-end;gap:8px}
  </style>
</head>
<body>
  <div class="header">
    <div class="header-inner">
      <div class="title">Allstar — Schedule & Adherence</div>
      <div id="hdr-meta" class="muted" style="margin-left:auto">Not signed in</div>
      <button id="btn-change" class="btn">Change Password</button>
      <button id="btn-logout" class="btn">Logout</button>
    </div>
  </div>

  <div class="container">
    <div class="tabs">
      <div id="tab-agent"  class="tab active">Agent View</div>
      <div id="tab-admin"  class="tab">Admin Tools</div>
    </div>

    <!-- ===== Agent Pane ===== -->
    <div id="pane-agent">
      <div class="card">
        <div class="row-between">
          <h2 style="margin:0">Today</h2>
          <div class="pill" id="agent-date"></div>
        </div>

        <div class="timeline-wrap" id="agent-bars"></div>

        <div class="row" style="margin-top:10px">
          <div class="kpi">
            <div class="big" id="agent-pct">100%</div>
            <div class="muted" id="agent-io">in: 0m · out: 0m</div>
          </div>
          <div style="margin-left:auto" class="pill" id="agent-current">—</div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">Set Status</h3>
        <div class="btn-row" id="agent-status-buttons"></div>
        <div style="margin-top:14px">
          <h4 style="margin:0 0 6px 0">Recent switches</h4>
          <div class="scroll" id="agent-recent">—</div>
        </div>
      </div>
    </div>

    <!-- ===== Admin Pane ===== -->
    <div id="pane-admin" style="display:none">
      <div class="card">
        <div class="row" style="flex-wrap:wrap;gap:12px;align-items:flex-end">
          <div>
            <label class="label">Agent</label>
            <select id="selUser" class="field" style="min-width:220px"></select>
          </div>
          <div>
            <label class="label">Date</label>
            <input id="day" type="date" class="field"/>
          </div>
          <div class="btn-row" style="margin-left:auto">
            <button id="addBlock"  class="btn btn-brand">+ Block</button>
            <button id="saveSched" class="btn" disabled>Save to Server</button>
          </div>
        </div>

        <div class="grid grid-2" style="margin-top:12px">
          <!-- Schedule editor -->
          <div>
            <h3 style="margin:6px 0">Schedule Blocks</h3>
            <div id="blocks"></div>
          </div>

          <!-- Daily overview -->
          <div>
            <div class="row-between">
              <h3 style="margin:6px 0">Daily Overview</h3>
              <div class="pill" id="admin-current">—</div>
            </div>
            <div id="admin-bars" class="timeline-wrap"></div>
            <div class="muted" id="admin-pct" style="margin-top:8px">Adherence: —</div>
            <div style="margin-top:10px">
              <h4 style="margin:0 0 6px 0">AUX breakdown</h4>
              <ul id="byStatus" style="margin:0;padding-left:18px"></ul>
            </div>
            <div style="margin-top:10px">
              <h4 style="margin:0 0 6px 0">Timeline (IMED-style)</h4>
              <div id="imed" class="scroll"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">Downloads</h3>
        <div class="btn-row" style="margin-bottom:10px">
          <button class="btn pill" data-range="today">Today</button>
          <button class="btn pill" data-range="thisweek">This Week</button>
          <button class="btn pill" data-range="last7">Last 7 Days</button>
        </div>
        <div class="row" style="gap:10px;flex-wrap:wrap">
          <div><label class="label">From</label><input id="from" type="date" class="field"></div>
          <div><label class="label">To</label><input id="to" type="date" class="field"></div>
          <div style="align-self:flex-end" class="btn-row">
            <button id="dle" class="btn">Download Events</button>
            <button id="dls" class="btn">Download Schedules</button>
            <button id="dla" class="btn">Download Adherence</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">Users</h3>
        <div class="row" style="gap:8px;flex-wrap:wrap;align-items:flex-end;margin-bottom:10px">
          <input id="newU" class="field" placeholder="Username or Email" style="max-width:240px">
          <input id="newP" class="field" type="password" placeholder="Temp password" value="Welcome123" style="max-width:180px">
          <select id="newR" class="field" style="max-width:160px">
            <option value="AGENT">AGENT</option>
            <option value="ADMIN">ADMIN</option>
          </select>
          <button id="createU" class="btn btn-brand">Create</button>
        </div>
        <div id="usersTblWrap"></div>
      </div>
    </div>
  </div>

  <!-- Change Password dialog -->
  <dialog id="pwDlg">
    <div class="dlg-head">Change Password</div>
    <div class="dlg-body">
      <label class="label">Current password</label>
      <input id="curPw" class="field" type="password" autocomplete="current-password">

      <label class="label" style="margin-top:8px">New password</label>
      <div style="display:flex;gap:8px">
        <input id="newPw" class="field" type="password" autocomplete="new-password" style="flex:1">
        <button id="togglePw" class="btn" type="button">Show</button>
      </div>
    </div>
    <div class="dlg-foot">
      <button id="pwCancel" class="btn" type="button">Cancel</button>
      <button id="pwSave"   class="btn btn-brand" type="button">Save</button>
    </div>
  </dialog>

  <div id="error" class="error"></div>

<script>
/* ======= CONFIG / STATUS MAP ======= */
const STATUS_LIST = [
  { key:'available', label:'Available', css:'st-available' },
  { key:'bathroom',  label:'Bathroom', css:'st-bathroom'  },
  { key:'break',     label:'Break',    css:'st-break'     },
  { key:'lunch',     label:'Lunch',    css:'st-lunch'     },
  { key:'training',  label:'Training', css:'st-training'  },
  { key:'meeting',   label:'Meeting',  css:'st-meeting'   },
  { key:'offline',   label:'Offline',  css:'st-offline'   },
];

const API = {
  whoami:   ()=>fetch('/api/whoami',{credentials:'include',cache:'no-store'}).then(r=>r.json()),
  listUsers:()=>fetch('/api/users',{credentials:'include'}).then(r=>r.ok?r.json():[]),
  createUser:(username,password,role)=>fetch('/api/users',{method:'POST',headers:{'content-type':'application/json'},credentials:'include',body:JSON.stringify({username,password,role})}).then(r=>r.json()),
  patchUser:(id,patch)=>fetch('/api/users/'+id,{method:'PATCH',headers:{'content-type':'application/json'},credentials:'include',body:JSON.stringify(patch)}).then(r=>r.json()),
  deleteUser:(id)=>fetch('/api/users/'+id,{method:'DELETE',credentials:'include'}),
  getSchedule:(user,date)=>fetch('/api/schedules?'+new URLSearchParams({user,date}),{credentials:'include'}).then(r=>r.json()),
  saveSchedule:(user,date,blocks)=>fetch('/api/schedules',{method:'POST',headers:{'content-type':'application/json'},credentials:'include',body:JSON.stringify({username:user,date,blocks})}).then(r=>r.json()),
  postEvent:(status,ts)=>fetch('/api/events',{method:'POST',headers:{'content-type':'application/json'},credentials:'include',body:JSON.stringify(ts?{status,ts}:{status})}).then(r=>r.json()),
  listEvents:(user,from,to)=>fetch('/api/events?'+new URLSearchParams({user,from,to}),{credentials:'include'}).then(r=>r.json()),
  changePassword:(currentPassword,newPassword)=>fetch('/api/change-password',{method:'POST',headers:{'content-type':'application/json'},credentials:'include',body:JSON.stringify({currentPassword,newPassword})}),
  download:(kind,from,to)=>{ const a=document.createElement('a'); a.href='/api/export?kind='+encodeURIComponent(kind)+'&from='+(from||'')+'&to='+(to||''); a.click(); }
};

/* ======= UTIL ======= */
const pad=n=>String(n).padStart(2,'0');
const toISOdate=d=> (d instanceof Date?d:new Date(d)).toISOString().slice(0,10);
const hms=ms=>{ const s=Math.floor(ms/1000); const hh=Math.floor(s/3600), mm=Math.floor((s%3600)/60), ss=s%60; return `${pad(hh)}:${pad(mm)}:${pad(ss)}`; };
const label=(k)=> (STATUS_LIST.find(x=>x.key===k)?.label || k);
const cssOf=(k)=> (STATUS_LIST.find(x=>x.key===k)?.css || 'st-offline');

/* ======= STATE ======= */
let ME=null;
let AGENT={ date: toISOdate(new Date()), schedule:[], events:[] };
let ADMIN={ user:'', date: toISOdate(new Date()), schedule:[], events:[], users:[] };
let TICKERS=[];

function setError(s){ const e=document.getElementById('error'); if(!s){ e.style.display='none'; e.textContent=''; return; } e.textContent='⚠️ '+s; e.style.display='block'; }

/* ======= AUTH BOOT ======= */
(async function init(){
  try{
    const who=await API.whoami(); if(!who?.authed) return location.replace('/');
    ME = who.me || { username: who?.me?.username, role: who?.me?.role };
    document.getElementById('hdr-meta').textContent = `${ME.username} · ${ME.role}`;
  }catch(e){ return location.replace('/'); }

  const isAdmin = /^(ADMIN|SUPERADMIN)$/i.test(ME.role||'');
  document.getElementById('tab-admin').style.display = isAdmin ? 'block' : 'none';

  document.getElementById('tab-agent').onclick = ()=>showPane('agent');
  document.getElementById('tab-admin').onclick = ()=>showPane('admin');

  wirePasswordDialog();
  document.getElementById('btn-logout').onclick = ()=>{ document.cookie='access_token=; Path=/; Max-Age=0; Secure; SameSite=Lax'; document.cookie='refresh_token=; Path=/; Max-Age=0; Secure; SameSite=Lax'; location.assign('/'); };

  buildAgent();
  if(isAdmin) buildAdmin();

  showPane('agent');
})();

function showPane(which){
  clearTickers();
  document.getElementById('tab-agent').classList.toggle('active', which==='agent');
  document.getElementById('tab-admin').classList.toggle('active', which==='admin');
  document.getElementById('pane-agent').style.display = which==='agent' ? '' : 'none';
  document.getElementById('pane-admin').style.display = which==='admin' ? '' : 'none';
  if(which==='agent') startAgentLoops();
  if(which==='admin') startAdminLoops();
}
function clearTickers(){ TICKERS.forEach(clearInterval); TICKERS=[]; }

/* ======= AGENT VIEW ======= */
function buildAgent(){
  document.getElementById('agent-date').textContent = AGENT.date;
  const host=document.getElementById('agent-status-buttons'); host.innerHTML='';
  STATUS_LIST.forEach(s=>{
    const b=document.createElement('button');
    b.className='btn status-btn '+cssOf(s.key);
    b.textContent=s.label;
    b.onclick=()=> setAgentStatus(s.key);
    host.appendChild(b);
  });
}
async function setAgentStatus(status){
  try{
    await API.postEvent(status);
    AGENT.events.push({ status, ts: Date.now() });  // optimistic
    renderAgent();
  }catch(e){ setError('Failed to post status'); }
}
async function refreshAgentData(){
  try{
    const [sched, ev] = await Promise.all([
      API.getSchedule(ME.username, AGENT.date),
      API.listEvents(ME.username, AGENT.date, AGENT.date)
    ]);
    AGENT.schedule = sched?.blocks || [];
    AGENT.events   = Array.isArray(ev)? ev : [];
  }catch{}
}
function startAgentLoops(){
  refreshAgentData().then(renderAgent);
  TICKERS.push(setInterval(renderAgent, 1000));               // every second redraw
  TICKERS.push(setInterval(async ()=>{ await refreshAgentData(); renderAgent(); }, 15000)); // refresh data
}
function renderAgent(){
  // live timer
  const cur = AGENT.events.length ? AGENT.events[AGENT.events.length-1] : null;
  const curLabel = cur ? `${label(cur.status)} • ${hms(Date.now()-Number(cur.ts||Date.now()))}` : '—';
  document.getElementById('agent-current').textContent = 'Current: '+curLabel;

  // bars
  const barsHost = document.getElementById('agent-bars');
  barsHost.innerHTML='';
  barsHost.appendChild(buildDualBars(AGENT.date, AGENT.schedule, AGENT.events));

  // adherence
  const d = calcAdherence(AGENT.date, AGENT.schedule, AGENT.events);
  document.getElementById('agent-pct').textContent = Math.round(d.pct)+'%';
  document.getElementById('agent-io').textContent  = 'in: '+minutesAs(d.inMin)+' · out: '+minutesAs(d.outMin);

  // recent
  const rec = document.getElementById('agent-recent'); rec.innerHTML='';
  AGENT.events.slice(-12).reverse().forEach(ev=>{
    const row=document.createElement('div');
    row.className='row-between';
    row.style.borderTop='1px solid var(--line)';
    row.style.padding='6px 0';
    row.innerHTML = `<div><span class="pill ${cssOf(ev.status)}" style="color:#fff;border:0">${label(ev.status)}</span></div>
                     <div class="muted small">${new Date(ev.ts).toLocaleTimeString()}</div>`;
    rec.appendChild(row);
  });
}

/* ======= ADMIN VIEW ======= */
function buildAdmin(){
  document.getElementById('day').value = ADMIN.date;

  // quick ranges
  document.querySelectorAll('[data-range]').forEach(btn=>{
    btn.onclick=()=>{
      const kind=btn.getAttribute('data-range');
      const today=new Date();
      let from, to;
      if(kind==='today'){
        from = toISOdate(today); to=from;
      }else if(kind==='thisweek'){
        const d=today; const day=(d.getUTCDay()+6)%7; // Mon=0
        const start=new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()-day));
        const end  =new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()+(6-day)));
        from=toISOdate(start); to=toISOdate(end);
      }else{ // last7
        const end=today; const start=new Date(end); start.setUTCDate(end.getUTCDate()-6);
        from=toISOdate(start); to=toISOdate(end);
      }
      document.getElementById('from').value=from;
      document.getElementById('to').value=to;
    };
  });

  // downloads
  document.getElementById('dle').onclick=()=>API.download('events', getFrom(), getTo());
  document.getElementById('dls').onclick=()=>API.download('schedules', getFrom(), getTo());
  document.getElementById('dla').onclick=()=>API.download('adherence', getFrom(), getTo());

  reloadUsers();

  document.getElementById('selUser').onchange = loadAdminDay;
  document.getElementById('day').onchange     = ()=>{ ADMIN.date=document.getElementById('day').value; loadAdminDay(); };
  document.getElementById('addBlock').onclick = ()=>{ ADMIN.schedule.push({status:'available',start:480,end:540}); renderBlocks(); renderAdminDay(); };
  document.getElementById('saveSched').onclick= saveAdminSchedule;
}
function getFrom(){ return document.getElementById('from').value || ''; }
function getTo(){   return document.getElementById('to').value || ''; }

function startAdminLoops(){
  if(!ADMIN.user) return;
  renderAdminDay();
  TICKERS.push(setInterval(renderAdminDay,1000));
  TICKERS.push(setInterval(loadAdminDay,15000));
}

async function reloadUsers(){
  try{
    ADMIN.users = await API.listUsers() || [];
    const sel=document.getElementById('selUser'); sel.innerHTML='<option value="">Pick a user</option>';
    ADMIN.users.forEach(u=> sel.appendChild(new Option(`${u.username} · ${u.role}`, u.username)));
  }catch{}
}
async function loadAdminDay(){
  ADMIN.user = document.getElementById('selUser').value;
  document.getElementById('saveSched').disabled = !ADMIN.user;
  if(!ADMIN.user) return;
  try{
    const [sched, ev] = await Promise.all([
      API.getSchedule(ADMIN.user, ADMIN.date),
      API.listEvents(ADMIN.user, ADMIN.date, ADMIN.date)
    ]);
    ADMIN.schedule = sched?.blocks || [];
    ADMIN.events   = Array.isArray(ev)? ev : [];
    renderBlocks(); renderAdminDay();
  }catch{}
}
function renderBlocks(){
  const host=document.getElementById('blocks'); host.innerHTML='';
  ADMIN.schedule.forEach((b,i)=>{
    const row=document.createElement('div'); row.className='row';
    row.innerHTML=`
      <select class="field" style="max-width:160px">${STATUS_LIST.map(s=>`<option value="${s.key}" ${s.key===b.status?'selected':''}>${s.label}</option>`).join('')}</select>
      <input type="time" class="field" style="max-width:140px" value="${mm2hm(b.start)}"> to
      <input type="time" class="field" style="max-width:140px" value="${mm2hm(b.end)}">
      <button class="btn">Remove</button>`;
    const [sel, st, en, rm] = row.querySelectorAll('select, input, input, button');
    sel.onchange = e=> b.status = e.target.value;
    st.onchange  = e=> b.start  = hm2mm(e.target.value);
    en.onchange  = e=> b.end    = hm2mm(e.target.value);
    rm.onclick   = ()=>{ ADMIN.schedule.splice(i,1); renderBlocks(); renderAdminDay(); };
    host.appendChild(row);
  });
}
function renderAdminDay(){
  // live "current" status + timer for selected user
  const evs = sortEvents(ADMIN.events);
  const cur = evs.length ? evs[evs.length-1] : null;
  const pill = document.getElementById('admin-current');
  pill.textContent = cur ? `Current: ${label(cur.status)} • ${hms(Date.now()-Number(cur.ts||Date.now()))}` : 'Current: —';

  // bars
  const wrap=document.getElementById('admin-bars'); wrap.innerHTML='';
  wrap.appendChild(buildDualBars(ADMIN.date, ADMIN.schedule, ADMIN.events));

  // KPIs
  const d=calcAdherence(ADMIN.date, ADMIN.schedule, ADMIN.events);
  document.getElementById('admin-pct').textContent = `Adherence: ${Math.round(d.pct)}% · in ${minutesAs(d.inMin)} / out ${minutesAs(d.outMin)}`;

  // AUX breakdown
  const by=document.getElementById('byStatus'); by.innerHTML='';
  Object.entries(d.byStatus).forEach(([k,v])=>{
    const li=document.createElement('li'); li.textContent=`${label(k)}: ${minutesAs(v)}`; by.appendChild(li);
  });

  // IMED timeline
  const im=document.getElementById('imed'); im.innerHTML='';
  if(d.lines.length){ d.lines.forEach(t=>{ const div=document.createElement('div'); div.textContent=t; im.appendChild(div); }); }
  else im.textContent='No events for this day';
}
async function saveAdminSchedule(){
  try{
    await API.saveSchedule(ADMIN.user, ADMIN.date, ADMIN.schedule);
    alert('Saved');
  }catch(e){ alert('Save failed'); }
}

/* ======= DRAWING + ADHERENCE ======= */
function minutesAs(m){ if(m<60) return `${m}m`; const h=Math.floor(m/60), mm=m%60; return `${h}h${mm?(' '+mm+'m'):''}`; }
function hm2mm(hm){ const [h,m]=hm.split(':').map(Number); return h*60+m; }
function mm2hm(mm){ const h=Math.floor(mm/60), m=mm%60; return `${pad(h)}:${pad(m)}`; }

function sortEvents(events){
  return [...(events||[])].map(e=>({status:e.status, ts:Number(e.ts)})).sort((a,b)=>a.ts-b.ts);
}

function buildDualBars(date, scheduleBlocks, events){
  const dayStart = Date.parse(date+'T00:00:00Z');
  const startMin = 0, endMin = 1440; const total = endMin - startMin;

  // PROJECTED: schedule painted; rest offline
  const proj = [];
  const blocks = [...(scheduleBlocks||[])].sort((a,b)=>a.start-b.start);
  let cur = startMin;
  for(const b of blocks){
    if(b.start>cur) proj.push({status:'offline', start:cur, width:b.start-cur});
    proj.push({status:b.status, start:b.start, width:Math.max(0,b.end-b.start)});
    cur = Math.max(cur, b.end);
  }
  if(cur<endMin) proj.push({status:'offline', start:cur, width:endMin-cur});

  // ACTUAL: up to "now"
  const nowMin = Math.max(startMin, Math.min(endMin, Math.floor((Date.now()-dayStart)/60000)));
  const evs = sortEvents(events);
  const act=[];
  let cursor=startMin;
  let curStat=null;
  for(let i=0;i<evs.length;i++){
    const p = Math.max(startMin, Math.min(nowMin, Math.floor((evs[i].ts - dayStart)/60000)));
    if(p>cursor){ act.push({status:curStat, start:cursor, width:p-cursor}); cursor=p; }
    curStat = evs[i].status;
  }
  if(cursor<nowMin) act.push({status:curStat, start:cursor, width:nowMin-cursor});
  if(!evs.length && nowMin>startMin) act.unshift({status:null, start:startMin, width:nowMin-startMin});

  function barRow(segs, compare){
    const bar=document.createElement('div'); bar.className='gridbar';
    segs.forEach(s=>{
      const w = (s.width/total*100)+'%';
      const seg=document.createElement('div');
      seg.className = 'seg '+(s.status?cssOf(s.status):'');
      seg.style.width = w;
      if(compare){
        const probe = s.start + Math.max(1, Math.floor(s.width/2));
        const exp = blocks.find(b=> probe>=b.start && probe<b.end);
        if(exp && s.status && exp.status !== s.status) seg.classList.add('diff');
      }
      bar.appendChild(seg);
    });
    return bar;
  }

  const wrap=document.createElement('div');
  const projRow=document.createElement('div'); projRow.className='row';
  projRow.appendChild(tag('div','rowlabel','Projected'));
  projRow.appendChild(grow(barRow(proj,false)));
  wrap.appendChild(projRow);

  const actRow=document.createElement('div'); actRow.className='row';
  actRow.appendChild(tag('div','rowlabel','Actual'));
  actRow.appendChild(grow(barRow(act,true)));
  wrap.appendChild(actRow);

  const nl=document.createElement('div'); nl.className='nowline';
  nl.style.left = ((nowMin-startMin)/total*100)+'%';
  wrap.appendChild(nl);

  return wrap;
}

function calcAdherence(date, blocks, events){
  if(!blocks?.length) return { pct:100, inMin:0, outMin:0, byStatus:{}, lines:[] };
  const dayStart = Date.parse(date+'T00:00:00Z');
  const startMin = Math.min(...blocks.map(b=>b.start));
  const endMin   = Math.max(...blocks.map(b=>b.end));
  const nowMin   = Math.min(endMin, Math.max(startMin, Math.floor((Date.now()-dayStart)/60000)));

  const evs = sortEvents(events);

  // Lines (IMED)
  let idx=0, cur=evs.length?evs[0].status:null, curStart=startMin;
  const lines=[], byStatus={};
  function pushLine(st, sM, eM){
    const dur=Math.max(0,eM-sM); if(!st||!dur) return;
    const ts=dayStart + sM*60000;
    lines.push(`${new Date(ts).toLocaleTimeString()} ${label(st)} ${minutesAs(dur)}`);
    byStatus[st]=(byStatus[st]||0)+dur;
  }
  for(let m=startMin;m<=nowMin;m++){
    const ms=dayStart + m*60000;
    while(idx+1<evs.length && evs[idx+1].ts<=ms){ pushLine(cur,curStart,m); idx++; cur=evs[idx].status; curStart=m; }
  }
  pushLine(cur, curStart, nowMin);

  // Adherence minutes across scheduled minutes only
  idx=0; cur=evs.length?evs[0].status:null;
  let inMin=0, outMin=0;
  for(let m=startMin;m<nowMin;m++){
    const ms=dayStart + m*60000;
    while(idx+1<evs.length && evs[idx+1].ts<=ms){ idx++; cur=evs[idx].status; }
    const expected = (blocks||[]).find(b=> m>=b.start && m<b.end);
    if(!expected) continue; // outside schedule ignored
    if(cur && cur===expected.status) inMin++; else outMin++;
  }
  const total=inMin+outMin;
  const pct = total? (inMin/total*100):100;
  return { pct, inMin, outMin, byStatus, lines };
}

/* helpers */
function tag(t, cls, txt){ const el=document.createElement(t); el.className=cls||''; if(txt!=null) el.textContent=txt; return el; }
function grow(el){ const w=document.createElement('div'); w.style.flex='1'; w.appendChild(el); return w; }

/* ======= CHANGE PASSWORD ======= */
function wirePasswordDialog(){
  const dlg=document.getElementById('pwDlg');
  const cur=document.getElementById('curPw');
  const nw =document.getElementById('newPw');
  document.getElementById('btn-change').onclick=()=>{ cur.value=''; nw.value=''; dlg.showModal(); };
  document.getElementById('pwCancel').onclick = ()=> dlg.close();
  document.getElementById('togglePw').onclick = ()=>{
    nw.type = (nw.type==='password'?'text':'password');
    document.getElementById('togglePw').textContent = (nw.type==='password'?'Show':'Hide');
  };
  document.getElementById('pwSave').onclick = async ()=>{
    try{
      const r = await API.changePassword(cur.value, nw.value);
      if(r.ok){ alert('Password changed'); dlg.close(); }
      else { const t=await r.text().catch(()=>r.status); alert('Change failed: '+t); }
    }catch(e){ alert('Change failed'); }
  };
}
</script>
</body>
</html>
