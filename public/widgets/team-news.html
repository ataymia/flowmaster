<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="color-scheme" content="dark light">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Team News</title>
  <link rel="stylesheet" href="/widgets/team-news.css" />
  <style>
    /* Fallback styles if CSS file isn’t present */
    :root{ --bg:#0b1220; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --border:#1f2937; --accent:#e11d48 }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{padding:10px}
    .hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .hdr .title{font-weight:700}
    .hdr .meta{color:var(--muted);font-size:12px}
    .list{display:grid;gap:10px}
    .card{
      border:1px solid var(--border); border-radius:12px; padding:12px; background:var(--card);
    }
    .card .t{font-weight:600}
    .card .sub{color:var(--muted);font-size:12px;margin-top:4px}
    .card .body{color:#cbd5e1;font-size:14px;margin-top:8px;line-height:1.35}
    .pin{display:inline-block;margin-right:6px;color:var(--accent)}
    .empty{color:var(--muted);font-size:14px;border:1px dashed var(--border);border-radius:12px;padding:16px;text-align:center}
    .row{display:flex;gap:10px;align-items:baseline;flex-wrap:wrap}
    .pill{border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:11px;color:#cbd5e1}
    .right{margin-left:auto}
    .link{color:#93c5fd;text-decoration:none}
    .link:hover{text-decoration:underline}
    .toolbar{display:flex;gap:8px;align-items:center}
    .btn{font-size:12px;border:1px solid var(--border);background:#0f172a;color:#e5e7eb;border-radius:8px;padding:6px 8px;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="title">Team News</div>
      <div class="toolbar">
        <select id="aud" class="btn" title="Audience filter">
          <option value="ALL">All</option>
          <option value="TEAM">Team</option>
          <option value="FIELD">Field</option>
          <option value="SALES">Sales</option>
          <option value="OPS">Ops</option>
        </select>
        <button id="refreshBtn" class="btn" title="Refresh now">Refresh</button>
        <div class="meta" id="ts"></div>
      </div>
    </div>
    <div id="list" class="list"></div>
  </div>

  <script>
    const listEl = document.getElementById('list');
    const tsEl = document.getElementById('ts');
    const audSel = document.getElementById('aud');
    const refreshBtn = document.getElementById('refreshBtn');

    function fmtTime(date){
      try{
        return new Intl.DateTimeFormat(undefined,{hour:'2-digit',minute:'2-digit'}).format(date);
      }catch{ return date.toLocaleTimeString() }
    }

    function el(html){
      const d=document.createElement('div'); d.innerHTML=html.trim(); return d.firstElementChild;
    }

    function render(items){
      listEl.innerHTML='';
      if(!items || !items.length){
        listEl.appendChild(el(`<div class="empty">No news items yet.</div>`));
        return;
      }
      for(const it of items){
        const pin = it.pinned ? `<span class="pin">★</span>` : '';
        const date = it.publishedAt ? new Date(it.publishedAt) : null;
        const when = date ? date.toLocaleDateString() : '';
        const aud  = it.audience ? it.audience.toUpperCase() : 'ALL';
        const body = it.body ? it.body.replace(/\n/g,'<br/>') : '';

        const urlPart = it.url ? `<a class="link" href="${it.url}" target="_blank" rel="noreferrer">Open</a>` : '';
        listEl.appendChild(el(`
          <article class="card">
            <div class="row">
              <div class="t">${pin}${it.title || '(untitled)'}</div>
              <span class="pill">${aud}</span>
              <div class="sub right">${when}</div>
            </div>
            ${body ? `<div class="body">${body}</div>` : ``}
            ${urlPart ? `<div class="sub" style="margin-top:6px">${urlPart}</div>` : ``}
          </article>
        `));
      }
    }

    async function load(){
      const audience = audSel.value;
      const url = new URL('/api/news', location.origin);
      if(audience) url.searchParams.set('audience', audience);
      const r = await fetch(url.toString(), { headers: { 'cache-control':'no-cache' } });
      const data = await r.json().catch(()=>({items:[]}));
      render(data.items || []);
      tsEl.textContent = `Updated ${fmtTime(new Date())}`;
    }

    // live refresh every 60s
    let timer = null;
    function startAuto(){ stopAuto(); timer = setInterval(load, 60_000); }
    function stopAuto(){ if(timer) clearInterval(timer); timer = null; }

    refreshBtn.addEventListener('click', load);
    audSel.addEventListener('change', load);

    // Kick off
    load().then(startAuto);
    window.addEventListener('visibilitychange', ()=> {
      if (document.hidden) stopAuto(); else { load(); startAuto(); }
    });
  </script>
</body>
</html>
