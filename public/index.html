<!-- keep your <head> as-is, just ensure theme.css is linked -->
<link rel="stylesheet" href="/theme.css" />

<div id="app" class="container" style="padding:32px 16px;"></div>

<script type="module">
  // ====== CONFIG ======
  const API = '/api'; // Pages Functions prefix

  // ====== tiny fetch helper ======
  async function api(path, opts = {}) {
    const res = await fetch(API + path, { credentials: 'include', ...opts });
    const ct = res.headers.get('content-type') || '';
    if (!res.ok) {
      let msg = `HTTP ${res.status}`;
      try { if (ct.includes('application/json')) { const j = await res.json(); msg = j.error || msg; } } catch {}
      throw new Error(msg);
    }
    return ct.includes('application/json') ? res.json() : res.text();
  }

  // ====== Auth calls (renamed: whoami -> getMe) ======
  const getMe = () => api('/whoami').catch(() => ({ authed:false }));
  const login = (email, password) =>
    api('/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });
  const logout = () => api('/logout', { method: 'POST' }).catch(() => null);

  // ====== News ======
  const fetchNews = (aud) => api(`/news?aud=${encodeURIComponent(aud)}`);

  // ====== UI helpers ======
  const $ = (s, el=document) => el.querySelector(s);
  const h = (tag, attrs={}, ...kids) => {
    const n = document.createElement(tag);
    for (const [k,v] of Object.entries(attrs)) {
      if (k === 'class') n.className = v;
      else if (k === 'style') Object.assign(n.style, v);
      else if (k.startsWith('on')) n.addEventListener(k.slice(2), v);
      else n.setAttribute(k, v);
    }
    for (const k of kids.flat()) n.append(k?.nodeType ? k : document.createTextNode(k ?? ''));
    return n;
  };

  // ====== Screens ======
  function renderLogin() {
    const app = $('#app'); app.innerHTML = '';
    app.append(
      h('div', { class:'card', style:{maxWidth:'460px', margin:'48px auto'} },
        h('h2', {}, 'Allstar Agent Hub'),
        h('p', { class:'muted', style:{marginTop:'4px'} }, 'Sign in with your scheduling credentials.'),
        h('label', { class:'label', style:{marginTop:'12px'} }, 'Email'),
        h('input', { id:'email', class:'field', placeholder:'you@allstarservicesnow.com' }),
        h('label', { class:'label', style:{marginTop:'12px'} }, 'Password'),
        h('input', { id:'pass', class:'field', type:'password', placeholder:'••••••••' }),
        h('div', { id:'err', class:'muted', style:{color:'#ef4444', display:'none', marginTop:'8px'} }),
        h('button', {
          class:'btn btn-brand', style:{width:'100%', marginTop:'16px'},
          onclick: async () => {
            $('#err').style.display = 'none';
            const email = $('#email').value.trim();
            const pass  = $('#pass').value;
            try {
              await login(email, pass);
              const me = await getMe();
              if (!me?.authed) throw new Error('Login failed');
              renderHub(me);
            } catch (e) {
              $('#err').textContent = e.message || 'Sign in failed';
              $('#err').style.display = 'block';
            }
          }
        }, 'Sign in')
      )
    );
  }

  function renderHub(me) {
    const app = $('#app'); app.innerHTML = '';
    const role = me?.role || 'AGENT';
    const aud = role === 'ADMIN' || role === 'SUPERADMIN' ? 'ADMIN' : 'AGENT';

    const header = h('div', { class:'row-between', style:{marginBottom:'16px'} },
      h('div', { class:'title', style:{color:'var(--brand)'} }, 'Allstar Agent Hub'),
      h('div', { class:'row', style:{gap:'8px'} },
        h('span', { class:'muted' }, `${me.username} · ${role}`),
        h('a', { class:'btn', href:'/adherence/' }, 'Adherence'),
        h('a', { class:'btn', href:'/flowmaster/' }, 'Flowmaster'),
        h('button', { class:'btn', onclick: async ()=>{ await logout(); renderLogin(); } }, 'Logout')
      )
    );

    const newsWrap = h('div', { class:'card' },
      h('h3', {}, 'Team News & Memos'),
      h('div', { id:'newsList', style:{marginTop:'8px'} }, h('div', { class:'muted' }, 'Loading…'))
    );

    app.append(header, newsWrap);

    // load Notion-backed news
    fetchNews(aud).then(({ items=[] }) => {
      const host = $('#newsList'); host.innerHTML = '';
      if (!items.length) {
        host.append(h('div', { class:'muted' }, 'No memos yet.'));
        return;
      }
      for (const it of items) {
        const line = h('div', { class:'card', style:{marginTop:'8px'} },
          h('div', { class:'row-between' },
            h('strong', {}, it.title || '(untitled)'),
            h('span', { class:'pill', style:{display: it.pinned ? 'inline-flex' : 'none'} }, 'Pinned')
          ),
          it.publishedAt ? h('div', { class:'muted', style:{fontSize:'12px', marginTop:'4px'} },
            `Published ${it.publishedAt}${it.expiresAt ? ` · Expires ${it.expiresAt}` : ''}`
          ) : null,
          h('div', { style:{marginTop:'8px', whiteSpace:'pre-wrap'} }, it.body || '')
        );
        host.append(line);
      }
    }).catch(err => {
      const host = $('#newsList'); host.innerHTML = '';
      host.append(h('div', { class:'muted', style:{color:'#ef4444'} }, `News error: ${err.message || err}`));
    });
  }

  // ====== boot ======
  (async () => {
    const me = await getMe();
    if (me?.authed) renderHub(me);
    else renderLogin();
  })();
</script>
