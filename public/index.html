<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Allstar Agent Hub — Sign in</title>
  <link rel="stylesheet" href="/theme.css">
  <style>
    .login-wrap { min-height: 100dvh; display:grid; place-items:center; padding: 24px; }
    .logo { height:42px; width:auto; border-radius:8px; }
    .subtitle { color: var(--muted); }
  </style>
</head>
<body>
  <header class="appbar">
    <div class="brand">Allstar Agent Hub</div>
  </header>

  <main class="login-wrap">
    <div class="card" style="width:min(440px, 100%);">
      <div class="row" style="margin-bottom:12px;">
        <div class="brand" style="color:var(--brand)">ALLSTAR</div>
        <div class="subtitle">sign in</div>
      </div>

      <div id="err" class="error-banner" style="position:static; display:none; border-radius:8px; margin-bottom:10px;">Invalid login</div>

      <label class="label">Email (or username)</label>
      <input id="idp" class="field" placeholder="you@company.com">

      <label class="label" style="margin-top:10px">Password</label>
      <input id="pw" type="password" class="field" placeholder="••••••••">

      <div class="row" style="margin-top:14px; justify-content:space-between;">
        <button id="login" class="btn-brand btn" style="width:100%;">Sign in</button>
      </div>

      <div class="muted" style="margin-top:12px; font-size:12px;">
        You’ll stay signed in for 7 days on this device.
      </div>
    </div>
  </main>

  <script>
    const $ = (s)=>document.querySelector(s);

    async function jfetch(url, opts={}) {
      const r = await fetch(url, { ...opts, headers:{ 'content-type':'application/json', ...(opts.headers||{}) } });
      const ct = r.headers.get('content-type') || '';
      const body = ct.includes('application/json') ? await r.json() : await r.text();
      if (!r.ok) throw new Error((body && body.error) || `HTTP ${r.status}`);
      return body;
    }

    async function whoami(){ return jfetch('/api/whoami'); }

    async function doLogin() {
      $('#err').style.display='none';
      const idp = $('#idp').value.trim();
      const pw  = $('#pw').value;
      if (!idp || !pw) { $('#err').textContent='Enter email/username and password'; $('#err').style.display='block'; return; }
      try {
        // proxy to Worker; it mirrors cookies allstar_at / allstar_rt
        await jfetch('/api/login', { method:'POST', body: JSON.stringify(
          idp.includes('@') ? { email:idp, password:pw } : { username:idp, password:pw }
        )});
        // go to hub
        location.href = '/hub';
      } catch (e) {
        $('#err').textContent = 'Invalid email/username or password';
        $('#err').style.display = 'block';
      }
    }

    $('#login').addEventListener('click', doLogin);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Enter') doLogin(); });

    // if already authed, skip
    whoami().then(w => { if (w.authed) location.href = '/hub'; }).catch(()=>{});
  </script>
</body>
</html>
