<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Allstar Agent Hub – Sign In</title>
  <style>
    :root { color-scheme: dark; }
    body { font-family: ui-sans-serif, system-ui, -apple-system; display:flex; align-items:center; justify-content:center; min-height:100vh; background:#0b0f14; color:#e5e7eb; margin:0 }
    .card { width: 380px; background:#0f172a; padding:24px; border-radius:16px; box-shadow: 0 10px 30px rgba(0,0,0,.35); border:1px solid #1f2937 }
    h1 { margin:0 0 10px 0 }
    p { margin:0 0 16px 0; opacity:.8 }
    label { display:block; font-size:12px; opacity:.7; margin:8px 0 4px }
    input { width:100%; padding:12px; border-radius:10px; border:1px solid #374151; background:#0b0f14; color:#e5e7eb }
    button { width:100%; padding:12px; border:0; border-radius:10px; background:#2563eb; color:white; font-weight:600; cursor:pointer; margin-top:12px }
    .err { color:#fca5a5; margin-top:10px; min-height:1.2em }
    .muted { opacity:.7; font-size:12px; margin-top:8px }
  </style>
  <!-- If someone opens the GitHub Pages URL by accident, bounce them to Cloudflare -->
  <script>
  (function () {
    var CF = location.origin.includes(".pages.dev") ? location.origin : null;
    if (!CF) return; // already on CF
    if (location.hostname.endsWith("github.io")) {
      location.href = CF + location.pathname + location.search + location.hash;
    }
  })();
  </script>
</head>
<body>
  <div class="card">
    <h1>Allstar Agent Hub</h1>
    <p>Sign in with your scheduling credentials.</p>

    <form id="loginForm" novalidate>
      <label for="email">Email</label>
      <input id="email" name="email" type="email" placeholder="you@allstarservicesnow.com" autocomplete="username" required />

      <label for="password">Password</label>
      <input id="password" name="password" type="password" placeholder="Password" autocomplete="current-password" required />

      <button id="signInBtn" type="submit">Sign in</button>
      <div id="err" class="err"></div>
      <div id="dbg" class="muted"></div>
    </form>
  </div>

  <script>
  (function () {
    const form = document.getElementById('loginForm');
    const btn = document.getElementById('signInBtn');
    const err = document.getElementById('err');
    const dbg = document.getElementById('dbg');

    function show(msg) { err.textContent = msg || ''; }
    function log(o)   { dbg.textContent = typeof o === 'string' ? o : JSON.stringify(o); console.log('[login]', o); }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      show('');
      btn.disabled = true; btn.textContent = 'Signing in…';

      const email = (document.getElementById('email').value || '').trim();
      const password = document.getElementById('password').value || '';

      try {
        const r = await fetch('/api/login', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        // Log for visibility
        const text = await r.text();
        let data = {};
        try { data = JSON.parse(text || '{}'); } catch {}
        log({ status: r.status, data });

        if (r.ok) {
          // Pages function mirrored cookie allstar_at; go to /hub (middleware will verify)
          location.assign('/hub');
          return;
        }

        // Friendly messages
        const code = (data && data.error) || '';
        if (code === 'EMAIL_NOT_MAPPED')      show('Email is not registered for login.');
        else if (code === 'INVALID_LOGIN')    show('Incorrect email or password.');
        else if (code === 'MISSING_CREDENTIALS') show('Enter both email and password.');
        else show('Sign in failed. Please try again.');
      } catch (ex) {
        log(ex);
        show('Network error. Try again.');
      } finally {
        btn.disabled = false; btn.textContent = 'Sign in';
      }
    });
  })();
  </script>
</body>
</html>
