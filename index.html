<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>FlowMaster</title>
<style>
  :root{
    --bg:#0f1115; --text:#e5e7eb; --muted:#9ca3af;
    --primary:#c0392b; --primary-700:#a93226; --primary-100:rgba(192,57,43,.15);
    --panel:#111827; --card:#1f2937; --border:#374151; --shadow:0 10px 20px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--text);
       font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans";}
  header{position:sticky; top:0; z-index:10; background:var(--panel); border-bottom:2px solid var(--primary);}
  .container{max-width:1100px; margin:0 auto; padding:18px 20px}
  .brandbar{display:flex; align-items:center; gap:14px}
  h1{margin:0; font-size:24px}
  .brandAccent{color:var(--primary); font-weight:700}
  .sub{color:var(--muted); margin-top:6px; font-size:14px}
  .controlbar{display:flex; gap:12px; flex-wrap:wrap; margin-top:14px; align-items:center}
  select, button, input, textarea{
    background:var(--card); color:var(--text); border:1px solid var(--border);
    border-radius:10px; padding:10px 12px; font-size:14px; box-shadow:var(--shadow);
  }
  button.primary{background:var(--primary); color:#fff; border-color:var(--primary); cursor:pointer}
  button.primary:hover{background:var(--primary-700); border-color:var(--primary-700)}
  .right{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:16px; box-shadow:var(--shadow); margin-top:18px}
  .sectionTitle{font-weight:800; color:#fff; margin:0 0 8px}
  .steps{display:flex; flex-direction:column; gap:12px}
  .step{border:1px solid var(--border); border-left:6px solid var(--primary); border-radius:12px; background:var(--card); padding:14px; display:none}
  .step.visible{display:block}
  .step h4{margin:0 0 6px; font-size:16px; color:#fff}
  .labelBadge{display:inline-block; background:rgba(192,57,43,.22); color:#ffdada; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px}
  .scripttxt{white-space:pre-wrap; margin:8px 0 10px; color:var(--text)}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .copy{border:1px dashed var(--border); padding:6px 10px; border-radius:8px; font-size:12px; background:transparent; color:var(--text); cursor:pointer}
  .foot{display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:10px}
  .checkbox{accent-color: var(--primary)}
  .muted{color:var(--muted)}
  .callout{padding:10px 12px; border:1px dashed var(--primary); background:var(--primary-100); border-radius:8px; font-size:13px; color:#ffdada}
  .rebuttalBox{border:1px solid var(--border); background:#0b1220; border-radius:10px; padding:10px 12px; margin-top:8px; color:var(--text)}
  .footerbar{margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  #completeBtn{ display:none; }
  .fab{position:fixed; right:20px; bottom:20px; z-index:20; background:var(--primary); color:#fff; border:none; border-radius:999px; padding:12px 16px; box-shadow:var(--shadow); cursor:pointer; font-weight:700;}
  .fab:hover{background:var(--primary-700)}
  .fab-secondary{position:fixed; right:20px; bottom:76px; z-index:20; background:#b82e22; color:#fff; border:none; border-radius:999px; padding:12px 16px; box-shadow:var(--shadow); cursor:pointer; font-weight:700;}
  .fab-secondary:hover{background:#9d281e}
  .toast{position:fixed; left:50%; bottom:20px; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:10px; border:1px solid var(--border); box-shadow:var(--shadow); display:none}

  /* ===== Rebuttals as full-screen page ===== */
  .drawer--rebuttals{
    position:fixed; inset:0; z-index:30; width:100vw; height:100vh;
    background:#0b1220; border-top:2px solid var(--primary);
    box-shadow:0 -12px 32px rgba(0,0,0,.45);
    transform:translateY(100%); transition:transform .25s ease-out;
    display:flex; flex-direction:column; color:#fff;
  }
  .drawer--rebuttals.open{ transform:translateY(0); }
  .drawer--rebuttals header{
    position:sticky; top:0; background:#0b1220; border-bottom:1px solid var(--border);
    padding:16px 18px; display:flex; justify-content:space-between; align-items:center;
  }
  .drawer--rebuttals .body{ padding:18px; overflow:auto; }
  .drawer--rebuttals #rebuttalRef{
    display:grid; gap:12px;
    grid-template-columns:repeat(1, minmax(0,1fr));
  }
  @media (min-width: 900px){
    .drawer--rebuttals #rebuttalRef{ grid-template-columns:repeat(2, minmax(0,1fr)); }
  }
  @media (min-width: 1200px){
    .drawer--rebuttals #rebuttalRef{ grid-template-columns:repeat(3, minmax(0,1fr)); }
  }

  /* Keep SMS drawer narrow side panel */
  .drawer--sms{
    position:fixed; top:0; right:-420px; width:380px; height:100vh; z-index:30;
    background:#0b1220; border-left:2px solid var(--primary);
    box-shadow:-8px 0 24px rgba(0,0,0,.45); transition:right .25s ease-out;
    display:flex; flex-direction:column; color:#fff;
  }
  .drawer--sms.open{ right:0; }
  .drawer--sms header{position:sticky; top:0; background:#0b1220; border-bottom:1px solid var(--border); padding:14px 16px; display:flex; justify-content:space-between; align-items:center}
  .drawer--sms .body{padding:16px; overflow:auto}

  /* ===== Controls (search + chips) ===== */
  .reb-controls{ display:flex; flex-wrap:wrap; align-items:center; gap:10px; margin-bottom:12px; }
  .reb-search{
    flex:1 1 280px; background:var(--card); color:var(--text);
    border:1px solid var(--border); border-radius:10px; padding:10px 12px; font-size:14px;
    box-shadow:var(--shadow);
  }
  .reb-chips{ display:flex; gap:8px; flex-wrap:wrap; }
  .reb-chip{
    border:1px solid var(--border); background:var(--card); color:var(--text);
    padding:6px 10px; border-radius:999px; font-size:12px; cursor:pointer; user-select:none;
  }
  .reb-chip.active{ outline:2px solid var(--primary); }
  .reb-count{ margin-left:auto; font-size:12px; color:var(--muted); }

  /* ===== Rebuttal cards & color badges ===== */
  .rebItem{
    border:1px solid var(--border); border-radius:12px; padding:12px;
    background:var(--card); box-shadow:var(--shadow);
  }
  .rebItem h4{ display:flex; align-items:center; gap:8px; margin:0 0 6px; color:#fff; }
  .reb-badge{
    display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; font-weight:700;
  }

  /* Category colors */
  .badge-finance   { background:rgba(46, 204, 113, .18); color:#b6f2c7; border:1px solid rgba(46,204,113,.35); }
  .badge-schedule  { background:rgba(52, 152, 219, .18); color:#c5e7fb; border:1px solid rgba(52,152,219,.35); }
  .badge-qualify   { background:rgba(241, 196, 15, .18); color:#fff0b3; border:1px solid rgba(241,196,15,.35); }
  .badge-interest  { background:rgba(155, 89, 182, .18); color:#ead0f4; border:1px solid rgba(155,89,182,.35); }
  .badge-policy    { background:rgba(230, 126, 34, .18); color:#ffd8b8; border:1px solid rgba(230,126,34,.35); }
  .badge-brand     { background:rgba(127, 140, 141, .18); color:#e4ecec; border:1px solid rgba(127,140,141,.35); }
  .badge-escalate  { background:rgba(192, 57, 43, .18);  color:#ffdada; border:1px solid rgba(192,57,43,.35); }

  /* Card footer */
  .reb-actions{ display:flex; gap:8px; align-items:center; margin-top:8px; }
  .reb-copy{ border:1px dashed var(--border); background:transparent; color:var(--text);
    padding:6px 10px; border-radius:8px; font-size:12px; cursor:pointer; }

  .smsItem{border:1px solid var(--border); border-radius:10px; padding:10px; margin-bottom:10px; background:var(--card)}
  .smsItem h4{margin:0 0 6px; color:#fff}
  .small{font-size:12px; color:#9ca3af}
  .mini{font-size:12px; color:#bbb}

  /* Agent-only note styling */
  .note-yellow { color:#fde047; }             /* Tailwind yellow-400-ish */
  .note-yellow-all { color:#fde047; }
  .step.agent-note { border-left-color:#fde047 !important; }


/* sms-search-utils */
.sms-hidden { display:none !important; }


/* highlight mark */
mark.hl{background:#fde047;color:#111;padding:0 .12em;border-radius:2px}

/* === AI Bot FAB === */
.bot-fab{
  position:fixed; right:20px; bottom:140px; z-index:40;
  width:54px; height:54px; border-radius:999px;
  display:flex; align-items:center; justify-content:center;
  background: radial-gradient( circle at 30% 30%, rgba(255,255,255,.15), rgba(255,255,255,0) 60% ), var(--card);
  border:1px solid var(--border);
  box-shadow: var(--shadow);
  cursor:pointer; user-select:none;
  animation: botPulse 3s ease-in-out infinite;
}
.bot-fab:hover{ transform: translateY(-1px) scale(1.02); }
.bot-fab:active{ transform: translateY(0) scale(.98); }
.bot-fab span{ font-size:24px; line-height:1; }
@keyframes botPulse{
  0%{ box-shadow: 0 0 0 0 rgba(192,57,43,.35), var(--shadow); }
  70%{ box-shadow: 0 0 0 14px rgba(192,57,43,0), var(--shadow); }
  100%{ box-shadow: 0 0 0 0 rgba(192,57,43,0), var(--shadow); }
}

/* === AI Bot Dock (embedded) === */
.bot-dock{
  position:fixed; right:84px; bottom:20px; z-index:50;
  width:420px; max-width:calc(100vw - 120px); height:72vh; max-height:86vh;
  background:#0b1220; border:1px solid var(--border); border-radius:14px;
  box-shadow: var(--shadow); display:none; flex-direction:column; overflow:hidden;
}
.bot-dock.open{ display:flex; }
.bot-dock header{
  display:flex; align-items:center; justify-content:space-between;
  gap:8px; padding:10px 12px; border-bottom:1px solid var(--border);
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0));
}
.bot-dock header strong{ font-size:14px; }
.bot-dock .bot-actions{ display:flex; gap:8px; align-items:center; }
.bot-dock button{ background:var(--card); border:1px solid var(--border); color:var(--text); padding:6px 10px; border-radius:8px; }
.bot-dock button.primary{ background:var(--primary); border-color:var(--primary); color:#fff; }
.bot-dock iframe{
  width:100%; height:100%; border:0; background:#0b1220;
}
@media (max-width: 720px){
  .bot-dock{ right:16px; left:16px; width:auto; height:76vh; }
  .bot-fab{ bottom:140px; right:16px; }
}


/* === Address Image Search FAB (house) === */
.home-fab{
  position:fixed; right:20px; bottom:208px; z-index:50;
  width:54px; height:54px; border-radius:999px;
  display:flex; align-items:center; justify-content:center;
  background: radial-gradient( circle at 30% 30%, rgba(255,255,255,.15), rgba(255,255,255,0) 60% ), var(--card);
  border:1px solid var(--border);
  box-shadow: var(--shadow);
  cursor:pointer; user-select:none;
  animation: botPulse 3s ease-in-out infinite;
}
.home-fab:hover{ transform: translateY(-1px) scale(1.02); }
.home-fab:active{ transform: translateY(0) scale(.98); }
.home-fab span{ font-size:22px; line-height:1; }

/* Dock for the Address Image Search */
.home-dock{
  position:fixed; right:84px; bottom:20px; z-index:50;
  width:520px; max-width:calc(100vw - 120px); height:72vh; max-height:86vh;
  background:#0b1220; border:1px solid var(--border); border-radius:14px;
  box-shadow: var(--shadow); display:none; flex-direction:column; overflow:hidden;
}
.home-dock.open{ display:flex; }
.home-dock header{
  display:flex; align-items:center; justify-content:space-between;
  gap:8px; padding:10px 12px; border-bottom:1px solid var(--border);
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0));
}
.home-dock header strong{ font-size:14px; }
.home-dock .actions{ display:flex; gap:8px; align-items:center; }
.home-dock button{ background:var(--card); border:1px solid var(--border); color:var(--text); padding:6px 10px; border-radius:8px; }
.home-dock button.primary{ background:var(--primary); border-color:var(--primary); color:#fff; }
.home-dock .body{ flex:1; overflow:auto; padding:10px; }
.home-dock .note{ font-size:12px; color:#cbd5e1; opacity:.8; margin-bottom:8px;}

</style>
  <script async src="https://cse.google.com/cse.js?cx=c38c7e238b4984830"></script>

<style>
/* Force typed text inside Google CSE search bar to black */
.gsc-input input.gsc-input {
  color: #000 !important;
}

/* Suggestions in the autocomplete dropdown */
.gssb_a,
.gssb_a td {
  color: #000 !important;
}
</style>

</head>
<body>
<header>
<div class="container">
<div class="brandbar"><img alt="Logo" src="data:image/png;base64,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" style="height:38px;"/>
<div>
<h1>📞 FlowMaster <span class="brandAccent">— Allstar Services</span></h1>
<div class="sub">Select a script, work each step in order. Use <strong>Rebuttal?</strong> in steps or tap <strong>Need a rebuttal?</strong>. Press <strong>Complete</strong> to reset.</div>
</div>
</div>
<div class="controlbar">
<label for="scriptSelect"><strong>Script:</strong></label>
<select id="scriptSelect" title="Choose a script to begin">
<option value="">— Select a Script —</option>
<option value="out_new">Outbound – New Lead</option>
<option value="out_aged">Outbound – Nurtured / Aged Lead</option>
<option value="out_agg">Outbound – Aggregator Lead (Lead Guru)</option>
<option value="in_new">Inbound – New Lead</option>
<option value="in_missed">Inbound – Missed Call / Callback</option>
<option value="in_resched">Inbound – Reschedule Appointment</option>
<option value="in_cancel">Inbound – Cancel Appointment</option>
<option value="in_where">Inbound – Where Is My Sales Agent?</option>
<option value="in_storm">Inbound – Storm Damage Call</option>
<option value="other_confirm">Appointment Confirmation (Live Call)</option>
<option value="other_vm">Appointment Confirmation (Voicemail)</option>
</select>
<button id="resetAll">↺ Reset</button>
</div>
</div>
</header>
<main class="container">
<section class="right">
<h3 class="sectionTitle" id="scriptTitle">Select a script to begin</h3>
<div class="steps" id="steps"></div>
<div class="footerbar">
<button class="primary" id="completeBtn">✅ Complete Call &amp; Reset</button>
</div>
</section>
</main>
<!-- Floating Buttons -->
<button aria-controls="smsDrawer" aria-expanded="false" class="fab-secondary" id="openSms">💬 Sending a text?</button>
<button aria-controls="rebuttalDrawer" aria-expanded="false" class="fab" id="openDrawer">❓ Need a rebuttal?</button>

<!-- Rebuttals Drawer (FULL-SCREEN) -->
<aside aria-hidden="true" class="drawer--rebuttals" id="rebuttalDrawer">
  <header>
    <strong>Rebuttals — Quick Reference</strong>
    <button class="primary" id="closeDrawer" style="padding:6px 10px;">✕ Close</button>
  </header>
  <div class="body">
    
    <!-- === Quick Rebuttal (AI + Library) === -->
    <div id="smartReb" style="margin-bottom:14px; border:1px dashed var(--border); border-radius:10px; padding:12px; background:rgba(255,255,255,.03)">
      <div style="font-weight:700; margin-bottom:6px;">Quick Rebuttal</div>
      <textarea id="objInput" rows="2" style="width:100%; background:var(--card); color:var(--text); border:1px solid var(--border); border-radius:8px; padding:8px" placeholder="Paste or type the caller’s objection…"></textarea>
      <div class="row" style="margin-top:8px">
        <button type="button" id="btnSuggest" class="copy">Suggest from Library</button>
        <button type="button" id="btnGenerate" class="primary">AI Draft</button>
      </div>
      <div id="smartOut" class="scripttxt" style="margin-top:10px"></div>
    </div>
<div id="rebControls" class="reb-controls">
      <input id="rebSearch" class="reb-search" type="search" placeholder="Search rebuttals (title or text)…" />
      <div id="rebChips" class="reb-chips"></div>
      <div id="rebCount" class="reb-count">Showing 0</div>
    </div>
    <div id="rebuttalRef"></div>
  </div>
</aside>

<!-- SMS Drawer (SIDE PANEL) -->
<aside aria-hidden="true" class="drawer--sms" id="smsDrawer">
<header>
<strong>SMS — Texting Assistant</strong>
<button class="primary" id="closeSms" style="padding:6px 10px;">✕ Close</button>
</header>
<div class="body">
<div class="smsItem">
<h4>🧠 Text Reply Assistant <span style="font-size:11px;background:rgba(255,255,255,.08);padding:2px 8px;border-radius:999px">beta</span></h4>
<div class="small">Fill once — all templates update live. Paste customer message and click <em>Suggest Reply</em>.</div>
<div class="row" style="margin-top:8px">
<input id="brandInput" placeholder="Brand (e.g., Allstar Roofing)" style="flex:1;"/>
<input id="nameInput" placeholder="Agent Name (e.g., Mia)" style="flex:1;"/>
</div>
<div class="row" style="margin-top:8px">
<input id="brandLink" placeholder="Brand Link (optional)" style="flex:1;"/>
<input id="custNameInput" placeholder="Customer First Name (optional)" style="flex:1;"/>
</div>
<textarea id="incomingText" placeholder="Paste customer text here…" rows="4" style="width:100%; margin-top:8px"></textarea>
<div class="row" style="margin-top:8px">
<label><input id="firstReplyToggle" type="checkbox"/> This is a first reply?</label>
<button class="primary" id="analyzeText">Suggest Reply</button>
<button class="copy" id="copySuggested">Copy Suggestion</button>
</div>
<div id="suggestedWrap" style="margin-top:8px; display:none">
<div class="small">Suggested reply (filled):</div>
<div class="scripttxt" id="suggestedText" style="border:1px dashed var(--border); padding:8px;"></div>
</div>
</div>

<div class="smsItem" id="smsSearchBlock">
  <h4>🔎 Search Text Templates</h4>
  <div class="small">Type to filter by title or text. Matches update live across templates and rebuttal texts.</div>
  <div class="row" style="margin-top:8px">
    <input id="smsSearch" placeholder="Search SMS templates and rebuttals…" style="flex:1;"/>
    <span id="smsSearchCount" class="mini" style="min-width:120px;text-align:right">0 matches</span>
  </div>
</div>
<div class="smsItem">
<h4>📲 Standard SMS Templates</h4>
<div class="small">“Filled preview” reflects the fields above. Use <em>Copy (filled)</em>.</div>
<div id="smsList"></div>
</div>
<div class="smsItem">
<h4>🧩 Rebuttal Texts (verbatim)</h4>
<div class="small">Mirrors voice rebuttals verbatim for texting.</div>
<div id="smsRebuttals"></div>
</div>
</div>
</aside>
<div class="toast" id="toast" role="status" aria-live="polite"></div>
<script defer="">
/* -------------- tiny utils -------------- */
function toast(msg){
  const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block';
  setTimeout(()=>{t.style.display='none';},1400);
}
async function copyText(text){
  try{
    if(navigator.clipboard && window.isSecureContext){
      await navigator.clipboard.writeText(text);
    }else{
      const ta=document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.left='-9999px';
      document.body.appendChild(ta); ta.focus(); ta.select(); document.execCommand('copy'); ta.remove();
    }
    toast('Copied!');
  }catch(e){ toast('Copy failed'); }
}
function fill(msg, data){
  return msg
    .split('[Brand Name]').join(data.brand||'[Brand Name]')
    .split('[Brand]').join(data.brand||'[Brand]')
    .split('[Your Name]').join(data.agent||'[Your Name]')
    .split('[Agent Name]').join(data.agent||'[Agent Name]')
    .split('[Customer Name]').join(data.cust||'[Customer Name]')
    .split('[Customer First Name]').join(data.cust||'[Customer First Name]')
    .split('[Name]').join(data.cust||'[Name]')
    .split('[Link]').join(data.link||'[Link]');
}
function dataNow(){
  return {
    brand: document.getElementById('brandInput').value.trim(),
    agent: document.getElementById('nameInput').value.trim(),
    cust:  document.getElementById('custNameInput').value.trim(),
    link:  document.getElementById('brandLink').value.trim()
  };
}

/* -------------- REBUTTALS (VERBATIM — updated exactly) -------------- */
const REBUTTALS = [
  { key:'dnc', title:'Do Not Contact / Escalated Customer',
    text:`“I completely understand the frustration, and I want to apologize for the inconvenience. I’ll make sure your contact information is removed from our lists right away, so you won’t receive further communication from us.” 
If persistent & asks for Supervisor: Use de-escalation techniques  

 Assure the caller you will take the appropriate actions to remove their number from our dialer and confirm effective immediately they have been placed on our Do Not Call list. Apologize once again and close the call.  
If the customer persists, transfer to the onsite call center manager.` },

  { key:'other_provider1', title:'Already Chose Another Provider — Work hasn’t started',
    text:`“I respect that. I’d still love to offer you a free inspection. You’ll get a detailed report on your roof’s condition and lifespan — that way you can compare notes and ensure you’re getting the best value. Can I get you scheduled?”` },

  { key:'other_provider2', title:'Already Chose Another Provider — Work started or complete',
    text:`“Understood — thanks for your time today. If you need us in the future, you can always reach us at [phone/website].”` },

  { key:'finance1', title:'Financial Concerns — First step',
    text:`I completely understand. We work with 4 different lenders to offer flexible financing options, including no payments for a set term or low interest rates. Everything’s pending approval but having multiple lenders increases your chances of finding a plan that works. 
 We can go over all the details during your free estimate — when’s a good time to get you scheduled?` },

  { key:'finance2', title:'Financial Concerns — If still resistant',
    text:`“I completely understand. The good news is we’re running a Labor Day Discount — $2,000 off a new roof. We can review the details during your free estimate. Can I get you booked?”` },

  { key:'selling', title:'Selling the Home',
    text:`“Thanks for sharing that. When do you plan to put the house on the market? Are you looking to complete the roof project before selling? If so, a free inspection can identify any repairs that could increase your home’s value and help you secure the best possible offer. Would you like me to check my calendar for an appointment?” 
 
If a customer is simply looking for a free estimate-driven by a real estate agent/broker: 
“At this time, we reserve our free roofing estimates for homeowners who are actively considering a roof replacement. Based on what you’ve shared, it sounds like you’re not looking to move forward with a roofing project right now, so we may not be the best fit at this time. If your plans change, we’d be happy to assist you with a full estimate.”` },

  { key:'brand_location', title:'Questions About Brand or Location',
    text:`“You’ve reached the booking department for [Brand]. Our headquarters are in [HQ Location], and our booking team is based in Arizona. Certain calls are routed here so we can schedule efficiently for your area.` },

  { key:'not_interested', title:'Not Interested / Changed Their Mind',
    text:`“I understand you may have something else in mind. Before I let you go, is there anything else we can assist with regarding roofing? If not, no worries — I appreciate your time today. For future roofing needs, you can always reach us at [phone/website].” 
If yes: 
 “Perfect — let’s get you scheduled for a free consultation. I just need a few quick details.”` },

  { key:'money_variant', title:'“I don’t have money / broke / low credit / fixed income / military discount / free roof”',
    text:`“I completely understand. We work with four different lenders to offer financing — including no payments for a set term or low interest rates. Because we partner with multiple lenders, your chances of approval are much higher. We can go over the details during your free estimate. Would you like to check the calendar for a time?” 

If still resistant: 

“I completely understand. The good news is we’re offering a Labor Day Discount — $2,000 off a new roof. Let’s at least get you scheduled for a free inspection, so you’ll know exactly where things stand.”` },

  { key:'spouse', title:'Need to Talk to Spouse / Other Homeowner',
    text:`“I completely understand. We actually require that all homeowners be present for the appointment so everyone hears the same information and can make decisions together. What’s a good time when you’ll both be available?”` },

  { key:'busy', title:'Too Busy / No Time',
    text:`“I hear you — that’s exactly why the inspection only takes about 60 minutes, and we can work around your schedule. Do mornings or evenings usually work better for you?”` },

  { key:'price_phone', title:'Just Want a Price Over the Phone',
    text:`“I understand. The issue is every roof is different, so any price over the phone would just be a guess. The inspection is free, and it ensures you get an accurate estimate. Let’s get you scheduled so you have realistic numbers.”` },

  { key:'roof_ok', title:'My Roof Seems Fine / No Issues',
    text:`“That’s great to hear. A free inspection is proactive — it helps catch hidden issues before they become expensive repairs. It only takes 60 minutes, and it gives you peace of mind. Would you like me to check my calendar for a time?”` },

  { key:'repairs_only', title:'Only Want Repairs (Not Full Replacement)',
    text:`“I understand. We specialize in full roof replacements and gutters. If that’s what you need, we can absolutely help. But if you’re only looking for a small patch or repair, we may not be the right fit.”` }

  ,{ key:'price_match', title:'Price Match / Better Quote',
    text:`“I completely understand wanting the best price. We provide a detailed, apples‑to‑apples proposal so you can compare fairly. If you receive a lower written quote for comparable materials and scope, we’re happy to review it together and see what we can do. Let’s keep your free inspection so you have a precise, written estimate to compare.”` }
  ,{ key:'insurance_only', title:'Insurance‑Only / Claim‑First',
    text:`“Thanks for letting me know. We work with many homeowners who have insurance claims. The first step is a thorough inspection and photo documentation so you know exactly what’s covered and what isn’t. Your specialist can also explain how estimates align with common carrier requirements. Would mornings or late afternoons work to get you on the schedule?”` }
  ,{ key:'gutter_only', title:'Gutters‑Only Request',
    text:`“I appreciate you reaching out. We specialize in full roof replacements and gutters as part of a replacement. If you’re only looking for a standalone gutter project, we may not be the best fit. However, if you’re considering a roof project now or soon, we can absolutely include new gutters in the proposal.”` }
  ,{ key:'hour_too_long', title:'Hour Seems Too Long',
    text:`“Our inspections are scheduled for about an hour. The actual roof inspection itself usually takes around 30 minutes, give or take. The rest of the time is set aside for your representative to sit down with you, review their findings in detail, and answer any questions you may have.

Optional: This way, you’ll have a clear understanding of your roof’s condition and next steps.”` }];

/* -------------- REBUTTAL CATEGORIES -------------- */
const CATEGORY_MAP = {
  dnc: 'escalate',
  other_provider1: 'interest',
  other_provider2: 'interest',
  finance1: 'finance',
  finance2: 'finance',
  selling: 'qualify',
  brand_location: 'brand',
  not_interested: 'interest',
  money_variant: 'finance',
  spouse: 'schedule',
  busy: 'schedule',
  price_phone: 'qualify',
  roof_ok: 'qualify',
  repairs_only: 'policy'
,
  price_match: 'finance',
  insurance_only: 'qualify',
  gutter_only: 'policy',
  hour_too_long: 'schedule'};
const CATEGORY_LABEL = {
  finance: 'Finance',
  schedule: 'Scheduling',
  qualify: 'Qualification',
  interest: 'Interest',
  policy: 'Policy / Scope',
  brand: 'Brand / Location',
  escalate: 'De-escalation'
};
const CATEGORY_ORDER = ['finance','schedule','qualify','interest','policy','brand','escalate'];
function catOf(r){ return CATEGORY_MAP[r.key] || 'qualify'; }
function badgeClass(cat){
  return {
    finance:'badge-finance',
    schedule:'badge-schedule',
    qualify:'badge-qualify',
    interest:'badge-interest',
    policy:'badge-policy',
    brand:'badge-brand',
    escalate:'badge-escalate'
  }[cat] || 'badge-qualify';
}

/* -------------- CALL SCRIPTS (unchanged) -------------- */
const OUTBOUND_MONITOR = `Before we continue, I do want to let you know this call may be monitored or recorded for quality and training purposes.`;

const SCRIPTS = {
  out_new:{name:"Outbound – New Lead",steps:[{type:'text',label:'Greeting & Intro',text:`Hi, this is [Your Name] calling from [Brand]. How are you doing today?\n\n${OUTBOUND_MONITOR}`},
    {type:'text',label:'Value',text:`I see you submitted your information through one of our trusted partners about roofing help. We’d like to get you scheduled with one of our representatives for a free, no-obligation estimate for <strong>SINGLE FAMILY RESIDENTIAL HOMES</strong>. It only takes about 60 minutes and will give you a clear picture of your roof’s condition.`},
    {type:'text',label:'👉 Transition to scheduling',text:`Can I get you scheduled for your free estimate?`},
    {type:'text',label:'Service Area Check — Detroit (New Leads Only)',text:`<div class='callout-yellow'>Please confirm the full property address to ensure the home is in our **service area**.

**Effective immediately, we do not service the City of Detroit.**
If the address is in Detroit, use this exact language (do not share internal reasons):
“Mr./Mrs. [Customer], thank you for reaching out. Unfortunately, your location is outside of our service area, so we’re not able to assist at this time.”

(Agent note — do not read aloud)</div>`},
    {type:'list',label:'Qualifying Questions',text:`Please verify the name and spelling of your first and last name.  \n\nPlease verify the property address?  \n\nAre you the homeowner? * \n\nIs your house currently for sale? \n\nIf yes: When do you plan on putting the house on the market? \n\nIf yes: Are you looking to complete the roof project prior to selling? \n\nWill all homeowners be able to attend appointments? \n\nHow old is your roof? (years) * \n\nIs this a residential property? * \n\nAre you experiencing any active leaks? * \n\nIf yes: We specialize in full roof replacements — if that’s what you need, we can help. But if you’re only looking for a quick leak repair, we may not be the right fit.`},
    {type:'text',label:'Time Zone Note',text:`<div class='callout-yellow'>For Rapid & Craftsmen Appts add 3 hours to local time\n\nFor Allstar Appts add 2 hours to local time

(Agent note — do not read aloud)</div>`},
    {type:'text',label:'Close',text:`“Thanks for booking with us! A rep will meet you at your scheduled time. We’ll call within 48 hours hrs prior and send text reminders. Please be sure to confirm your appointment —if we don’t hear back at least 24 hrs. before, the appointment will be canceled. To reschedule or cancel, just call us.”`}]},
  out_aged:{name:"Outbound – Nurtured / Aged Lead",steps:[{type:'text',label:'Greeting & Intro',text:`Hi, this is [Your Name] with [Brand]. I’m reaching out because you requested roofing help some time ago, but we haven’t been able to connect.\n\n${OUTBOUND_MONITOR}`},
    {type:'text',label:'Status Check',text:`Has the project been taken care of yet — or do you still need a professional to take a look?`},
    {type:'text',label:'Value',text:`If not, we can get a representative out for a free, no-obligation estimate for <strong>SINGLE FAMILY RESIDENTIAL HOMES</strong>. It’s quick, and it’ll give you a clear idea of where things stand.`},
    {type:'text',label:'👉 Transition to scheduling',text:`Can I get you scheduled for your free estimate?`},
    {type:'list',label:'Qualifying Questions',text:`Please verify the name and spelling of your first and last name.  \n\nPlease verify the property address?  \n\nAre you the homeowner? * \n\nIs your house currently for sale? \n\nIf yes: When do you plan on putting the house on the market? \n\nIf yes: Are you looking to complete the roof project prior to selling? \n\nWill all homeowners be able to attend appointments? \n\nHow old is your roof? (years) * \n\nIs this a residential property? * \n\nAre you experiencing any active leaks? * \n\nIf yes: We specialize in full roof replacements — if that’s what you need, we can help. But if you’re only looking for a quick leak repair, we may not be the right fit.`},
    {type:'text',label:'Close',text:`“Thanks for booking with us! A rep will meet you at your scheduled time. We’ll call within 48 hours hrs prior and send text reminders. Please be sure to confirm your appointment —if we don’t hear back at least 24 hrs. before, the appointment will be canceled. To reschedule or cancel, just call us.”`}]},
  out_agg:{name:"Outbound – Aggregator Lead (Lead Guru)",steps:[{type:'text',label:'Greeting & Intro',text:`Hi, this is [Your Name] with [Brand]. I can see your request came through with a preferred booking time — thank you for sharing that!\n\n${OUTBOUND_MONITOR}`},
    {type:'text',label:'👉 Transition to scheduling',text:`Can I get you scheduled for your free estimate?`},
    {type:'list',label:'Qualifying Questions',text:`Please verify the name and spelling of your first and last name.  \n\nPlease verify the property address?  \n\nAre you the homeowner? * \n\nIs your house currently for sale? \n\nIf yes: When do you plan on putting the house on the market? \n\nIf yes: Are you looking to complete the roof project prior to selling? \n\nWill all homeowners be able to attend appointments? \n\nHow old is your roof? (years) * \n\nIs this a residential property? * \n\nAre you experiencing any active leaks? * \n\nIf yes: We specialize in full roof replacements — if that’s what you need, we can help. But if you’re only looking for a quick leak repair, we may not be the right fit.`},
    {type:'text',label:'Close',text:`“Thanks for booking with us! A rep will meet you at your scheduled time. We’ll call within 48 hours hrs prior and send text reminders. Please be sure to confirm your appointment —if we don’t hear back at least 24 hrs. before, the appointment will be canceled. To reschedule or cancel, just call us.”`}]},

  in_new:{name:"Inbound – New Lead",steps:[{type:'text',label:'Greeting & Intro',text:`Thank you for calling [Brand], my name is [Your Name]. How can I help you today?`},
    {type:'text',label:'Value',text:`Perfect — we can schedule you for a free, no-obligation inspection for <strong>SINGLE FAMILY RESIDENTIAL HOMES</strong> with one of our specialists. It only takes about 60 minutes and will give you a full report on your roof’s condition.`},
    {type:'text',label:'👉 Transition to scheduling',text:`Can I get you scheduled for your free estimate?`},
    {type:'text',label:'Service Area Check — Detroit (New Leads Only)',text:`<div class='callout-yellow'>Please confirm the full property address to ensure the home is in our **service area**.

**Effective immediately, we do not service the City of Detroit.**
If the address is in Detroit, use this exact language (do not share internal reasons):
“Mr./Mrs. [Customer], thank you for reaching out. Unfortunately, your location is outside of our service area, so we’re not able to assist at this time.”

(Agent note — do not read aloud)</div>`},
    {type:'list',label:'Qualifying Questions',text:`Please verify the name and spelling of your first and last name.  \n\nPlease verify the property address?  \n\nAre you the homeowner? * \n\nIs your house currently for sale? \n\nIf yes: When do you plan on putting the house on the market? \n\nIf yes: Are you looking to complete the roof project prior to selling? \n\nWill all homeowners be able to attend appointments? \n\nHow old is your roof? (years) * \n\nIs this a residential property? * \n\nAre you experiencing any active leaks? * \n\nIf yes: We specialize in full roof replacements — if that’s what you need, we can help. But if you’re only looking for a quick leak repair, we may not be the right fit.`},
    {type:'text',label:'Time Zone Note',text:`<div class='callout-yellow'>For Rapid & Craftsmen Appts add 3 hours to local time\n\nFor Allstar Appts add 2 hours to local time

(Agent note — do not read aloud)</div>`},
    {type:'text',label:'Close',text:`“Thanks for booking with us! A rep will meet you at your scheduled time. We’ll call within 48 hours hrs prior and send text reminders. Please be sure to confirm your appointment —if we don’t hear back at least 24 hrs. before, the appointment will be canceled. To reschedule or cancel, just call us.”`}]},
  in_missed:{name:"Inbound – Missed Call / Callback",steps:[{type:'text',label:'Greeting & Intro',text:`Thank you for calling [Brand], my name is [Your Name]. I noticed we missed your call earlier, so I wanted to follow up.`},
    {type:'text',label:'Purpose Check',text:`Were you calling about roofing help for a residential property?`},
    {type:'text',label:'Value',text:`Great — we can schedule you for a free, no-obligation inspection for <strong>SINGLE FAMILY RESIDENTIAL HOMES</strong>. It only takes about 60 minutes and will give you a full report on your roof’s condition.`},
    {type:'text',label:'👉 Transition to scheduling',text:`Can I get you scheduled for your free estimate?`},
    {type:'list',label:'Qualifying Questions',text:`Please verify the name and spelling of your first and last name.  \n\nPlease verify the property address?  \n\nAre you the homeowner? * \n\nIs your house currently for sale? \n\nIf yes: When do you plan on putting the house on the market? \n\nIf yes: Are you looking to complete the roof project prior to selling? \n\nWill all homeowners be able to attend appointments? \n\nHow old is your roof? (years) * \n\nIs this a residential property? * \n\nAre you experiencing any active leaks? * \n\nIf yes: We specialize in full roof replacements — if that’s what you need, we can help. But if you’re only looking for a quick leak repair, we may not be the right fit.`},
    {type:'text',label:'Time Zone Note',text:`<div class='callout-yellow'>For Rapid & Craftsmen Appts add 3 hours to local time\n\nFor Allstar Appts add 2 hours to local time

(Agent note — do not read aloud)</div>`},
    {type:'text',label:'Close',text:`“Thanks for booking with us! A rep will meet you at your scheduled time. We’ll call within 48 hours hrs prior and send text reminders. Please be sure to confirm your appointment —if we don’t hear back at least 24 hrs. before, the appointment will be canceled. To reschedule or cancel, just call us.”`}]},
  in_resched:{name:"Inbound – Reschedule Appointment",steps:[{type:'text',label:'Greeting & Intro',text:`Thank you for calling [Brand], my name is [Your Name]. How can I help you today?`},
    {type:'text',label:'Acknowledge',text:`No problem, we can get that rescheduled for you.`},
    {type:'list',label:'Confirm',text:`Name \n\nProperty address \n\nPreferred phone number`},
    {type:'text',label:'Offer Times',text:`I have ____ and _____ available. What works for you?`},
    {type:'text',label:'Time Zone Note',text:`<div class='callout-yellow'>For Rapid & Craftsmen Appts add 3 hours to local time\n\nFor Allstar Appts add 2 hours to local time

(Agent note — do not read aloud)</div>`},
    {type:'text',label:'Close',text:`Got it — your appointment has been rescheduled. You’ll receive confirmation 24–48 hours prior.`}]},
  in_cancel:{name:"Inbound – Cancel Appointment",steps:[{type:'text',label:'Greeting & Intro',text:`Thank you for calling [Brand], my name is [Your Name]. How can I help you today?`},
    {type:'text',label:'Empathy',text:`I’m sorry to hear you need to cancel. Let me confirm a few details before I update our records.`},
    {type:'list',label:'Confirm',text:`Name \n\nProperty address \n\nReason for cancellation`},
    {type:'text',label:'Rebuttal (once)',text:`I completely understand. Just to note, the inspection is free and only takes 60 minutes. It’s often the best way to know where things stand, even if you’re not ready to move forward right away. Would you like me to keep you on the calendar so you still have the option?`},
    {type:'text',label:'SAME DAY CANCELLATION WARNING',text:`<div class='callout-yellow'>If the customer cancels for **today**, immediately send a same‑day cancellation note in Teams. Use the **“Same-Day Cancellation — Teams”** template in the SMS drawer (Template #2) so Sales Managers see it right away.

(Agent note — do not read aloud)</div>`},
    {type:'text',label:'If Still Cancel',text:`Understood. I’ll update our records. If you ever need help in the future, you can always reach us at [website/phone].`}]},
  in_where:{name:"Inbound – Where Is My Sales Agent?",steps:[{type:'text',label:'Greeting & Intro',text:`Thank you for calling [Brand], my name is [Your Name]. How can I help you today?`},
    {type:'text',label:'Empathy',text:`I completely understand your concern. Let me get a few details so I can check on this for you.`},
    {type:'list',label:'Confirm',text:`Name \n\nProperty address \n\nPreferred phone number`},
    {type:'text',label:'Internal Handoff',text:`Reach out to Sales Manager via Teams using the Brand’s Customer Follow-Up thread.  \nUse @ [Insert Sales Manager} \n \nUse  this template: \n\nHi,
    ____________. Customer was scheduled for _____am/pm,
    and rep has not arrived; they are looking for an updated ETA.   \n \nCustomer Name:   \nProperty Address:   \nPhone #:   \n \nDo we have any information available I can relay to the customer?   \nThank you!`},
    {type:'text',
    label:'Close (to customer)',
    text:`We’re working on getting an update right now. I can call you back as soon as I get in touch with our Dispatch office.  (This process can be subjective as the ownership can shift if it’s an evening slot or if the Sales Manager is unresponsive,
    the situation may call for a rescheduling.)`}]},
  in_storm:{name:"Inbound – Storm Damage Call",steps:[{type:'text',label:'Greeting & Intro',text:`Thank you for calling [Brand], my name is [Your Name]. How can I help you today?`},
    {type:'text',label:'Empathy',text:`I’m sorry to hear that — I know how stressful storm damage can be.`},
    {type:'text',label:'Probe',text:`Is this related to an insurance claim? \n\nIf yes → warm transfer to brand. \n\nIf no → treat as a new lead and book inspection.`},
    {type:'text',label:'Booking',text:`We can send a specialist out for a free, no-obligation inspection for <strong>SINGLE FAMILY RESIDENTIAL HOMES</strong>. It only takes about 60 minutes and will give you a clear understanding of the damage.`},
    {type:'list',label:'Qualifying Questions',text:`Please verify the name and spelling of your first and last name.  \n\nPlease verify the property address?  \n\nAre you the homeowner? * \n\nIs your house currently for sale? \n\nIf yes: When do you plan on putting the house on the market? \n\nIf yes: Are you looking to complete the roof project prior to selling? \n\nWill all homeowners be able to attend appointments? \n\nHow old is your roof? (years) * \n\nIs this a residential property? * \n\nAre you experiencing any active leaks? * \n\nIf yes: We specialize in full roof replacements — if that’s what you need, we can help. But if you’re only looking for a quick leak repair, we may not be the right fit.`},
    {type:'text',label:'Time Zone Note',text:`<div class='callout-yellow'>For Rapid & Craftsmen Appts add 3 hours to local time\n\nFor Allstar Appts add 2 hours to local time

(Agent note — do not read aloud)</div>`},
    {type:'text',label:'Close',text:`“Thanks for booking with us! A rep will meet you at your scheduled time. We’ll call within 48 hours hrs prior and send text reminders. Please be sure to confirm your appointment —if we don’t hear back at least 24 hrs. before, the appointment will be canceled. To reschedule or cancel, just call us.”`}]},
  other_confirm:{name:"Appointment Confirmation (Live Call)",steps:[{type:'text',label:'Confirm',text:`Hi [Customer Name], this is [Your Name] with [Brand]. I’m calling to confirm your free roofing estimate scheduled for [Date] at [Local Time].`},
    {type:'text',label:'SAME DAY CANCELLATION WARNING',text:`<div class='callout-yellow'>If the customer cancels for **today**, immediately send a same‑day cancellation note in Teams. Use the **“Same-Day Cancellation — Teams”** template in the SMS drawer (Template #2) so Sales Managers see it right away.

(Agent note — do not read aloud)</div>`},
    {type:'text',label:'Set Expectations',text:`Your sales representative will arrive on time, perform a full inspection of your roof, and then walk you through their findings in detail. To help us keep things efficient, please make sure there’s clear access to the areas they’ll need to inspect.`},
    {type:'text',label:'Time Zone Note',text:`<div class='callout-yellow'>For Rapid & Craftsmen Appts add 3 hours to local time\n\nFor Allstar Appts add 2 hours to local time

(Agent note — do not read aloud)</div>`},
    {type:'text',label:'Close',text:`We’re looking forward to meeting with you and providing your estimate!`}]},
  other_vm:{name:"Appointment Confirmation (Voicemail)",steps:[{type:'text',label:'VM Intro',text:`Hi [Customer Name], this is [Your Name] with [Brand]. I’m calling to confirm your free roofing estimate scheduled for [Date] at [Time].`},
    {type:'text',label:'VM Body',text:`Your representative will be arriving to perform a full inspection of the roof and walk you through their findings. Please make sure there’s access to the areas they’ll need to inspect.`},
    {type:'text',label:'VM Cancellation Warning',text:`If we don’t hear back from you by the end of the day to confirm or reschedule, we’ll need to cancel the appointment to avoid a missed connection.`},
    {type:'text',label:'SAME DAY CANCELLATION WARNING',text:`<div class='callout-yellow'>If the customer cancels for **today**, immediately send a same‑day cancellation note in Teams. Use the **“Same-Day Cancellation — Teams”** template in the SMS drawer (Template #2) so Sales Managers see it right away.

(Agent note — do not read aloud)</div>`},
    {type:'text',label:'VM Close',text:`You can call or text us back at this number — we’d be happy to get everything confirmed. Thanks again, and we hope to hear from you soon!`},
    {type:'text',label:'Time Zone Note',text:`<div class='callout-yellow'>For Rapid & Craftsmen Appts add 3 hours to local time\n\nFor Allstar Appts add 2 hours to local time

(Agent note — do not read aloud)</div>`}]}
};

/* -------------- SMS templates (unchanged) -------------- */
const SMS_TEMPLATES = [
  { key:'opt_out', title:'X) Compliance – STOP / Opt‑Out',
    text:`No problem — we’ve removed your number and you won’t receive further messages. If this was a mistake, reply START to opt back in.`},{ key:'first_reply', title:'1) First Reply (All Brands w/ optional link)',
    text:`Hi [Name], thanks for your response! I’d be happy to help you get scheduled. We can send out one of our roofing specialists to take a look and give you a free estimate. What day and time works best for you? Or you can grab a time here if it’s easier: [Link]`},
  { key:'same_day_cancel_teams', title:'2) Same-Day Cancellation — Teams',
  text:`Hi @[Sales Manager] – Customer [Customer Name] called to cancel her [Time] appointment today due to a [Reason]. Airtable has been updated to reflect the changes.`},
  { key:'qual_questions', title:'3) Qualifying Questions (after interest)',
    text:`I can definitely see if those times are available. Can you answer a few quick questions so I can get you pre-qualified? \n\nAre you the homeowner? \n\nIs your house currently for sale? \n\nWill all homeowners be able to attend the appointment? \n\nHow old is your roof? (years) \n\nIs this a residential property? \n\nAre you experiencing any active leaks?`},
  { key:'booked', title:'4) Booked Appointment (after qualification)',
    text:`Thanks for booking with us! A rep will meet you at your scheduled time. We’ll call within 48 hours hrs prior and send text reminders. Please be sure to confirm your appointment —if we don’t hear back at least 24 hrs. before, the appointment will be canceled. To reschedule or cancel, just call us.`},
  { key:'financing', title:'5) Financing / Money Concerns',
    text:`I completely understand. We work with 4 different lenders to offer flexible financing options — including no payments for a set term or low interest rates. Everything’s pending approval, but having multiple lenders increases your chances of finding a plan that works. We can review everything at your free estimate. When’s a good time to get you scheduled?`},
  { key:'nurture', title:'6) Nurture / Re‑Engage (they text back instead of picking up call)',
    text:`Hey [Name], this is [Brand]. We previously received your request about roofing help and tried giving you a call. I’d be happy to help you get scheduled. We can send out one of our roofing specialists to give you a free estimate. What day and time works best for you?`},
  { key:'aged', title:'7) Aged Lead (Been weeks / no connection)',
    text:`Hi, this is [Brand]. We received your request about roofing help some time ago and wanted to follow up. Has your project already been completed? If not, we’d be happy to get you scheduled for a free estimate. Would you like to check the calendar to see if one of my open time slots works for you?`},
  { key:'cant_afford', title:'8) Objection – Can’t Afford It',
    text:`I completely understand. The good news is we’re running a Labor Day Discount right now — you’ll save $2,000 on a new roof, with no shortcuts and no surprises. We can go over details during your free estimate. Would you like to check the calendar to see if any of my open time slots work?`},
  { key:'not_interested', title:'9) Objection – Not Interested / Changed Mind',
    text:`No problem — I understand. Just so you know, the estimate is completely free and only takes about 60 minutes. At the very least, it gives you a clear picture of your roof’s condition. Would you like me to send over my open time slots so you can pick one?`},
  { key:'roof_fine', title:'10) Objection – Roof Seems Fine',
    text:`That’s great to hear! Many homeowners feel the same, which is why our free inspections are proactive — they catch hidden issues before they become costly repairs. It only takes 60 minutes. Want me to send over my availability?`},
  { key:'spouse', title:'11) Spouse / Other Homeowner Not Present',
    text:`No problem — we actually require all homeowners to be present so everyone hears the same information and can make decisions together. What’s a good time when you’ll both be available?`},
  { key:'busy', title:'12) Too Busy / No Time',
    text:`Totally understand. That’s why the inspection only takes about 60 minutes, and we can work around your schedule. Would mornings or afternoons be easier for you?`},
  { key:'driveby', title:'13) Drive by/ Unattended estimate',
    text:`I totally understand wanting a quick idea,  but to give you an accurate estimate, we really need to have a specialist take a closer look in person. Every roof is different, and photos or satellite images don’t always show things like wear, damage, or ventilation issues. \n\nThe good news is the inspection is completely free and only takes about 60 minutes. We’ll provide a full report and walk you through everything. \n\nWould you like to check my schedule to see if one of our open time slots works for you?`},
  { key:'not_qualified', title:'14) Not Qualified',
    text:`Hi [Customer Name], this is [Your Name] with [Brand Name]. After reviewing your information, I wanted to let you know that at this time we only service asphalt shingle roofing systems on single family homes. Unfortunately, we won’t be the right fit for your project. I truly appreciate your interest, and I’m sorry we won’t be able to assist — wishing you the best moving forward!`}];

/* -------------- RENDER REBUTTALS LIST + FILTERS -------------- */
const rebuttalRef = document.getElementById('rebuttalRef');
const rebSearch   = document.getElementById('rebSearch');
const rebChips    = document.getElementById('rebChips');
const rebCount    = document.getElementById('rebCount');

let activeCategory = ''; // '' = all

// Build chips
function renderChips(){
  const chips = [''].concat(CATEGORY_ORDER); // '' for 'All'
  rebChips.innerHTML = chips.map(cat=>{
    const label = cat ? CATEGORY_LABEL[cat] : 'All';
    const active = (cat===activeCategory) ? 'active' : '';
    return `<div class="reb-chip ${active}" data-cat="${cat}">${label}</div>`;
  }).join('');
}
renderChips();
rebChips.addEventListener('click', (e)=>{
  const el = e.target.closest('.reb-chip'); if(!el) return;
  activeCategory = el.getAttribute('data-cat') || '';
  renderChips();
  filterAndRender();
});

// Card factory
function cardHTML(r){
  const cat = catOf(r);
  const badge = badgeClass(cat);
  const safe = r.text.replace(/\\n/g,'<br>');
  const id = `copy_${r.key}`;
  return `
    <div class="rebItem" data-cat="${cat}">
      <h4>${r.title} <span class="reb-badge ${badge}">${CATEGORY_LABEL[cat]||'Other'}</span></h4>
      <div class="scripttxt">${safe}</div>
      <div class="reb-actions">
        <button class="reb-copy" data-copy="${id}">Copy</button>
      </div>
      <div id="${id}" style="display:none">${r.text}</div>
    </div>`;
}

// First render
function filterAndRender(){
  const q = (rebSearch.value || '').toLowerCase().trim();
  const results = REBUTTALS.filter(r=>{
    const catOk = !activeCategory || catOf(r)===activeCategory;
    const hay = (r.title + ' ' + r.text).toLowerCase();
    const qOk = !q || hay.includes(q);
    return catOk && qOk;
  });
  rebuttalRef.innerHTML = results.map(cardHTML).join('');
  rebCount.textContent = `Showing ${results.length}`;
}
filterAndRender();

rebSearch.addEventListener('input', filterAndRender);

// Copy (event delegation)
rebuttalRef.addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-copy]'); if(!btn) return;
  const id = btn.getAttribute('data-copy');
  const el = document.getElementById(id);
  const text = (el && el.textContent) ? el.textContent : '';
  copyText(text);
});

/* -------------- SCRIPT AREA -------------- */
const scriptSelect = document.getElementById('scriptSelect');
const stepsEl      = document.getElementById('steps');
const titleEl      = document.getElementById('scriptTitle');
const completeBtn  = document.getElementById('completeBtn');
function stepEl(step, idx, total){
  const wrap=document.createElement('div'); wrap.className='step'; if(idx===0) wrap.classList.add('visible');
  const head=document.createElement('h4');
  head.innerHTML = `${idx+1}. ${step.label} <span class="labelBadge">${step.type==='rebuttal'?'Optional':'Step'}</span>`;
  const body=document.createElement('div'); body.className='scripttxt'; body.innerHTML=(step.text||'').replace(/\\n/g,'<br>');
  wrap.appendChild(head); wrap.appendChild(body);

  if(step.type==='rebuttal'){
    const dd=document.createElement('select');
    dd.innerHTML = `<option value="">— Rebuttal? Choose an objection —</option>` + REBUTTALS.map(r=>`<option value="${r.key}">${r.title}</option>`).join('');
    const box=document.createElement('div'); box.className='rebuttalBox'; box.style.display='none';
    const rbT=document.createElement('div'); rbT.style.fontWeight='700';
    const rbC=document.createElement('div'); rbC.className='scripttxt';
    box.appendChild(rbT); box.appendChild(rbC);
    wrap.appendChild(document.createElement('div')).innerHTML=`<div class="callout">If the caller hesitates, pick an objection and address it before scheduling.</div>`;
    wrap.appendChild(dd); wrap.appendChild(box);
    dd.addEventListener('change',()=>{
      const sel=REBUTTALS.find(r=>r.key===dd.value);
      if(sel){ box.style.display='block'; rbT.textContent=sel.title; rbC.innerHTML=sel.text.replace(/\\n/g,'<br>'); }
      else{ box.style.display='none'; }
    });
  }

  const foot=document.createElement('div'); foot.className='foot';
  const row=document.createElement('div'); row.className='row';
  const copyBtn=document.createElement('button'); copyBtn.className='copy'; copyBtn.textContent='Copy';
  copyBtn.addEventListener('click',()=> copyText(body.textContent));
  row.appendChild(copyBtn);
  const lab=document.createElement('label'); lab.innerHTML=`<input type="checkbox" class="checkbox"> Mark step complete`;
  row.appendChild(lab); foot.appendChild(row);
  const prog=document.createElement('div'); prog.className='muted'; prog.textContent=`Step ${idx+1} of ${total}`; foot.appendChild(prog);
  wrap.appendChild(foot);

  lab.querySelector('input').addEventListener('change',e=>{
    if(!e.target.checked) return;
    const next=wrap.nextElementSibling; if(next) next.classList.add('visible'); else completeBtn.style.display='inline-block';
  });
  return wrap;
}
function loadScript(key){
  stepsEl.innerHTML=''; completeBtn.style.display='none';
  if(!key || !SCRIPTS[key]){ titleEl.textContent='Select a script to begin'; return; }
  const def=SCRIPTS[key]; titleEl.textContent=def.name;
  def.steps.forEach((s,i)=> stepsEl.appendChild(stepEl(s,i,def.steps.length)));
}
scriptSelect.addEventListener('change',()=> loadScript(scriptSelect.value));
document.getElementById('resetAll').addEventListener('click',()=>{ scriptSelect.value=''; loadScript(''); });
completeBtn.addEventListener('click',()=>{ scriptSelect.value=''; loadScript(''); });

/* -------------- DRAWERS -------------- */
const smsDrawer  = document.getElementById('smsDrawer');
const openSms    = document.getElementById('openSms');
const closeSms   = document.getElementById('closeSms');
openSms.addEventListener('click',()=>{ smsDrawer.classList.add('open'); smsDrawer.setAttribute('aria-hidden','false'); openSms.setAttribute('aria-expanded','true'); });
closeSms.addEventListener('click',()=>{ smsDrawer.classList.remove('open'); smsDrawer.setAttribute('aria-hidden','true'); openSms.setAttribute('aria-expanded','false'); });

const rebuttalDrawer=document.getElementById('rebuttalDrawer');
document.getElementById('openDrawer').addEventListener('click',()=>{ rebuttalDrawer.classList.add('open'); rebuttalDrawer.setAttribute('aria-hidden','false'); });
document.getElementById('closeDrawer').addEventListener('click',()=>{ rebuttalDrawer.classList.remove('open'); rebuttalDrawer.setAttribute('aria-hidden','true'); });

/* -------------- SMS LISTS + LIVE FILL -------------- */
const smsListEl=document.getElementById('smsList');
const smsRebEl =document.getElementById('smsRebuttals');

function renderSmsLists(){
  smsListEl.innerHTML='';
  SMS_TEMPLATES.forEach(t=>{
    const id=`tmpl_${t.key}`;
    const card=document.createElement('div'); card.className='smsItem';
    card.innerHTML=`
      <h4>${t.title}</h4>
      <div class="mini">Template:</div>
      <div class="scripttxt" style="opacity:.85">${t.text.replace(/\\n/g,'<br>')}</div>
      <div class="mini" style="margin-top:6px">Filled preview:</div>
      <div class="scripttxt" id="${id}" style="border:1px dashed var(--border); padding:8px;"></div>
      <div class="row"><button class="copy" data-copy="${id}">Copy (filled)</button></div>`;
    smsListEl.appendChild(card);
  });

  smsRebEl.innerHTML='';
  REBUTTALS.forEach(r=>{
    const id=`rebt_${r.key}`;
    const card=document.createElement('div'); card.className='smsItem';
    card.innerHTML=`
      <h4>${r.title}</h4>
      <div class="mini">Template:</div>
      <div class="scripttxt" style="opacity:.85">${r.text.replace(/\\n/g,'<br>')}</div>
      <div class="mini" style="margin-top:6px">Filled preview:</div>
      <div class="scripttxt" id="${id}" style="border:1px dashed var(--border); padding:8px;"></div>
      <div class="row"><button class="copy" data-copy="${id}">Copy (filled)</button></div>`;
    smsRebEl.appendChild(card);
  });

  // event delegation for copy
  smsListEl.addEventListener('click', (e)=>{
    const btn=e.target.closest('button[data-copy]'); if(!btn) return;
    const id=btn.getAttribute('data-copy'); const text=(document.getElementById(id)?.textContent)||'';
    copyText(text);
  });
  smsRebEl.addEventListener('click', (e)=>{
    const btn=e.target.closest('button[data-copy]'); if(!btn) return;
    const id=btn.getAttribute('data-copy'); const text=(document.getElementById(id)?.textContent)||'';
    copyText(text);
  });

  updateFilledPreviews();
}
function updateFilledPreviews(){
  const d=dataNow();
  SMS_TEMPLATES.forEach(t=>{
    const filled=fill(t.text,d);
    const el=document.getElementById(`tmpl_${t.key}`); if(el) el.textContent=filled;
  });
  REBUTTALS.forEach(r=>{
    const filled=fill(r.text,d);
    const el=document.getElementById(`rebt_${r.key}`); if(el) el.textContent=filled;
  });
}
['brandInput','nameInput','custNameInput','brandLink'].forEach(id=>{
  document.getElementById(id).addEventListener('input', updateFilledPreviews);
});
renderSmsLists();

/* -------------- TEXT ASSISTANT (Suggest Reply) -------------- */
const firstReplyToggle=document.getElementById('firstReplyToggle');
const incomingText    =document.getElementById('incomingText');
const analyzeText     =document.getElementById('analyzeText');
const copySuggested   =document.getElementById('copySuggested');
const suggestedWrap   =document.getElementById('suggestedWrap');
const suggestedText   =document.getElementById('suggestedText');

function intentKey(text){
  const t=(text||'').toLowerCase().trim();
  if(firstReplyToggle.checked) return 'first_reply';
  if(/(^|\\s)(stop|unsubscribe|opt\\s*out)(\\s|$)/.test(t)) return 'opt_out'; // not in list, default below
  if(/finance|budget|payment|loan|credit|afford|interest/.test(t)) return 'financing';
  if(/drive ?by|google (map|maps)|satellite|street view|no visit|unattended/.test(t)) return 'driveby';
  if(/discount|labor ?day|coupon|promo|(?:\\$ ?2000|2000)/.test(t)) return 'cant_afford';
  if(/not interested|no thanks|changed my mind|stop calling/.test(t)) return 'not_interested';
  if(/roof.*(fine|ok|okay|good)|no issues|all good/.test(t)) return 'roof_fine';
  if(/spouse|wife|husband|partner|co-?home/.test(t)) return 'spouse';
  if(/busy|no time|tight schedule|later|another time/.test(t)) return 'busy';
  if(/weeks|months.*ago|follow ?up|still need|checking back/.test(t)) return 'aged';
  if(/qualif|pre-?qual|prequal|questions/.test(t)) return 'qual_questions';
  if(/book|schedule|time|availability|open slot|set (it|something) up/.test(t)) return 'nurture';
  if(/^(hi|hello|hey|who.*this|new phone)/.test(t)) return 'first_reply';
  return 'nurture';
}
function renderSuggestion(){
  const key=intentKey(incomingText.value);
  const tpl=SMS_TEMPLATES.find(x=>x.key===key) || SMS_TEMPLATES[0];
  const filled=fill(tpl.text, dataNow());
  suggestedText.textContent=filled; suggestedWrap.style.display='block';
}
analyzeText.addEventListener('click', renderSuggestion);
copySuggested.addEventListener('click', ()=> copyText(suggestedText.textContent||''));
</script>




<script>
// === Runtime Enhancements: Agent notes as yellow text + agent-note step border ===
(function(){
  // Cues that indicate agent-only instruction lines inside mixed blocks
  const agentLineRegexes = [
    /^(if\s+yes:.*)$/i,
    /^(if\s+no:.*)$/i,
    /^(at\s+this\s+time.*)$/i,
    /^(reach out.*)$/i,
    /^(use .*template.*)$/i,
    /^(for rapid.*)$/i,
    /^(internal.*)$/i,
    /^note:.*$/i
  ];
  // Labels that are entire agent-note steps
  function isAgentLabel(label){
    const L = (label||"").toLowerCase();
    return L.includes("time zone note") ||
           L.includes("same day cancellation warning") ||
           L.includes("service area check — detroit");
  }

  function colorAgentLines(html){
    const parts = html.split(/<br\s*\/?>/i);
    const out = [];
    for (let raw of parts){
      const plain = raw.replace(/<[^>]+>/g,"").trim();
      if (agentLineRegexes.some(re=> re.test(plain))){
        out.push("<span class='note-yellow'>" + raw.trim() + "</span>");
      } else {
        out.push(raw);
      }
    }
    return out.join("<br>");
  }

  function applyAgentStylingToStep(stepEl){
    const h4 = stepEl.querySelector("h4");
    const body = stepEl.querySelector(".scripttxt");
    if (!body) return;
    const labelText = h4 ? h4.textContent || "" : "";
    if (isAgentLabel(labelText)){
      stepEl.classList.add("agent-note");
      body.classList.add("note-yellow-all");
    } else {
      body.innerHTML = colorAgentLines(body.innerHTML);
    }
  }

  function sweep(){
    document.querySelectorAll(".step").forEach(applyAgentStylingToStep);
  }

  // Patch loadScript to apply after render
  if (!window.__agentYellowPatched && typeof window.loadScript === "function"){
    window.__agentYellowPatched = true;
    const __orig = window.loadScript;
    window.loadScript = function(key){
      __orig(key);
      sweep();
    };
    // initial sweep
    setTimeout(sweep, 0);
  } else {
    // Fallback sweep once
    setTimeout(sweep, 0);
  }
})();

// Keep SMS template ordering & renumbering (Same-Day Cancellation — Teams as #2)
(function(){
  if (window.__smsOrderPatchedYellow) return;
  window.__smsOrderPatchedYellow = true;
  const ORDER_KEY_SECOND = "same_day_cancel_teams";
  function reorderAndRenumber(){
    if (!Array.isArray(window.SMS_TEMPLATES)) return;
    const arr = window.SMS_TEMPLATES;
    const idxFirst = arr.findIndex(t=> t && t.key === "first_reply");
    const idxTeams = arr.findIndex(t=> t && t.key === ORDER_KEY_SECOND);
    let teams = null;
    if (idxTeams >= 0){
      teams = arr.splice(idxTeams,1)[0];
    } else {
      teams = {
        key:'same_day_cancel_teams',
        title:'Same-Day Cancellation — Teams',
        text:'Hi @[Sales Manager] – Customer [Customer Name] called to cancel her [Time] appointment today due to a [Reason]. Airtable has been updated to reflect the changes.'
      };
    }
    const insertAt = (idxFirst >= 0) ? idxFirst+1 : 1;
    arr.splice(insertAt, 0, teams);
    // Renumber 1..N
    for (let i=0;i<arr.length;i++){
      const t = arr[i];
      if (!t || !t.title) continue;
      const rest = t.title.replace(/^\s*\d+\)\s*/, "");
      t.title = (i+1) + ") " + rest;
    }
  }
  if (typeof window.renderSmsLists === "function" && !window.__renderSmsPatchedYellow){
    window.__renderSmsPatchedYellow = true;
    const __orig = window.renderSmsLists;
    window.renderSmsLists = function(){
      reorderAndRenumber();
      return __orig();
    };
    setTimeout(()=>{ try{ window.renderSmsLists(); }catch(e){} }, 0);
  }
})();
</script>


<script>
(function(){
  const qInput = document.getElementById('smsSearch');
  const countEl = document.getElementById('smsSearchCount');
  const listEl  = document.getElementById('smsList');
  const rebEl   = document.getElementById('smsRebuttals');

  function cardMatches(card, q){
    if(!q) return true;
    const text = (card.textContent || '').toLowerCase();
    return text.indexOf(q) !== -1;
  }
  function applyFilter(){
    const q = (qInput.value || '').toLowerCase().trim();
    let matches = 0;
    [listEl, rebEl].forEach(container=>{
      if(!container) return;
      Array.from(container.querySelectorAll('.smsItem')).forEach(card=>{
        if(cardMatches(card, q)){ card.classList.remove('sms-hidden'); matches++; }
        else { card.classList.add('sms-hidden'); }
      });
    });
    if(countEl) countEl.textContent = (q ? matches + ' matches' : '0 matches');
  }
  if(qInput){
    qInput.addEventListener('input', applyFilter);
    // Optional: trigger on drawer open if search exists
    document.getElementById('openSms')?.addEventListener('click', ()=>{
      setTimeout(()=>{ qInput.focus(); }, 150);
    });
  }
})();
</script>


<script>
// ===== Robust highlight overlay (non-invasive; runs after existing renders) =====
(function(){
  function escapeRegExp(str){ return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
  function markHTML(html, q){
    if(!q) return html;
    try{
      const rx = new RegExp('(' + escapeRegExp(q) + ')','ig');
      return html.replace(rx, '<mark class="hl">$1</mark>');
    }catch(e){ return html; }
  }
  function restore(el){
    if(el && el.dataset && el.dataset.origHtml){ el.innerHTML = el.dataset.origHtml; }
  }
  function prime(el){
    if(el && el.dataset && !el.dataset.origHtml){ el.dataset.origHtml = el.innerHTML; }
  }

  // ---- Rebuttals: wrap global filterAndRender so highlight runs AFTER it populates DOM
  const rebSearch = document.getElementById('rebSearch');
  const rebuttalRef = document.getElementById('rebuttalRef');
  if (typeof window.filterAndRender === "function" && rebuttalRef && rebSearch && !window.__HL_WRAP_REB){
    window.__HL_WRAP_REB = true;
    const __orig = window.filterAndRender;
    function applyRebHL(){
      const q = (rebSearch.value || '').trim();
      rebuttalRef.querySelectorAll('.rebItem').forEach(card=>{
        const h4 = card.querySelector('h4');
        const body = card.querySelector('.scripttxt');
        // Prime originals
        if(h4) prime(h4);
        if(body) prime(body);
        // Restore
        if(h4) restore(h4);
        if(body) restore(body);
        // Re-apply highlight (avoid touching the badge span)
        if(q && h4){
          const orig = h4.innerHTML;
          const idx = orig.indexOf('<span class="reb-badge');
          if(idx > -1){
            const left = orig.slice(0, idx);
            const right = orig.slice(idx);
            h4.innerHTML = markHTML(left, q) + right;
          }else{
            h4.innerHTML = markHTML(orig, q);
          }
        }
        if(q && body){
          body.innerHTML = markHTML(body.innerHTML, q);
        }
      });
    }
    window.filterAndRender = function(){
      const r = __orig.apply(this, arguments);
      try{ applyRebHL(); }catch(e){ /* no-op */ }
      return r;
    };
    // Also react to typing (after built-in filter fires)
    rebSearch.addEventListener('input', function(){ setTimeout(()=>{ try{ applyRebHL(); }catch(e){} }, 0); });
    // Initial pass (default show-all no query)
    setTimeout(()=>{ try{ applyRebHL(); }catch(e){} }, 0);
  }

  // ---- SMS drawer: highlight in visible cards after its own filter code runs
  const smsInput = document.getElementById('smsSearch');
  const smsList  = document.getElementById('smsList');
  const smsRebs  = document.getElementById('smsRebuttals');
  function applySmsHL(){
    const q = (smsInput?.value || '').trim();
    [smsList, smsRebs].forEach(root=>{
      if(!root) return;
      root.querySelectorAll('.smsItem').forEach(card=>{
        const h4 = card.querySelector('h4');
        const bodies = card.querySelectorAll('.scripttxt');
        // Prime
        if(h4) prime(h4);
        bodies.forEach(el=> prime(el));
        // Restore
        if(h4) restore(h4);
        bodies.forEach(el=> restore(el));
        // Highlight only if visible and q present
        if(card.classList.contains('sms-hidden') || !q) return;
        if(h4) h4.innerHTML = markHTML(h4.innerHTML, q);
        bodies.forEach(el=> el.innerHTML = markHTML(el.innerHTML, q));
      });
    });
  }
  if(smsInput && (smsList || smsRebs) && !window.__HL_WRAP_SMS){
    window.__HL_WRAP_SMS = true;
    smsInput.addEventListener('input', function(){ setTimeout(applySmsHL, 0); });
    document.getElementById('openSms')?.addEventListener('click', function(){ setTimeout(applySmsHL, 200); });
    // If the app rebuilds the lists, re-run afterwards
    if(typeof window.renderSmsLists === 'function'){
      const __origRender = window.renderSmsLists;
      window.renderSmsLists = function(){
        const r = __origRender.apply(this, arguments);
        setTimeout(applySmsHL, 0);
        return r;
      };
    }
  }
})();
</script>


<!-- === Floating AI Bot launcher === -->
<button id="botFab" class="bot-fab" type="button" aria-label="Open AI Assistant" aria-expanded="false" aria-controls="botDock" title="Open AI Assistant">
  <span>🤖</span>
</button>

<!-- === Embedded AI Bot Dock (iframe) === -->
<aside id="botDock" class="bot-dock" aria-hidden="true">
  <header>
    <strong>AI Assistant</strong><span id="botStatus" style="margin-left:8px;font-size:11px;padding:2px 6px;border:1px solid var(--border);border-radius:999px;opacity:.8">idle</span>
    <div class="bot-actions">
      <button id="botClose" class="primary" type="button" title="Close">Close</button>
    </div>
  </header>
  <iframe id="botFrame" src="" title="Embedded AI Assistant"></iframe>
</aside>


<script>
// === AI Bot embed wiring ===
(function(){
  const fab   = document.getElementById('botFab');
  const dock  = document.getElementById('botDock');
  const frame = document.getElementById('botFrame');

  // Ensure elements exist; if not, bind after DOMContentLoaded
  function bindBotFab(){
    const fabNow = document.getElementById('botFab');
    if(fabNow){
      fabNow.addEventListener('click', toggleDock, { once:false });
    }
  }
  document.addEventListener('DOMContentLoaded', bindBotFab, { once:true });


  const statusEl = document.getElementById('botStatus');
  function setStatus(t){ if(statusEl) statusEl.textContent = t; }
  if(frame){
    frame.addEventListener('load', ()=> setStatus('loaded'));
  }
  function openDock(){
    if(!dock) return;
    setStatus('loading…');
    if(frame) frame.src = BOT_SRC;
    dock.classList.add('open');
    dock.setAttribute('aria-hidden','false');
    fab?.setAttribute('aria-expanded','true');
    // Fallback: if still not loaded in 2.5s, hint about local server
    setTimeout(()=>{
      if(statusEl && statusEl.textContent === 'loading…'){
        statusEl.textContent = 'check allstarbot.html / local server';
      }
    }, 2500);
  }

  const close = document.getElementById('botClose');// Replace this with your live bot URL or relative file path once provided:
  const BOT_SRC = 'allstarbot.html'; // <-- set your embed file/url

  function openDock(){
    if(!dock) return;
    if(frame) frame.src = BOT_SRC;
    dock.classList.add('open');
    dock.setAttribute('aria-hidden','false');
    fab?.setAttribute('aria-expanded','true');
  }
  function closeDock(){
    if(!dock) return;
    dock.classList.remove('open');
    dock.setAttribute('aria-hidden','true');
    fab?.setAttribute('aria-expanded','false');
  }

  close?.addEventListener('click', closeDock);

  // Pop-out opens the same src in a new tab
  pop?.addEventListener('click', function(){
    const src = frame?.src || BOT_SRC;
    if(src) window.open(src, '_blank', 'noopener,noreferrer');
  });

  
  function toggleDock(){
    if(!dock) return;
    const isOpen = dock.classList.contains('open');
    if(isOpen){ closeDock(); } else { openDock(); }
  }
  // binding happens in bindBotFab() once DOM is ready
// Optional: Esc to close
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape' && dock?.classList.contains('open')) closeDock();
  });

  // Expose a tiny API to update the embed src without editing the file
  window.setBotEmbedSrc = function(url){
    if(!url) return;
    localStorage.setItem('bot_embed_src', url);
    if(frame){
      const isOpen = dock?.classList.contains('open');
      frame.src = url;
      if(!isOpen){ /* keep lazy-loaded */ frame.removeAttribute('src'); }
    }
  };
})();
</script>


<!-- === Floating House launcher (Address Image Search) === -->
<button id="homeFab" class="home-fab" type="button" aria-label="Open Address Image Search" aria-expanded="false" aria-controls="homeDock" title="Open Address Image Search">
  <span>🏠</span>
</button>

<!-- === Address Image Search Dock (Google Programmable Search - Images only) === -->
<aside id="homeDock" class="home-dock" aria-hidden="true">
  <header>
    <strong>Address Image Search <span style="font-size:11px;opacity:.75;">(images only)</span></strong>
    <div class="actions">
      <button id="homeClose" class="primary" type="button" title="Close">Close</button>
    </div>
  </header>
  <div class="body">
    <div class="note">Enter a full street address (e.g., “123 Main St, Phoenix AZ”). You’ll see a Google search bar below; results render in this panel.</div>
    <div id="addrImageSearchWrap" style="min-height:320px;">
      <div class="gcse-search" id="addrSearchWidget"></div>
    </div>
    </div>
</aside>


<script>
// === Address Image Search wiring (images-only CSE) ===
(function(){ 
  const fab   = document.getElementById('homeFab');
  const dock  = document.getElementById('homeDock');
  const close = document.getElementById('homeClose');

  const CSE_SRC = "https://cse.google.com/cse.js?cx=c38c7e238b4984830";
  let cseLoaded = false;

  function ensureCSE(){
    return new Promise(resolve=>{ 
      if(cseLoaded){ resolve(); return; }
      // If a CSE script is already present (maybe from another panel), consider it loaded.
      if(document.querySelector('script[src^=\"https://cse.google.com/cse.js?\"]')){ 
        cseLoaded = true; resolve(); return; 
      }
      const s = document.createElement('script');
      s.async = true; s.src = CSE_SRC;
      s.onload = ()=>{ cseLoaded = true; resolve(); };
      s.onerror = ()=> resolve(); // fail soft
      document.body.appendChild(s);
    });
  }

  function openDock(){
    if(!dock) return;
    dock.classList.add('open');
    dock.setAttribute('aria-hidden','false');
    fab?.setAttribute('aria-expanded','true');
    ensureCSE();
  }
  function closeDock(){
    if(!dock) return;
    dock.classList.remove('open');
    dock.setAttribute('aria-hidden','true');
    fab?.setAttribute('aria-expanded','false');
  }
  function toggleDock(){ dock?.classList.contains('open') ? closeDock() : openDock(); }

  // Bind now and on DOMContentLoaded to be safe
  fab?.addEventListener('click', toggleDock);
  if(!fab){ document.addEventListener('DOMContentLoaded', ()=> document.getElementById('homeFab')?.addEventListener('click', toggleDock), { once:true }); }
  close?.addEventListener('click', closeDock);

  // Esc to close
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape' && dock?.classList.contains('open')) closeDock();
  });
})();
</script>


<script>
(function(){ 
  // Enhanced rendering for Address Image Search: force-render if needed
  const dock = document.getElementById('homeDock');
  const fab  = document.getElementById('homeFab');
  const close= document.getElementById('homeClose');

  function openHomeDock(){ 
    if(!dock) return;
    dock.classList.add('open');
    dock.setAttribute('aria-hidden','false');
    if(fab) fab.setAttribute('aria-expanded','true');

    // If Google CSE is present but didn't auto-render (hidden element timing), force render.
    try{ 
      const hasGoogle = window.google && window.google.search && window.google.search.cse && window.google.search.cse.element;
      const target = document.getElementById('addrSearchWidget');
      const empty = target && target.children && target.children.length === 0;
      if(hasGoogle && empty){
        window.google.search.cse.element.render({ div: 'addrSearchWidget', tag: 'search' });
      }
    }catch(e){ /* no-op */ }
  }
  function closeHomeDock(){
    if(!dock) return;
    dock.classList.remove('open');
    dock.setAttribute('aria-hidden','true');
    if(fab) fab.setAttribute('aria-expanded','false');
  }
  function toggleHomeDock(){ (dock && dock.classList.contains('open')) ? closeHomeDock() : openHomeDock(); }

  // Rebind safely (replace node to drop previous listeners in iterative builds)
  try{ if(fab) fab.replaceWith(fab.cloneNode(true)); }catch(e){}
  const fab2 = document.getElementById('homeFab');
  if(fab2) fab2.addEventListener('click', toggleHomeDock);
  if(close) close.addEventListener('click', closeHomeDock);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && dock && dock.classList.contains('open')) closeHomeDock(); });
})();
</script>


<script>
/* === Quick Rebuttal (Suggest + AI Draft + Save) === */
(function(){
  const proxyURL = "https://allstar-rebuttal-proxy.ataymia.workers.dev";
  const REBUTTAL_LOG_WEBHOOK = "https://script.google.com/macros/s/AKfycby0A7oy0R3jY9C-vV-GkBxeIGN2HNReW4CJH6Qq1GMV6S22oV00uV3-jdDinL2x14z5AQ/exec";

  const objInput = document.getElementById('objInput');
  const btnGen   = document.getElementById('btnGenerate');
  const btnSug   = document.getElementById('btnSuggest');
  const smartOut = document.getElementById('smartOut');
  if(!objInput || !btnGen || !smartOut){ console.warn("Quick Rebuttal UI not found."); return; }

  // --- Safety: ensure globals exist ---
  window.REBUTTALS = Array.isArray(window.REBUTTALS) ? window.REBUTTALS : [];
  window.CATEGORY_LABEL = window.CATEGORY_LABEL || {
    finance:'Finance',
    schedule:'Scheduling',
    qualify:'Qualification',
    interest:'Interest',
    policy:'Policy / Scope',
    brand:'Brand / Location',
    escalate:'De-escalation'
  };
  window.CATEGORY_MAP = window.CATEGORY_MAP || {};

  function toastFM(msg){ try{ if(window.toast) return window.toast(msg); }catch(e){} console.log(msg); }

  // --- Local Suggest (TF-IDF cosine) ---
  function tokenize(s){ return (s||"").toLowerCase().replace(/[^a-z0-9\s]/g," ").split(/\s+/).filter(Boolean); }
  function buildIndex(docs){
    const N=docs.length; const DF=new Map(); const Toks=docs.map(d=>tokenize(d.title+" "+d.text));
    Toks.forEach(tks=>{const uniq=new Set(tks); uniq.forEach(t=>DF.set(t,(DF.get(t)||0)+1));});
    const IDF=new Map(); DF.forEach((df,t)=>IDF.set(t,Math.log((1+N)/(1+df))+1));
    const Vecs=Toks.map(tks=>{const tf=new Map(); tks.forEach(t=>tf.set(t,(tf.get(t)||0)+1));
      let sum=0; const v=new Map(); tf.forEach((f,t)=>{const w=f*(IDF.get(t)||0); v.set(t,w); sum+=w*w;});
      const norm=Math.sqrt(sum)||1; const nv=new Map(); v.forEach((w,t)=>nv.set(t,w/norm)); return nv;});
    return {docs,IDF,Vecs};
  }
  function vectorize(IDF,text){
    const tks=tokenize(text), tf=new Map(); tks.forEach(t=>tf.set(t,(tf.get(t)||0)+1));
    let sum=0; const v=new Map(); tf.forEach((f,t)=>{const w=f*(IDF.get(t)||0); v.set(t,w); sum+=w*w;});
    const norm=Math.sqrt(sum)||1; const nv=new Map(); v.forEach((w,t)=>nv.set(t,w/norm)); return nv;
  }
  function cosineScore(qv,dv){let s=0; qv.forEach((qw,t)=>{const dw=dv.get(t); if(dw) s+=qw*dw;}); return s;}
  function highlight(text,query){const words=Array.from(new Set(tokenize(query))).filter(w=>w.length>2);
    if(!words.length) return text; const pattern=new RegExp("("+words.map(w=>w.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")).join("|")+")","gi");
    return text.replace(pattern,'<mark>$1</mark>');}
  async function suggestFromLibrary(q){
    const corpus=(window.REBUTTALS||[]).map((r,i)=>({key:r.key||i,title:r.title||"",text:r.text||""}));
    if(!corpus.length) return []; const {IDF,Vecs,docs}=buildIndex(corpus); const qv=vectorize(IDF,q);
    const scored=Vecs.map((dv,i)=>({i,score:cosineScore(qv,dv)})).sort((a,b)=>b.score-a.score).slice(0,3);
    return scored.map(({i})=>{const d=docs[i];return `<div class="rebItem"><h4>${d.title} <span class="reb-badge badge-brand">Suggested</span></h4>
      <div class="scripttxt">${highlight(d.text,q).replace(/\n/g,'<br>')}</div>
      <div class="reb-actions"><button class="reb-copy" data-copy="__sugg_${i}">Copy</button></div>
      <div id="__sugg_${i}" style="display:none">${d.text}</div></div>`;}).join("");
  }
  if(btnSug){ btnSug.addEventListener('click', async()=>{const q=objInput.value.trim(); if(!q){smartOut.textContent="Type an objection.";return;}
    smartOut.textContent="Finding suggestions…"; try{const html=await suggestFromLibrary(q); smartOut.innerHTML=html||"<div>No matches.</div>";}
    catch(e){console.error(e); smartOut.textContent="Error in suggestion.";} });}

  // --- AI Draft ---
  async function aiDraft(objection){
    const context="Allstar Services: SFR only; 60-minute visit (30-min on-roof + review); Detroit excluded (do not disclose); no phone pricing; professional tone.";
    const r=await fetch(proxyURL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({objection,context})});
    if(!r.ok){throw new Error("Proxy error "+r.status);} const j=await r.json(); return (j.text||"").trim();
  }
  btnGen.addEventListener('click',async()=>{const q=objInput.value.trim(); if(!q){smartOut.textContent="Type an objection.";return;}
    smartOut.textContent="Drafting…"; try{const txt=await aiDraft(q);
      smartOut.innerHTML=`<div class="rebItem"><h4>AI Draft</h4><div class="scripttxt">${(txt||"").replace(/\n/g,'<br>')}</div>
      <div class="reb-actions"><button class="reb-copy" data-copy="__aidraft">Copy</button><button id="btnSaveAI">Save to Library</button></div>
      <div id="__aidraft" style="display:none">${txt||""}</div></div>`;
    }catch(err){console.error(err); smartOut.textContent="Error drafting AI rebuttal.";} });

  // --- Copy + Save handler ---
  smartOut.addEventListener('click',async e=>{
    const copyBtn=e.target.closest('button[data-copy]'); if(copyBtn){const id=copyBtn.getAttribute('data-copy');const el=document.getElementById(id);
      const txt=(el&&el.textContent)||""; if(navigator.clipboard) navigator.clipboard.writeText(txt); toastFM("Copied!"); return;}
    const saveBtn=e.target.closest('#btnSaveAI'); if(saveBtn){const txtEl=document.getElementById('__aidraft');const text=(txtEl&&txtEl.textContent)||"";
      if(!text){toastFM("Nothing to save.");return;} const title=prompt("Title:", "AI – "+(objInput.value||"Rebuttal")); if(!title) return;
      const cat=prompt("Category (finance, schedule, qualify, interest, policy, brand, escalate):","qualify")||"qualify";
      const key="ai_"+Date.now(); const rec={key,title,text}; window.REBUTTALS.push(rec); window.CATEGORY_MAP[key]=cat;
      try{if(typeof filterAndRender==='function') filterAndRender();}catch(e){} try{if(typeof renderSmsLists==='function') renderSmsLists();}catch(e){}
      toastFM("Saved to library."); if(REBUTTAL_LOG_WEBHOOK){try{await fetch(REBUTTAL_LOG_WEBHOOK,{method:"POST",headers:{"Content-Type":"text/plain"},
        body:JSON.stringify({source:"ai",key,title,category:cat,text,objection:objInput.value||"",ts:new Date().toISOString()})});}catch(e){}} }
  });
})();
</script>


<script>
// ====== Google Sheet autosync for REBUTTALS ======
// Requirements on Apps Script Web App (/exec):
// function doGet(e){ if (e.parameter.mode === 'list') { return ContentService.createTextOutput(JSON.stringify({ok:true, rows:[{title:'...', text:'...', category:'finance'}]})).setMimeType(ContentService.MimeType.JSON);} }
// doPost remains your logger.

(function(){
  const SHEET_API = REBUTTAL_LOG_WEBHOOK; // same /exec

  // Add a Refresh button into Rebuttals controls if present
  function ensureRefreshButton(){
    const bar = document.querySelector('#rebControls');
    if(!bar || bar.querySelector('#rebRefreshBtn')) return;
    const btn = document.createElement('button');
    btn.id = 'rebRefreshBtn';
    btn.className = 'copy';
    btn.textContent = '↻ Refresh from Sheet';
    btn.style.marginLeft = 'auto';
    btn.onclick = syncFromSheet;
    bar.appendChild(btn);
  }

  // Fetch latest rows
  async function fetchRows(){
    try{
      const url = SHEET_API + (SHEET_API.includes('?') ? '&' : '?') + 'mode=list';
      const res = await fetch(url, { method:'GET' });
      const text = await res.text();
      let data = {};
      try{ data = JSON.parse(text); }catch(e){ console.warn('Non-JSON from Sheet', text); return []; }
      if(!data || !data.ok) return [];
      return Array.isArray(data.rows) ? data.rows : [];
    }catch(e){
      console.error('fetchRows error', e);
      return [];
    }
  }

  function sanitizeKey(s){
    return ('row_'+Date.now()+'_'+(s||'')).toLowerCase().replace(/[^a-z0-9]+/g,'_').slice(0,40);
  }

  function normalizeRow(row){
    // Accept both {title,text,category} or with different caps
    const title = row.title || row.Title || row.name || '';
    const text  = row.text  || row.Text  || row.body || row.rebuttal || '';
    const category = (row.category || row.Category || '').toString().toLowerCase().trim() || 'qualify';
    if(!title || !text) return null;
    const key = row.key || sanitizeKey(title);
    return { key, title, text, _src:'sheet', _cat:category };
  }

  function badgeFor(cat){
    return {
      finance:'finance', schedule:'schedule', qualify:'qualify',
      interest:'interest', policy:'policy', brand:'brand', escalate:'escalate'
    }[cat] || 'qualify';
  }

  function mergeRows(rows){
    if(!window.REBUTTALS){ console.warn('REBUTTALS not found'); return; }
    const mapByTitle = new Map(window.REBUTTALS.map(r=>[r.title.toLowerCase().trim(), r]));
    const added = [];
    rows.forEach(r=>{
      const n = normalizeRow(r);
      if(!n) return;
      const exists = mapByTitle.has(n.title.toLowerCase().trim());
      if(!exists){
        // add to library
        window.REBUTTALS.push({ key:n.key, title:n.title, text:n.text });
        // map category
        if(window.CATEGORY_MAP){ window.CATEGORY_MAP[n.key] = n._cat; }
        added.push(n);
      }
    });
    if(added.length){
      // Re-render rebuttals list and SMS mirrors if those functions exist
      if(typeof filterAndRender === 'function'){ filterAndRender(); }
      if(typeof renderSmsLists === 'function'){ renderSmsLists(); }
      if(typeof toast === 'function'){ toast(`${added.length} new item(s) from Sheet`); }
    }else{
      if(typeof toast === 'function'){ toast('No new items from Sheet'); }
    }
  }

  async function syncFromSheet(){
    ensureRefreshButton();
    if(typeof toast === 'function'){ toast('Syncing from Sheet…'); }
    const rows = await fetchRows();
    mergeRows(rows);
  }

  // Expose for manual calls if needed
  window.syncRebuttalsFromSheet = syncFromSheet;

  // Install a MutationObserver to add the refresh button when the drawer opens
  const obs = new MutationObserver(()=> ensureRefreshButton());
  obs.observe(document.documentElement, {childList:true, subtree:true});

  // Initial delayed sync after page load
  window.addEventListener('load', ()=> setTimeout(syncFromSheet, 800));
})();
</script>

</body>
</html>
