<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Allstar Agent Adherence</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Production React UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <style>
    :root { --brand:#e11d48; --muted:#f8fafc; }
    body { background:#fff; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:1rem; padding:1rem; }
    .gridbar { height:20px; border-radius:8px; overflow:hidden; position:relative; background:#f3f4f6; }
    .seg { height:100%; display:inline-block; }
    .seg.diff::after { content:""; position:absolute; inset:0; background:rgba(239,68,68,0.35); }
    .rowlabel { font-size:.8rem; color:#6b7280; width:7rem; }
    .timeline-wrap { position:relative; }
    .nowline { position:absolute; top:-4px; bottom:-4px; width:2px; background:#111827; }
    .status-dot { width:10px; height:10px; border-radius:9999px; display:inline-block; margin-right:6px; }
    .scroll-area { max-height:260px; overflow:auto; }
    /* Status colors */
    .st-available { background:#10b981; }
    .st-bathroom  { background:#f59e0b; }
    .st-break     { background:#fbbf24; }
    .st-lunch     { background:#fb923c; }
    .st-training  { background:#a78bfa; }
    .st-meeting   { background:#60a5fa; }
    .st-offline   { background:#9ca3af; }
    .error-banner { position:fixed; inset:auto 0 0 0; background:#fee2e2; color:#991b1b; padding:10px 14px; font: 14px/1.4 ui-sans-serif,system-ui; border-top:1px solid #fecaca; z-index:9999; }
  </style>
</head>
<body class="min-h-screen">
  <div id="app"></div>
  <div id="error" style="display:none" class="error-banner"></div>

<script>
const API_BASE = "https://allstar-auth.ataymia.workers.dev"; // your Worker URL
const LOGO_DATA = ""; // optional base64 logo image; leave blank if not needed

// Global error catcher to avoid white screens
(function(){
  const box = document.getElementById('error');
  function show(msg){
    if(!box) return;
    box.style.display='block';
    box.innerText = '⚠️ ' + msg;
    console.error('[Allstar Error]', msg);
  }
  window.addEventListener('error', (e)=> show(e.message || 'Script error'));
  window.addEventListener('unhandledrejection', (e)=> show((e.reason && e.reason.message) || String(e.reason)));
})();

const e = React.createElement;
const { useState, useMemo, useEffect } = React;

const STATUSES = [
  { key:'available', label:'Available', color:'st-available' },
  { key:'bathroom',  label:'Bathroom',  color:'st-bathroom'  },
  { key:'break',     label:'Break',     color:'st-break'     },
  { key:'lunch',     label:'Lunch',     color:'st-lunch'     },
  { key:'training',  label:'Training',  color:'st-training'  },
  { key:'meeting',   label:'Meeting',   color:'st-meeting'   },
  { key:'offline',   label:'Offline',   color:'st-offline'   },
];

function classNames(...a){ return a.filter(Boolean).join(' '); }
function pad(n){ return String(n).padStart(2,'0'); }
function isoDate(d){ const dt=(d instanceof Date)?d:new Date(d); return dt.toISOString().slice(0,10); }
function toHM(m){ const h=Math.floor(m/60), mm=m%60; return pad(h)+':'+pad(mm); }
function fmtDur(mins){ if(mins<60) return mins+'m'; const h=Math.floor(mins/60), m=mins%60; return h+'h '+(m?m+'m':''); }
function fmtTS(ms){ const d=new Date(ms); return pad(d.getHours())+':'+pad(d.getMinutes())+':'+pad(d.getSeconds()); }
function statusByKey(k){ return STATUSES.find(s=>s.key===k) || { label:k, color:'st-offline' }; }

async function api(path, opts={}){
  try{
    const res = await fetch(API_BASE+path, { credentials:'include', ...opts });
    const ct = res.headers.get('content-type')||'';
    if (res.status===204) return null;
    if (ct.includes('application/json')) {
      const j = await res.json();
      if (!res.ok) { throw new Error(j && j.error ? j.error : 'HTTP '+res.status); }
      return j;
    } else {
      const t = await res.text();
      if (!res.ok) throw new Error('HTTP '+res.status+' '+t.slice(0,120));
      return t;
    }
  }catch(err){
    console.error('API error', path, err);
    throw err;
  }
}

async function login(username,password){ return api('/auth/login',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username,password}) }); }
async function logout(){ await api('/auth/logout',{ method:'POST' }); }
async function getMe(){ try{return await api('/me');}catch{return null;} }
async function listUsers(){ return await api('/users'); }
async function createUser(username,password,role){ return await api('/users',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username,password,role}) }); }
async function patchUser(id,patch){ return await api('/users/'+id,{ method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify(patch) }); }
async function deleteUserApi(id){ return await api('/users/'+id,{ method:'DELETE' }); }
async function getSchedule(user,date){ const q=new URLSearchParams({user,date}).toString(); return await api('/schedules?'+q); }
async function saveSchedule(user,date,blocks){ return await api('/schedules',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ username:user, date, blocks }) }); }
async function postEvent(status,ts){ return await api('/events',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(ts?{status,ts}:{status}) }); }
async function listEvents(user,from,to){ const q=new URLSearchParams({user,from,to}).toString(); return await api('/events?'+q); }

function Header({ user, onLogout }){
  return e('div',{ className:'w-full border-b bg-white/80 backdrop-blur sticky top-0 z-50' },
    e('div',{ className:'max-w-6xl mx-auto flex items-center gap-3 p-3' },
      LOGO_DATA ? e('img',{ src:LOGO_DATA, alt:'Allstar', className:'h-10 w-auto rounded' }) : null,
      e('div',{ className:'text-xl font-bold tracking-tight' },'Allstar Agent Adherence'),
      e('div',{ className:'ml-auto flex items-center gap-3 text-sm text-gray-700' },
        e('span',null, user ? (user.username+' · '+user.role) : 'Not signed in'),
        user && e('button',{ onClick:onLogout, className:'px-3 py-1 rounded border hover:bg-gray-50' },'Logout')
      )
    )
  );
}

function TimelineBars({ date, scheduleBlocks, events, tick }){
  const mins = scheduleBlocks.length ? [Math.min(...scheduleBlocks.map(b=>b.start)), Math.max(...scheduleBlocks.map(b=>b.end))] : [8*60,17*60];
  const [startMin,endMin] = mins;
  const total = endMin - startMin || 1;
  const dayStart = Date.parse(date+'T00:00:00');

  function blocksToSegments(blocks){ return blocks.map(b=>({ status:b.status, start:b.start, width:(b.end-b.start) })); }
  function eventsToSegments(events){
    const segs=[]; let curStatus = events.length ? events[0].status : null;
    const points = events.map(ev => Math.max(startMin, Math.min(endMin, Math.floor((Number(ev.ts) - dayStart)/60000))));
    let cursor = startMin;
    for(let i=0;i<points.length;i++){ const p=points[i]; if(p>cursor) segs.push({status:curStatus,start:cursor,width:p-cursor}); cursor=p; curStatus=events[i].status; }
    if(cursor<endMin) segs.push({status:curStatus,start:cursor,width:endMin-cursor});
    return segs;
  }

  const projSegs = blocksToSegments(scheduleBlocks);
  const actSegs = eventsToSegments(events||[]);

  function SegRow({ segs, compare }){
    return e('div',{ className:'gridbar relative' },
      segs.map((s,i)=>{
        let diff=false;
        if(compare){
          const probe = s.start + Math.max(1, Math.floor(s.width/2));
          const expected = scheduleBlocks.find(b => probe>=b.start && probe<b.end)?.status;
          diff = (expected && s.status && expected!==s.status);
        }
        const w = (s.width/total*100).toFixed(4)+'%';
        return e('div',{ key:i, className: classNames('seg relative', s.status?statusByKey(s.status).color:'' , compare && diff && 'diff'), style:{ width:w } });
      })
    );
  }

  const now = Date.now(); // 'tick' triggers re-render each second
  const nowMin = Math.floor((now - dayStart)/60000);
  const nowPct = Math.max(0, Math.min(100, ((nowMin-startMin)/total)*100));

  return e('div',{ className:'timeline-wrap' },
    e('div',{ className:'flex items-center gap-3 mb-1' },
      e('div',{ className:'rowlabel' },'Projected'),
      e('div',{ className:'flex-1' }, e(SegRow,{ segs:projSegs }))
    ),
    e('div',{ className:'flex items-center gap-3' },
      e('div',{ className:'rowlabel' },'Actual'),
      e('div',{ className:'flex-1' }, e(SegRow,{ segs:actSegs, compare:true }))
    ),
    e('div',{ className:'nowline', style:{ left: nowPct+'%' } })
  );
}

function UserPanel({ user }){
  const [tick, setTick] = useState(0);
  const [date] = useState(isoDate(new Date()));
  const [schedule, setSchedule] = useState([]);
  const [events, setEvents] = useState([]);

  async function refresh(){
    const s = await getSchedule(user.username, date); setSchedule((s && s.blocks)||[]);
    const ev = await listEvents(user.username, date, date); setEvents(Array.isArray(ev)?ev:[]);
  }
  useEffect(()=>{ refresh(); }, []);
  useEffect(()=>{ const t=setInterval(()=>setTick(v=>v+1), 1000); return ()=>clearInterval(t); }, []);
  useEffect(()=>{ const t=setInterval(refresh, 15000); return ()=>clearInterval(t); }, []);

  const { adherencePct, inM, outM } = useMemo(()=>{
    if(!schedule.length) return { adherencePct:100, inM:0, outM:0 };
    const dayStart = Date.parse(date+'T00:00:00');
    const startMin = Math.min(...schedule.map(b=>b.start));
    const endMin = Math.max(...schedule.map(b=>b.end));
    const nowMin = Math.min(Math.max(startMin, Math.floor((Date.now()-dayStart)/60000)), endMin);
    let inMin=0, outMin=0; let idx=0, cur = events.length?events[0].status:null;
    for(let m=startMin; m<nowMin; m++){
      const ms = dayStart + m*60000;
      while(idx+1<events.length && Number(events[idx+1].ts) <= ms){ idx++; cur = events[idx].status; }
      const expected = schedule.find(b=> m>=b.start && m<b.end)?.status;
      if(!expected) continue;
      if(!cur) outMin++; else if(cur===expected) inMin++; else outMin++;
    }
    const total = inMin+outMin;
    return { adherencePct: total? Math.round(inMin/total*100):100, inM:inMin, outM:outMin };
  }, [schedule, events, tick]);

  async function setStatus(status){
    const ev = { status, ts: Date.now() };
    setEvents(prev => [...prev, ev]);
    try{ await postEvent(status); }catch(e){}
  }

  const lastList = [...events].slice(-10).reverse();

  return e('div',{ className:'grid gap-4 md:grid-cols-2' },
    e('div',{ className:'card' },
      e('div',{ className:'flex items-center justify-between mb-3' },
        e('h2',{ className:'text-lg font-semibold' },'Today'),
        e('div',{ className:'text-sm text-gray-600' }, date)
      ),
      e('div',{ className:'mb-3' }, e(TimelineBars,{ date, scheduleBlocks:schedule, events, tick })),
      e('div',{ className:'flex items-center gap-4' },
        e('div',{ className:'text-4xl font-bold text-gray-900' }, adherencePct+'%'),
        e('div',{ className:'text-sm text-gray-600' }, `in: ${fmtDur(inM)} · out: ${fmtDur(outM)}`)
      )
    ),
    e('div',{ className:'card' },
      e('h3',{ className:'font-semibold mb-2' },'Set status'),
      e('div',{ className:'flex flex-wrap gap-2' },
        STATUSES.map(s => e('button',{
          key:s.key, onClick:()=>setStatus(s.key),
          className: classNames('px-3 py-2 rounded text-white', s.color)
        }, s.label))
      ),
      e('div',{ className:'mt-4' },
        e('h4',{ className:'font-medium mb-1' },'Recent switches'),
        e('div',{ className:'scroll-area text-sm' },
          lastList.map((ev,i)=> e('div',{ key:i, className:'py-1 border-b border-gray-100 flex items-center justify-between' },
            e('div',null, e('span',{ className:'status-dot '+statusByKey(ev.status).color }), ' ', statusByKey(ev.status).label),
            e('div',{ className:'text-gray-600' }, fmtTS(ev.ts))
          ))
        )
      )
    )
  );
}

function AdminPanel({ me }){
  const [users, setUsers] = useState([]);
  const [selectedUser, setSelectedUser] = useState('');
  const [day, setDay] = useState(isoDate(new Date()));
  const [blocks, setBlocks] = useState([]);
  const [events, setEvents] = useState([]);

  useEffect(()=>{ (async()=>{ try{ const u=await listUsers(); setUsers(u||[]); }catch(e){ console.warn('listUsers failed',e);} })() }, []);
  useEffect(()=>{ (async()=>{
    if(!selectedUser) return;
    try{
      const s=await getSchedule(selectedUser, day); setBlocks((s && s.blocks)||[]);
      const ev=await listEvents(selectedUser, day, day); setEvents(Array.isArray(ev)?ev:[]);
    }catch(e){ console.warn('sched/events failed',e); }
  })() }, [selectedUser, day]);

  function addBlock(){ setBlocks(prev=>[...prev,{ status:'available', start:8*60, end:9*60 }]); }
  function setBlk(i, patch){ setBlocks(prev=> prev.map((b,idx)=> idx===i? {...b,...patch}:b)); }
  function rmBlk(i){ setBlocks(prev=> prev.filter((_,idx)=> idx!==i)); }
  async function saveServer(){ try{ await saveSchedule(selectedUser, day, blocks); alert('Saved'); }catch(e){ alert('Save failed: '+e.message); } }
  function download(url,name){
    fetch(url,{ credentials:'include' }).then(r=>r.blob()).then(b=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=name; document.body.appendChild(a); a.click(); a.remove(); });
  }

  const detail = useMemo(()=>{
    if(!blocks.length) return { inMin:0, outMin:0, lines:[], byStatus:{} };
    const dayStart = Date.parse(day+'T00:00:00');
    const startMin = Math.min(...blocks.map(b=>b.start));
    const endMin = Math.max(...blocks.map(b=>b.end));
    let idx=0, cur = events.length?events[0].status:null, curStartMin = startMin;
    const lines=[]; const byStatus={};
    function pushLine(status, startM, endM){
      const startTS = dayStart + startM*60000;
      const durMin = Math.max(0, endM - startM);
      if(status){ lines.push(`${fmtTS(startTS)} ${statusByKey(status).label} ${fmtDur(durMin)}`); byStatus[status]=(byStatus[status]||0)+durMin; }
    }
    for(let m=startMin; m<=endMin; m++){
      const ms = dayStart + m*60000;
      if(idx+1<events.length && Number(events[idx+1].ts) <= ms){ pushLine(cur, curStartMin, m); idx++; cur=events[idx].status; curStartMin=m; }
    }
    pushLine(cur, curStartMin, endMin);

    let inMin=0,outMin=0; idx=0; cur = events.length?events[0].status:null;
    for(let m=startMin; m<endMin; m++){
      const ms = dayStart + m*60000;
      while(idx+1<events.length && Number(events[idx+1].ts) <= ms){ idx++; cur=events[idx].status; }
      const expected = blocks.find(b=> m>=b.start && m<b.end)?.status;
      if(!expected) continue;
      if(!cur) outMin++; else if(cur===expected) inMin++; else outMin++;
    }
    return { inMin, outMin, lines, byStatus };
  }, [blocks, events, day]);

  const total = detail.inMin + detail.outMin;
  const pct = total ? Math.round(detail.inMin/total*100) : 100;

  const now = new Date(day+'T00:00:00'); const y = now.getUTCFullYear(); const m = String(now.getUTCMonth()+1).padStart(2,'0');
  const monthStart = `${y}-${m}-01`; const monthEnd = new Date(Date.UTC(y, parseInt(m), 0)).toISOString().slice(0,10);

  return e('div',{ className:'card' },
    e('div',{ className:'flex flex-wrap gap-3 items-end mb-4' },
      e('div',null,
        e('label',{ className:'text-sm text-gray-600' },'Agent'),
        e('select',{ className:'block border rounded px-3 py-2 min-w-[12rem]', value:selectedUser, onChange:e=>setSelectedUser(e.target.value) },
          e('option',{ value:'' },'Pick a user'),
          users.map(u=> e('option',{ key:u.id, value:u.username }, u.username+' · '+u.role ))
        )
      ),
      e('div',null,
        e('label',{ className:'text-sm text-gray-600' },'Date'),
        e('input',{ type:'date', className:'block border rounded px-3 py-2', value:day, onChange:e=>setDay(e.target.value) })
      ),
      e('div',{ className:'ml-auto flex gap-2' },
        e('button',{ onClick:addBlock, className:'px-3 py-2 rounded bg-[var(--brand)] text-white hover:brightness-95' },'+ Block'),
        e('button',{ onClick:saveServer, disabled:!selectedUser, className:'px-3 py-2 rounded border border-[var(--brand)] text-[var(--brand)] hover:bg-rose-50 disabled:opacity-50' },'Save to Server')
      )
    ),
    e('div',{ className:'grid md:grid-cols-2 gap-4' },
      e('div',{ className:'card' },
        e('h3',{ className:'font-semibold mb-2' },'Schedule Blocks'),
        blocks.map((b,i)=> e('div',{ key:i, className:'flex items-center gap-2 mb-2' },
          e('select',{ className:'border rounded px-2 py-1', value:b.status, onChange:e=>setBlk(i,{status:e.target.value}) },
            STATUSES.map(s=> e('option',{ key:s.key, value:s.key }, s.label ))
          ),
          e('input',{ type:'time', className:'border rounded px-2 py-1', value:toHM(b.start), onChange:e=>setBlk(i,{start:(parseInt(e.target.value.slice(0,2))*60 + parseInt(e.target.value.slice(3,5)))}) }),
          e('span',null,'to'),
          e('input',{ type:'time', className:'border rounded px-2 py-1', value:toHM(b.end), onChange:e=>setBlk(i,{end:(parseInt(e.target.value.slice(0,2))*60 + parseInt(e.target.value.slice(3,5)))}) }),
          e('button',{ onClick:()=>rmBlk(i), className:'ml-auto text-sm px-2 py-1 rounded border hover:bg-gray-50' },'Remove')
        ))
      ),
      e('div',{ className:'card' },
        e('h3',{ className:'font-semibold mb-2' },'Daily Overview'),
        e(TimelineBars,{ date:day, scheduleBlocks:blocks, events }),
        e('div',{ className:'mt-3 text-sm text-gray-700' }, `Adherence: ${pct}%  · in ${fmtDur(detail.inMin)} / out ${fmtDur(detail.outMin)}`),
        e('div',{ className:'mt-3' },
          e('h4',{ className:'font-medium' },'AUX breakdown (durations)'),
          e('ul',{ className:'list-disc pl-6 text-sm text-gray-700' },
            Object.keys(detail.byStatus).map(k=> e('li',{ key:k }, statusByKey(k).label+': '+fmtDur(detail.byStatus[k])) )
          )
        ),
        e('div',{ className:'mt-3' },
          e('h4',{ className:'font-medium' },'Timeline (IMED style)'),
          e('div',{ className:'scroll-area text-sm text-gray-800 border rounded p-2 bg-white' },
            (detail.lines.length? detail.lines : ['No events for this day']).map((t,i)=> e('div',{ key:i, className:'border-b last:border-0 py-1' }, t))
          )
        )
      )
    ),

    e('div',{ className:'card mt-4' },
      e('h3',{ className:'font-semibold mb-2' },'Users'),
      e(UsersCard,{ onChange: async()=>{ try{ const u=await listUsers(); setUsers(u||[]); }catch(e){} } })
    ),

    e('div',{ className:'mt-4 flex flex-wrap gap-2' },
      e('button',{ className:'px-3 py-1.5 rounded border hover:bg-gray-50', onClick:()=>download(`${API_BASE}/export/events?from=${monthStart}&to=${monthEnd}`, `events_${y}${m}.csv`) },'Download Events (month)'),
      e('button',{ className:'px-3 py-1.5 rounded border hover:bg-gray-50', onClick:()=>download(`${API_BASE}/export/schedules?from=${monthStart}&to=${monthEnd}`, `schedules_${y}${m}.csv`) },'Download Schedules (month)'),
      e('button',{ className:'px-3 py-1.5 rounded border hover:bg-gray-50', onClick:()=>download(`${API_BASE}/export/adherence?from=${monthStart}&to=${monthEnd}`, `adherence_${y}${m}.csv`) },'Download Adherence (month)')
    )
  );
}

function UsersCard({ onChange }){
  const [users, setUsers] = useState([]);
  const [uname, setUname] = useState('');
  const [pwd, setPwd] = useState('Welcome123');
  const [role, setRole] = useState('AGENT');
  useEffect(()=>{ (async()=>{ try{ const u=await listUsers(); setUsers(u||[]); }catch(e){ console.warn('listUsers failed',e); } })() }, []);

  async function create(){
    if(!uname || !pwd){ alert('Enter username and password'); return; }
    try{
      const res = await createUser(uname, pwd, role);
      if(res && res.username){ setUname(''); setPwd('Welcome123'); setRole('AGENT'); const u=await listUsers(); setUsers(u||[]); onChange && onChange(); }
      else alert('Create failed (maybe username exists)');
    }catch(e){ alert('Create failed: '+e.message); }
  }
  async function del(id){
    if(!confirm('Delete this user?')) return;
    try{
      const r = await deleteUserApi(id);
      if(r===null){ const u=await listUsers(); setUsers(u||[]); onChange && onChange(); } else alert('Delete failed');
    }catch(e){ alert('Delete failed: '+e.message); }
  }
  async function toggleForce(id, cur){
    try{
      const res = await patchUser(id, { mustChangePassword: !cur });
      if(res && res.id){ const u=await listUsers(); setUsers(u||[]); } else alert('Update failed');
    }catch(e){ alert('Update failed: '+e.message); }
  }

  return e('div',null,
    e('div',{ className:'flex flex-wrap gap-2 items-end mb-3' },
      e('input',{ className:'border rounded px-3 py-2', placeholder:'Username', value:uname, onChange:e=>setUname(e.target.value) }),
      e('input',{ type:'password', className:'border rounded px-3 py-2', placeholder:'Temp password', value:pwd, onChange:e=>setPwd(e.target.value) }),
      e('select',{ className:'border rounded px-3 py-2', value:role, onChange:e=>setRole(e.target.value) },
        e('option',{ value:'AGENT' },'AGENT'),
        e('option',{ value:'ADMIN' },'ADMIN')
      ),
      e('button',{ onClick:create, className:'px-3 py-2 rounded bg-[var(--brand)] text-white hover:brightness-95' },'Create')
    ),
    e('div',{ className:'overflow-auto' },
      e('table',{ className:'min-w-full text-sm' },
        e('thead',null,
          e('tr',{ className:'text-left text-gray-600' },
            e('th',{ className:'py-2 pr-4' },'Username'),
            e('th',{ className:'py-2 pr-4' },'Role'),
            e('th',{ className:'py-2 pr-4' },'Force Reset'),
            e('th',{ className:'py-2 pr-4' })
          )
        ),
        e('tbody',null,
          users.map(u=> e('tr',{ key:u.id, className:'border-t' },
            e('td',{ className:'py-2 pr-4' }, u.username),
            e('td',{ className:'py-2 pr-4' }, u.role),
            e('td',{ className:'py-2 pr-4' },
              e('label',{ className:'inline-flex items-center gap-2' },
                e('input',{ type:'checkbox', checked:!!u.must_change_password, onChange:()=>toggleForce(u.id, !!u.must_change_password) }),
                e('span',null,'must change on next login')
              )
            ),
            e('td',{ className:'py-2 pr-4 text-right' },
              e('button',{ onClick:()=>del(u.id), className:'px-2 py-1 rounded border hover:bg-gray-50' },'Delete')
            )
          ))
        )
      )
    )
  );
}

function AuthGate(){
  const [me, setMe] = useState(null);
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState('');
  const [u, setU] = useState('Ataymia');
  const [p, setP] = useState('Ataymia10');

  useEffect(()=>{ (async()=>{ const m=await getMe(); if(m && m.username) setMe(m); setLoading(false); })() }, []);

  async function doLogin(evn){
    evn.preventDefault(); setErr('');
    try{
      const res=await login(u,p);
      if(!res || !res.username){ setErr('Login failed'); return; }
      const m=await getMe(); setMe(m);
    } catch(e){ setErr('Login failed: '+e.message); }
  }
  async function doLogout(){ await logout(); setMe(null); }

  if(!me){
    return e('div',{ className:'max-w-md mx-auto mt-20 card' },
      e('div',{ className:'flex items-center gap-3 mb-4' },
        LOGO_DATA ? e('img',{ src:LOGO_DATA, className:'h-10 w-auto rounded' }) : null,
        e('div',{ className:'text-xl font-semibold' },'Sign in to Allstar Agent Adherence')
      ),
      err && e('div',{ className:'text-sm text-red-600 mb-2' }, err),
      e('form',{ onSubmit:doLogin, className:'grid gap-3' },
        e('input',{ className:'border rounded px-3 py-2', placeholder:'Username', value:u, onChange:e=>setU(e.target.value) }),
        e('input',{ type:'password', className:'border rounded px-3 py-2', placeholder:'Password', value:p, onChange:e=>setP(e.target.value) }),
        e('button',{ className:'px-3 py-2 rounded bg-[var(--brand)] text-white hover:brightness-95' },'Login')
      )
    );
  }

  return e('div',null,
    e(Header,{ user:me, onLogout:doLogout }),
    e('main',{ className:'max-w-6xl mx-auto p-4 grid gap-4' },
      me.role==='AGENT' ? e(UserPanel,{ user:me }) :
      e('div',{ className:'grid gap-4' },
        e(UserPanel,{ user:me }),
        e(AdminPanel,{ me })
      )
    )
  );
}

// Mount
ReactDOM.createRoot(document.getElementById('app')).render(e(AuthGate));
</script>
</body>
</html>
